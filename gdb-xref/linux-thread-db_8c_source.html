<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>GDB (xrefs): /home/stan/gdb/src/gdb/linux-thread-db.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">GDB (xrefs)
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">/home/stan/gdb/src/gdb/linux-thread-db.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="linux-thread-db_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* libthread_db assisted debugging support, generic parts.</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">   Copyright (C) 1999-2013 Free Software Foundation, Inc.</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">   This file is part of GDB.</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">   This program is free software; you can redistribute it and/or modify</span>
<a name="l00008"></a>00008 <span class="comment">   it under the terms of the GNU General Public License as published by</span>
<a name="l00009"></a>00009 <span class="comment">   the Free Software Foundation; either version 3 of the License, or</span>
<a name="l00010"></a>00010 <span class="comment">   (at your option) any later version.</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">   This program is distributed in the hope that it will be useful,</span>
<a name="l00013"></a>00013 <span class="comment">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00014"></a>00014 <span class="comment">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00015"></a>00015 <span class="comment">   GNU General Public License for more details.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">   You should have received a copy of the GNU General Public License</span>
<a name="l00018"></a>00018 <span class="comment">   along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.  */</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="defs_8h.html">defs.h</a>&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="gdb__assert_8h.html">gdb_assert.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;dlfcn.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="gdb__proc__service_8h.html">gdb_proc_service.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="gdb__thread__db_8h.html">gdb_thread_db.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="gdb__vecs_8h.html">gdb_vecs.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;bfd.h&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="command_8h.html">command.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="exceptions_8h.html">exceptions.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="gdbcmd_8h.html">gdbcmd.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="gdbthread_8h.html">gdbthread.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="inferior_8h.html">inferior.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="symfile_8h.html">symfile.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="objfiles_8h.html">objfiles.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="target_8h.html">target.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="regcache_8h.html">regcache.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="solib_8h.html">solib.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="solib-svr4_8h.html">solib-svr4.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="gdbcore_8h.html">gdbcore.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="observer_8h.html">observer.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="linux-nat_8h.html">linux-nat.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="linux-procfs_8h.html">linux-procfs.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="linux-osdata_8h.html">linux-osdata.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="auto-load_8h.html">auto-load.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="cli-utils_8h.html">cli/cli-utils.h</a>&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">/* GNU/Linux libthread_db support.</span>
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a>00052 <span class="comment">   libthread_db is a library, provided along with libpthread.so, which</span>
<a name="l00053"></a>00053 <span class="comment">   exposes the internals of the thread library to a debugger.  It</span>
<a name="l00054"></a>00054 <span class="comment">   allows GDB to find existing threads, new threads as they are</span>
<a name="l00055"></a>00055 <span class="comment">   created, thread IDs (usually, the result of pthread_self), and</span>
<a name="l00056"></a>00056 <span class="comment">   thread-local variables.</span>
<a name="l00057"></a>00057 <span class="comment"></span>
<a name="l00058"></a>00058 <span class="comment">   The libthread_db interface originates on Solaris, where it is</span>
<a name="l00059"></a>00059 <span class="comment">   both more powerful and more complicated.  This implementation</span>
<a name="l00060"></a>00060 <span class="comment">   only works for LinuxThreads and NPTL, the two glibc threading</span>
<a name="l00061"></a>00061 <span class="comment">   libraries.  It assumes that each thread is permanently assigned</span>
<a name="l00062"></a>00062 <span class="comment">   to a single light-weight process (LWP).</span>
<a name="l00063"></a>00063 <span class="comment"></span>
<a name="l00064"></a>00064 <span class="comment">   libthread_db-specific information is stored in the &quot;private&quot; field</span>
<a name="l00065"></a>00065 <span class="comment">   of struct thread_info.  When the field is NULL we do not yet have</span>
<a name="l00066"></a>00066 <span class="comment">   information about the new thread; this could be temporary (created,</span>
<a name="l00067"></a>00067 <span class="comment">   but the thread library&#39;s data structures do not reflect it yet)</span>
<a name="l00068"></a>00068 <span class="comment">   or permanent (created using clone instead of pthread_create).</span>
<a name="l00069"></a>00069 <span class="comment"></span>
<a name="l00070"></a>00070 <span class="comment">   Process IDs managed by linux-thread-db.c match those used by</span>
<a name="l00071"></a>00071 <span class="comment">   linux-nat.c: a common PID for all processes, an LWP ID for each</span>
<a name="l00072"></a>00072 <span class="comment">   thread, and no TID.  We save the TID in private.  Keeping it out</span>
<a name="l00073"></a>00073 <span class="comment">   of the ptid_t prevents thread IDs changing when libpthread is</span>
<a name="l00074"></a>00074 <span class="comment">   loaded or unloaded.  */</span>
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="linux-thread-db_8c.html#a2054e81dcf1628d1199ed276e291b4cb">00076</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="linux-thread-db_8c.html#a2054e81dcf1628d1199ed276e291b4cb">libthread_db_search_path</a>;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="comment">/* Set to non-zero if thread_db auto-loading is enabled</span>
<a name="l00079"></a>00079 <span class="comment">   by the &quot;set auto-load libthread-db&quot; command.  */</span>
<a name="l00080"></a><a class="code" href="linux-thread-db_8c.html#a01cc116c4ab0d79fcc2f0900819c4319">00080</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="linux-thread-db_8c.html#a01cc116c4ab0d79fcc2f0900819c4319">auto_load_thread_db</a> = 1;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="comment">/* &quot;show&quot; command for the auto_load_thread_db configuration variable.  */</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00085"></a><a class="code" href="linux-thread-db_8c.html#af982309d62395df16c7484b1ac399590">00085</a> <a class="code" href="linux-thread-db_8c.html#af982309d62395df16c7484b1ac399590">show_auto_load_thread_db</a> (<span class="keyword">struct</span> <a class="code" href="structui__file.html">ui_file</a> *file, <span class="keywordtype">int</span> from_tty,
<a name="l00086"></a>00086                           <span class="keyword">struct</span> <a class="code" href="structcmd__list__element.html">cmd_list_element</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structvalue.html">value</a>)
<a name="l00087"></a>00087 {
<a name="l00088"></a>00088   <a class="code" href="utils_8c.html#aaa819b1a6c0b6c4090bdc0b027eaf64b">fprintf_filtered</a> (file, <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Auto-loading of inferior specific libthread_db &quot;</span>
<a name="l00089"></a>00089                             <span class="stringliteral">&quot;is %s.\n&quot;</span>),
<a name="l00090"></a>00090                     value);
<a name="l00091"></a>00091 }
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00094"></a><a class="code" href="linux-thread-db_8c.html#af6c494da587c736414abc7819366659e">00094</a> <a class="code" href="linux-thread-db_8c.html#af6c494da587c736414abc7819366659e">set_libthread_db_search_path</a> (<span class="keywordtype">char</span> *ignored, <span class="keywordtype">int</span> from_tty,
<a name="l00095"></a>00095                               <span class="keyword">struct</span> <a class="code" href="structcmd__list__element.html">cmd_list_element</a> *c)
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097   <span class="keywordflow">if</span> (*<a class="code" href="linux-thread-db_8c.html#a2054e81dcf1628d1199ed276e291b4cb">libthread_db_search_path</a> == <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00098"></a>00098     {
<a name="l00099"></a>00099       <a class="code" href="common-utils_8c.html#a976e14808b9247ec952c262553f09f8f">xfree</a> (<a class="code" href="linux-thread-db_8c.html#a2054e81dcf1628d1199ed276e291b4cb">libthread_db_search_path</a>);
<a name="l00100"></a>00100       <a class="code" href="linux-thread-db_8c.html#a2054e81dcf1628d1199ed276e291b4cb">libthread_db_search_path</a> = xstrdup (<a class="code" href="gdb__thread__db_8h.html#a2f881f10c445a50c74e970b45055f899">LIBTHREAD_DB_SEARCH_PATH</a>);
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <span class="comment">/* If non-zero, print details of libthread_db processing.  */</span>
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">00106</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">libthread_db_debug</a>;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00109"></a><a class="code" href="linux-thread-db_8c.html#a650f2a8a5e8053bd5c943954a1b4a67c">00109</a> <a class="code" href="linux-thread-db_8c.html#a650f2a8a5e8053bd5c943954a1b4a67c">show_libthread_db_debug</a> (<span class="keyword">struct</span> <a class="code" href="structui__file.html">ui_file</a> *file, <span class="keywordtype">int</span> from_tty,
<a name="l00110"></a>00110                          <span class="keyword">struct</span> <a class="code" href="structcmd__list__element.html">cmd_list_element</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structvalue.html">value</a>)
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112   <a class="code" href="utils_8c.html#aaa819b1a6c0b6c4090bdc0b027eaf64b">fprintf_filtered</a> (file, <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;libthread-db debugging is %s.\n&quot;</span>), value);
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="comment">/* If we&#39;re running on GNU/Linux, we must explicitly attach to any new</span>
<a name="l00116"></a>00116 <span class="comment">   threads.  */</span>
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <span class="comment">/* This module&#39;s target vector.  */</span>
<a name="l00119"></a><a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">00119</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structtarget__ops.html">target_ops</a> <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="comment">/* Non-zero if we have determined the signals used by the threads</span>
<a name="l00122"></a>00122 <span class="comment">   library.  */</span>
<a name="l00123"></a><a class="code" href="linux-thread-db_8c.html#a54b9746bb61464735407c2afd2d3fffe">00123</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="linux-thread-db_8c.html#a54b9746bb61464735407c2afd2d3fffe">thread_signals</a>;
<a name="l00124"></a><a class="code" href="linux-thread-db_8c.html#a314cf2c3e450a2a0775f9845ed0fabb3">00124</a> <span class="keyword">static</span> sigset_t <a class="code" href="linux-thread-db_8c.html#a314cf2c3e450a2a0775f9845ed0fabb3">thread_stop_set</a>;
<a name="l00125"></a><a class="code" href="linux-thread-db_8c.html#a1810f40c2a07c86bf5dde284aa4ed048">00125</a> <span class="keyword">static</span> sigset_t <a class="code" href="linux-thread-db_8c.html#a1810f40c2a07c86bf5dde284aa4ed048">thread_print_set</a>;
<a name="l00126"></a>00126 
<a name="l00127"></a><a class="code" href="structthread__db__info.html">00127</a> <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a>
<a name="l00128"></a>00128 {
<a name="l00129"></a><a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">00129</a>   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *<a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">next</a>;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131   <span class="comment">/* Process id this object refers to.  */</span>
<a name="l00132"></a><a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">00132</a>   <span class="keywordtype">int</span> <a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a>;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   <span class="comment">/* Handle from dlopen for libthread_db.so.  */</span>
<a name="l00135"></a><a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">00135</a>   <span class="keywordtype">void</span> *<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137   <span class="comment">/* Absolute pathname from gdb_realpath to disk file used for dlopen-ing</span>
<a name="l00138"></a>00138 <span class="comment">     HANDLE.  It may be NULL for system library.  */</span>
<a name="l00139"></a><a class="code" href="structthread__db__info.html#a4b3b75faab6aa86dc5a525ae3c913d53">00139</a>   <span class="keywordtype">char</span> *<a class="code" href="structthread__db__info.html#a4b3b75faab6aa86dc5a525ae3c913d53">filename</a>;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141   <span class="comment">/* Structure that identifies the child process for the</span>
<a name="l00142"></a>00142 <span class="comment">     &lt;proc_service.h&gt; interface.  */</span>
<a name="l00143"></a><a class="code" href="structthread__db__info.html#a35554ecef70a2233685706acde969f25">00143</a>   <span class="keyword">struct </span><a class="code" href="structps__prochandle.html">ps_prochandle</a> <a class="code" href="structthread__db__info.html#a35554ecef70a2233685706acde969f25">proc_handle</a>;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145   <span class="comment">/* Connection to the libthread_db library.  */</span>
<a name="l00146"></a><a class="code" href="structthread__db__info.html#a9be1d106fa5bde24113c74810bf47324">00146</a>   <a class="code" href="glibc__thread__db_8h.html#a851f228594aa5e5537c2e91657a15a8f">td_thragent_t</a> *<a class="code" href="structthread__db__info.html#a9be1d106fa5bde24113c74810bf47324">thread_agent</a>;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148   <span class="comment">/* True if we need to apply the workaround for glibc/BZ5983.  When</span>
<a name="l00149"></a>00149 <span class="comment">     we catch a PTRACE_O_TRACEFORK, and go query the child&#39;s thread</span>
<a name="l00150"></a>00150 <span class="comment">     list, nptl_db returns the parent&#39;s threads in addition to the new</span>
<a name="l00151"></a>00151 <span class="comment">     (single) child thread.  If this flag is set, we do extra work to</span>
<a name="l00152"></a>00152 <span class="comment">     be able to ignore such stale entries.  */</span>
<a name="l00153"></a><a class="code" href="structthread__db__info.html#ababfe4c4610a15619f1837848d22df07">00153</a>   <span class="keywordtype">int</span> <a class="code" href="structthread__db__info.html#ababfe4c4610a15619f1837848d22df07">need_stale_parent_threads_check</a>;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155   <span class="comment">/* Location of the thread creation event breakpoint.  The code at</span>
<a name="l00156"></a>00156 <span class="comment">     this location in the child process will be called by the pthread</span>
<a name="l00157"></a>00157 <span class="comment">     library whenever a new thread is created.  By setting a special</span>
<a name="l00158"></a>00158 <span class="comment">     breakpoint at this location, GDB can detect when a new thread is</span>
<a name="l00159"></a>00159 <span class="comment">     created.  We obtain this location via the td_ta_event_addr</span>
<a name="l00160"></a>00160 <span class="comment">     call.  */</span>
<a name="l00161"></a><a class="code" href="structthread__db__info.html#a20fc4977322c8f3c080e5d7b4c2d6a94">00161</a>   <a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a> <a class="code" href="structthread__db__info.html#a20fc4977322c8f3c080e5d7b4c2d6a94">td_create_bp_addr</a>;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163   <span class="comment">/* Location of the thread death event breakpoint.  */</span>
<a name="l00164"></a><a class="code" href="structthread__db__info.html#a68dd60e8331b9ba6c935e294944024d9">00164</a>   <a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a> <a class="code" href="structthread__db__info.html#a68dd60e8331b9ba6c935e294944024d9">td_death_bp_addr</a>;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166   <span class="comment">/* Pointers to the libthread_db functions.  */</span>
<a name="l00167"></a>00167 
<a name="l00168"></a><a class="code" href="structthread__db__info.html#a9b642e7507877ebf6ceed47cef1f8ab5">00168</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#a9b642e7507877ebf6ceed47cef1f8ab5">td_init_p</a>) (void);
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="structthread__db__info.html#a631b014b2215b6784a65df041f588255">00170</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#a631b014b2215b6784a65df041f588255">td_ta_new_p</a>) (<span class="keyword">struct </span><a class="code" href="structps__prochandle.html">ps_prochandle</a> * <a class="code" href="namespacecleanup__check.html#a2f9ce522b7667bef19a5777d12fa44d8">ps</a>,
<a name="l00171"></a>00171                                 <a class="code" href="glibc__thread__db_8h.html#a851f228594aa5e5537c2e91657a15a8f">td_thragent_t</a> **ta);
<a name="l00172"></a><a class="code" href="structthread__db__info.html#ab4a7d294a2360b847757d738debd97f3">00172</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#ab4a7d294a2360b847757d738debd97f3">td_ta_map_id2thr_p</a>) (<span class="keyword">const</span> <a class="code" href="glibc__thread__db_8h.html#a851f228594aa5e5537c2e91657a15a8f">td_thragent_t</a> *ta, <a class="code" href="glibc__thread__db_8h.html#aa406fd87cfd69d7c0a93b6a241978712">thread_t</a> pt,
<a name="l00173"></a>00173                                   <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> *__th);
<a name="l00174"></a><a class="code" href="structthread__db__info.html#a152d1cf5158bfed758f0b4c95f1be4cf">00174</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#a152d1cf5158bfed758f0b4c95f1be4cf">td_ta_map_lwp2thr_p</a>) (<span class="keyword">const</span> <a class="code" href="glibc__thread__db_8h.html#a851f228594aa5e5537c2e91657a15a8f">td_thragent_t</a> *ta,
<a name="l00175"></a>00175                                    <a class="code" href="gdb__proc__service_8h.html#ae0e8cfc4f21539a5c5b572c239bb8112">lwpid_t</a> lwpid, <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> *th);
<a name="l00176"></a><a class="code" href="structthread__db__info.html#a9edb87203f74a223a1080e449bf43f62">00176</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#a9edb87203f74a223a1080e449bf43f62">td_ta_thr_iter_p</a>) (<span class="keyword">const</span> <a class="code" href="glibc__thread__db_8h.html#a851f228594aa5e5537c2e91657a15a8f">td_thragent_t</a> *ta,
<a name="l00177"></a>00177                                 <a class="code" href="glibc__thread__db_8h.html#a3a733eebfdfaf16591cdf4986b13f530">td_thr_iter_f</a> *callback, <span class="keywordtype">void</span> *cbdata_p,
<a name="l00178"></a>00178                                 <a class="code" href="glibc__thread__db_8h.html#a7e015b84265c7d3667103553d8230d8e">td_thr_state_e</a> state, <span class="keywordtype">int</span> ti_pri,
<a name="l00179"></a>00179                                 sigset_t *ti_sigmask_p,
<a name="l00180"></a>00180                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ti_user_flags);
<a name="l00181"></a><a class="code" href="structthread__db__info.html#ad79f996f977dc0dd57a8dc5eb55eeccc">00181</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#ad79f996f977dc0dd57a8dc5eb55eeccc">td_ta_event_addr_p</a>) (<span class="keyword">const</span> <a class="code" href="glibc__thread__db_8h.html#a851f228594aa5e5537c2e91657a15a8f">td_thragent_t</a> *ta,
<a name="l00182"></a>00182                                   <a class="code" href="glibc__thread__db_8h.html#ae1a250281b93679f2616df2bbcba40e0">td_event_e</a> event, <a class="code" href="structtd__notify.html">td_notify_t</a> *ptr);
<a name="l00183"></a><a class="code" href="structthread__db__info.html#ac9cfa2d72dcdbfbf699a591631a01697">00183</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#ac9cfa2d72dcdbfbf699a591631a01697">td_ta_set_event_p</a>) (<span class="keyword">const</span> <a class="code" href="glibc__thread__db_8h.html#a851f228594aa5e5537c2e91657a15a8f">td_thragent_t</a> *ta,
<a name="l00184"></a>00184                                  <a class="code" href="structtd__thr__events.html">td_thr_events_t</a> *event);
<a name="l00185"></a><a class="code" href="structthread__db__info.html#a812acaf3efe66f429383f91a243b2d01">00185</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#a812acaf3efe66f429383f91a243b2d01">td_ta_clear_event_p</a>) (<span class="keyword">const</span> <a class="code" href="glibc__thread__db_8h.html#a851f228594aa5e5537c2e91657a15a8f">td_thragent_t</a> *ta,
<a name="l00186"></a>00186                                    <a class="code" href="structtd__thr__events.html">td_thr_events_t</a> *event);
<a name="l00187"></a><a class="code" href="structthread__db__info.html#aa8b076c6af5ed7412b77fdb540a2b954">00187</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#aa8b076c6af5ed7412b77fdb540a2b954">td_ta_event_getmsg_p</a>) (<span class="keyword">const</span> <a class="code" href="glibc__thread__db_8h.html#a851f228594aa5e5537c2e91657a15a8f">td_thragent_t</a> *ta,
<a name="l00188"></a>00188                                     <a class="code" href="structtd__event__msg.html">td_event_msg_t</a> *msg);
<a name="l00189"></a>00189 
<a name="l00190"></a><a class="code" href="structthread__db__info.html#aceb189dfa6dde0481dcf2369a933c123">00190</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#aceb189dfa6dde0481dcf2369a933c123">td_thr_validate_p</a>) (<span class="keyword">const</span> <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> *th);
<a name="l00191"></a><a class="code" href="structthread__db__info.html#a067c8611bf9c894d3691f7cb7bbefdcc">00191</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#a067c8611bf9c894d3691f7cb7bbefdcc">td_thr_get_info_p</a>) (<span class="keyword">const</span> <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> *th,
<a name="l00192"></a>00192                                  <a class="code" href="structtd__thrinfo.html">td_thrinfo_t</a> *infop);
<a name="l00193"></a><a class="code" href="structthread__db__info.html#a33e247512f4590ab36ac442ed3a4c9f3">00193</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#a33e247512f4590ab36ac442ed3a4c9f3">td_thr_event_enable_p</a>) (<span class="keyword">const</span> <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> *th,
<a name="l00194"></a>00194                                      <span class="keywordtype">int</span> event);
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="structthread__db__info.html#ac620454d19987cf45f202b3663bb2e3a">00196</a>   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> (*<a class="code" href="structthread__db__info.html#ac620454d19987cf45f202b3663bb2e3a">td_thr_tls_get_addr_p</a>) (<span class="keyword">const</span> <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> *th,
<a name="l00197"></a>00197                                      <a class="code" href="gdb__proc__service_8h.html#ad65a744093c157125797432097349eed">psaddr_t</a> map_address,
<a name="l00198"></a>00198                                      <span class="keywordtype">size_t</span> <a class="code" href="common_2agent_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a>, <a class="code" href="gdb__proc__service_8h.html#ad65a744093c157125797432097349eed">psaddr_t</a> *address);
<a name="l00199"></a>00199 };
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="comment">/* List of known processes using thread_db, and the required</span>
<a name="l00202"></a>00202 <span class="comment">   bookkeeping.  */</span>
<a name="l00203"></a><a class="code" href="linux-thread-db_8c.html#acd21817ca3c267ac0af5c1e75bf74ea0">00203</a> <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *<a class="code" href="linux-thread-db_8c.html#acd21817ca3c267ac0af5c1e75bf74ea0">thread_db_list</a>;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="linux-thread-db_8c.html#a8748de14af79f07c6a5737302e476e1f">thread_db_find_new_threads_1</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>);
<a name="l00206"></a>00206 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="linux-thread-db_8c.html#a0b2931755e813dbd72852f11a1fe7d78">thread_db_find_new_threads_2</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>, <span class="keywordtype">int</span> until_no_new);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="comment">/* Add the current inferior to the list of processes using libpthread.</span>
<a name="l00209"></a>00209 <span class="comment">   Return a pointer to the newly allocated object that was added to</span>
<a name="l00210"></a>00210 <span class="comment">   THREAD_DB_LIST.  HANDLE is the handle returned by dlopen&#39;ing</span>
<a name="l00211"></a>00211 <span class="comment">   LIBTHREAD_DB_SO.  */</span>
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *
<a name="l00214"></a><a class="code" href="linux-thread-db_8c.html#a70dbfa396e4111ef8d19eb9351ab5273">00214</a> <a class="code" href="linux-thread-db_8c.html#a70dbfa396e4111ef8d19eb9351ab5273">add_thread_db_info</a> (<span class="keywordtype">void</span> *<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>)
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   info = <a class="code" href="common-utils_8c.html#a05a0a3435b91a07d6cc1a0b4c8788a4d">xcalloc</a> (1, <span class="keyword">sizeof</span> (*info));
<a name="l00219"></a>00219   info-&gt;<a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a> = <a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>);
<a name="l00220"></a>00220   info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a> = <a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222   <span class="comment">/* The workaround works by reading from /proc/pid/status, so it is</span>
<a name="l00223"></a>00223 <span class="comment">     disabled for core files.  */</span>
<a name="l00224"></a>00224   <span class="keywordflow">if</span> (<a class="code" href="target_8h.html#a85885df22f7c1304269eaba1e1d618b7">target_has_execution</a>)
<a name="l00225"></a>00225     info-&gt;<a class="code" href="structthread__db__info.html#ababfe4c4610a15619f1837848d22df07">need_stale_parent_threads_check</a> = 1;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227   info-&gt;<a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">next</a> = <a class="code" href="linux-thread-db_8c.html#acd21817ca3c267ac0af5c1e75bf74ea0">thread_db_list</a>;
<a name="l00228"></a>00228   thread_db_list = info;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230   <span class="keywordflow">return</span> info;
<a name="l00231"></a>00231 }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="comment">/* Return the thread_db_info object representing the bookkeeping</span>
<a name="l00234"></a>00234 <span class="comment">   related to process PID, if any; NULL otherwise.  */</span>
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *
<a name="l00237"></a><a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">00237</a> <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<span class="keywordtype">int</span> <a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a>)
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241   <span class="keywordflow">for</span> (info = thread_db_list; info; info = info-&gt;<a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">next</a>)
<a name="l00242"></a>00242     <span class="keywordflow">if</span> (pid == info-&gt;<a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a>)
<a name="l00243"></a>00243       <span class="keywordflow">return</span> info;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245   <span class="keywordflow">return</span> NULL;
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="comment">/* When PID has exited or has been detached, we no longer want to keep</span>
<a name="l00249"></a>00249 <span class="comment">   track of it as using libpthread.  Call this function to discard</span>
<a name="l00250"></a>00250 <span class="comment">   thread_db related info related to PID.  Note that this closes</span>
<a name="l00251"></a>00251 <span class="comment">   LIBTHREAD_DB_SO&#39;s dlopen&#39;ed handle.  */</span>
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00254"></a><a class="code" href="linux-thread-db_8c.html#ac1a17b84ff38e1aa271da8a7bb67ae26">00254</a> <a class="code" href="linux-thread-db_8c.html#ac1a17b84ff38e1aa271da8a7bb67ae26">delete_thread_db_info</a> (<span class="keywordtype">int</span> <a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a>)
<a name="l00255"></a>00255 {
<a name="l00256"></a>00256   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info, *info_prev;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258   info_prev = NULL;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260   <span class="keywordflow">for</span> (info = thread_db_list; info; info_prev = info, info = info-&gt;<a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">next</a>)
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (pid == info-&gt;pid)
<a name="l00262"></a>00262       <span class="keywordflow">break</span>;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264   <span class="keywordflow">if</span> (info == NULL)
<a name="l00265"></a>00265     <span class="keywordflow">return</span>;
<a name="l00266"></a>00266 
<a name="l00267"></a>00267   <span class="keywordflow">if</span> (info-&gt;handle != NULL)
<a name="l00268"></a>00268     dlclose (info-&gt;handle);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270   <a class="code" href="common-utils_8c.html#a976e14808b9247ec952c262553f09f8f">xfree</a> (info-&gt;filename);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272   <span class="keywordflow">if</span> (info_prev)
<a name="l00273"></a>00273     info_prev-&gt;<a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">next</a> = info-&gt;<a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">next</a>;
<a name="l00274"></a>00274   <span class="keywordflow">else</span>
<a name="l00275"></a>00275     thread_db_list = info-&gt;<a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">next</a>;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277   <a class="code" href="common-utils_8c.html#a976e14808b9247ec952c262553f09f8f">xfree</a> (info);
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 <span class="comment">/* Prototypes for local functions.  */</span>
<a name="l00281"></a>00281 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="linux-thread-db_8c.html#af3122c68a24f28d6605a3356660c7b64">attach_thread</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>, <span class="keyword">const</span> <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> *th_p,
<a name="l00282"></a>00282                           <span class="keyword">const</span> <a class="code" href="structtd__thrinfo.html">td_thrinfo_t</a> *ti_p);
<a name="l00283"></a>00283 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="linux-thread-db_8c.html#ae86771241d19217bac7242dfb8e37c6c">detach_thread</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 <span class="comment">/* Use &quot;struct private_thread_info&quot; to cache thread state.  This is</span>
<a name="l00287"></a>00287 <span class="comment">   a substantial optimization.  */</span>
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="keyword">struct </span><a class="code" href="structprivate__thread__info.html">private_thread_info</a>
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291   <span class="comment">/* Flag set when we see a TD_DEATH event for this thread.  */</span>
<a name="l00292"></a><a class="code" href="structprivate__thread__info.html#acc64731c2220a4cde05819aadfbe6a44">00292</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structprivate__thread__info.html#acc64731c2220a4cde05819aadfbe6a44">dying</a>:1;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294   <span class="comment">/* Cached thread state.  */</span>
<a name="l00295"></a><a class="code" href="structprivate__thread__info.html#a10760ecdf3e6800fdde5aa83b71fc455">00295</a>   <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> <a class="code" href="structprivate__thread__info.html#a10760ecdf3e6800fdde5aa83b71fc455">th</a>;
<a name="l00296"></a><a class="code" href="structprivate__thread__info.html#a85dc95ad358e3e94f9c0cc49814259c0">00296</a>   <a class="code" href="glibc__thread__db_8h.html#aa406fd87cfd69d7c0a93b6a241978712">thread_t</a> <a class="code" href="structprivate__thread__info.html#a85dc95ad358e3e94f9c0cc49814259c0">tid</a>;
<a name="l00297"></a>00297 };
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l00301"></a><a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">00301</a> <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (<a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err)
<a name="l00302"></a>00302 {
<a name="l00303"></a>00303   <span class="keyword">static</span> <span class="keywordtype">char</span> buf[64];
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="keywordflow">switch</span> (err)
<a name="l00306"></a>00306     {
<a name="l00307"></a>00307     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>:
<a name="l00308"></a>00308       <span class="keywordflow">return</span> <span class="stringliteral">&quot;generic &#39;call succeeded&#39;&quot;</span>;
<a name="l00309"></a>00309     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a59f033ea09df04aef2c83400b5d245cd">TD_ERR</a>:
<a name="l00310"></a>00310       <span class="keywordflow">return</span> <span class="stringliteral">&quot;generic error&quot;</span>;
<a name="l00311"></a>00311     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a923e209a5e9fd286ddf7f691db028bd8">TD_NOTHR</a>:
<a name="l00312"></a>00312       <span class="keywordflow">return</span> <span class="stringliteral">&quot;no thread to satisfy query&quot;</span>;
<a name="l00313"></a>00313     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434ac3b9729dedbfd41ec77e61935717ef06">TD_NOSV</a>:
<a name="l00314"></a>00314       <span class="keywordflow">return</span> <span class="stringliteral">&quot;no sync handle to satisfy query&quot;</span>;
<a name="l00315"></a>00315     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434aebb10b6538c75c90951c6ef972673508">TD_NOLWP</a>:
<a name="l00316"></a>00316       <span class="keywordflow">return</span> <span class="stringliteral">&quot;no LWP to satisfy query&quot;</span>;
<a name="l00317"></a>00317     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a09f100a56667a7cc3eaba21dca2ef5bb">TD_BADPH</a>:
<a name="l00318"></a>00318       <span class="keywordflow">return</span> <span class="stringliteral">&quot;invalid process handle&quot;</span>;
<a name="l00319"></a>00319     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a9766e98fa78f694c1bc1149049a7ffa1">TD_BADTH</a>:
<a name="l00320"></a>00320       <span class="keywordflow">return</span> <span class="stringliteral">&quot;invalid thread handle&quot;</span>;
<a name="l00321"></a>00321     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434aedd104e68a48e0219dd8df261d8a05ba">TD_BADSH</a>:
<a name="l00322"></a>00322       <span class="keywordflow">return</span> <span class="stringliteral">&quot;invalid synchronization handle&quot;</span>;
<a name="l00323"></a>00323     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a0304c83af37ac9bbd8dd3ec2cf46d735">TD_BADTA</a>:
<a name="l00324"></a>00324       <span class="keywordflow">return</span> <span class="stringliteral">&quot;invalid thread agent&quot;</span>;
<a name="l00325"></a>00325     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a35c9620b6daaade5adbd313777ba50f6">TD_BADKEY</a>:
<a name="l00326"></a>00326       <span class="keywordflow">return</span> <span class="stringliteral">&quot;invalid key&quot;</span>;
<a name="l00327"></a>00327     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a7d15a6cd0a614e2ad07a716b384baaf3">TD_NOMSG</a>:
<a name="l00328"></a>00328       <span class="keywordflow">return</span> <span class="stringliteral">&quot;no event message for getmsg&quot;</span>;
<a name="l00329"></a>00329     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a176156ac8bcd0cd35cc2763567a47d81">TD_NOFPREGS</a>:
<a name="l00330"></a>00330       <span class="keywordflow">return</span> <span class="stringliteral">&quot;FPU register set not available&quot;</span>;
<a name="l00331"></a>00331     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434adc7eb8cb36425a689e6770156390a74a">TD_NOLIBTHREAD</a>:
<a name="l00332"></a>00332       <span class="keywordflow">return</span> <span class="stringliteral">&quot;application not linked with libthread&quot;</span>;
<a name="l00333"></a>00333     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434adede655355684a3520222447afd2f010">TD_NOEVENT</a>:
<a name="l00334"></a>00334       <span class="keywordflow">return</span> <span class="stringliteral">&quot;requested event is not supported&quot;</span>;
<a name="l00335"></a>00335     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a39c9423cfde70c6cbdaee285dfd89add">TD_NOCAPAB</a>:
<a name="l00336"></a>00336       <span class="keywordflow">return</span> <span class="stringliteral">&quot;capability not available&quot;</span>;
<a name="l00337"></a>00337     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a15dc23b1af650848117b5052cf3b7603">TD_DBERR</a>:
<a name="l00338"></a>00338       <span class="keywordflow">return</span> <span class="stringliteral">&quot;debugger service failed&quot;</span>;
<a name="l00339"></a>00339     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a00ad61c57929da5e28525ac68e2535ea">TD_NOAPLIC</a>:
<a name="l00340"></a>00340       <span class="keywordflow">return</span> <span class="stringliteral">&quot;operation not applicable to&quot;</span>;
<a name="l00341"></a>00341     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a5d74afeba53bbaff261358d282c977b4">TD_NOTSD</a>:
<a name="l00342"></a>00342       <span class="keywordflow">return</span> <span class="stringliteral">&quot;no thread-specific data for this thread&quot;</span>;
<a name="l00343"></a>00343     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a1664fb7160fb1dbbb982039e1e594e2c">TD_MALLOC</a>:
<a name="l00344"></a>00344       <span class="keywordflow">return</span> <span class="stringliteral">&quot;malloc failed&quot;</span>;
<a name="l00345"></a>00345     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434ade80c9872ca4dbb6ca3fb401ae710bba">TD_PARTIALREG</a>:
<a name="l00346"></a>00346       <span class="keywordflow">return</span> <span class="stringliteral">&quot;only part of register set was written/read&quot;</span>;
<a name="l00347"></a>00347     <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434ac05eb64179e5733c2b7636006511afaf">TD_NOXREGS</a>:
<a name="l00348"></a>00348       <span class="keywordflow">return</span> <span class="stringliteral">&quot;X register set not available for this thread&quot;</span>;
<a name="l00349"></a>00349 <span class="preprocessor">#ifdef THREAD_DB_HAS_TD_NOTALLOC</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a1da6860f55086bf113aa77237d5c34fa">TD_NOTALLOC</a>:
<a name="l00351"></a>00351       <span class="keywordflow">return</span> <span class="stringliteral">&quot;thread has not yet allocated TLS for given module&quot;</span>;
<a name="l00352"></a>00352 <span class="preprocessor">#endif</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span><span class="preprocessor">#ifdef THREAD_DB_HAS_TD_VERSION</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a1a1e2a6c024b0286c54cc5fc2bffbca7">TD_VERSION</a>:
<a name="l00355"></a>00355       <span class="keywordflow">return</span> <span class="stringliteral">&quot;versions of libpthread and libthread_db do not match&quot;</span>;
<a name="l00356"></a>00356 <span class="preprocessor">#endif</span>
<a name="l00357"></a>00357 <span class="preprocessor"></span><span class="preprocessor">#ifdef THREAD_DB_HAS_TD_NOTLS</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a69d2c51a658b737a0bc003df4ca11480">TD_NOTLS</a>:
<a name="l00359"></a>00359       <span class="keywordflow">return</span> <span class="stringliteral">&quot;there is no TLS segment in the given module&quot;</span>;
<a name="l00360"></a>00360 <span class="preprocessor">#endif</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span>    <span class="keywordflow">default</span>:
<a name="l00362"></a>00362       snprintf (buf, <span class="keyword">sizeof</span> (buf), <span class="stringliteral">&quot;unknown thread_db error &#39;%d&#39;&quot;</span>, err);
<a name="l00363"></a>00363       <span class="keywordflow">return</span> buf;
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 <span class="comment">/* Return 1 if any threads have been registered.  There may be none if</span>
<a name="l00368"></a>00368 <span class="comment">   the threading library is not fully initialized yet.  */</span>
<a name="l00369"></a>00369 
<a name="l00370"></a>00370 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00371"></a><a class="code" href="linux-thread-db_8c.html#aadc25ae53abeb5f1d1d915e8ff926516">00371</a> <a class="code" href="linux-thread-db_8c.html#aadc25ae53abeb5f1d1d915e8ff926516">have_threads_callback</a> (<span class="keyword">struct</span> <a class="code" href="structthread__info.html">thread_info</a> *thread, <span class="keywordtype">void</span> *args)
<a name="l00372"></a>00372 {
<a name="l00373"></a>00373   <span class="keywordtype">int</span> pid = * (<span class="keywordtype">int</span> *) args;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375   <span class="keywordflow">if</span> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (thread-&gt;<a class="code" href="structthread__info.html#a533aa3979b60affd446e9fbff93fdd2c">ptid</a>) != pid)
<a name="l00376"></a>00376     <span class="keywordflow">return</span> 0;
<a name="l00377"></a>00377 
<a name="l00378"></a>00378   <span class="keywordflow">return</span> thread-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a> != NULL;
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00382"></a><a class="code" href="linux-thread-db_8c.html#a510bee11c4763403127837b8e9b28cc9">00382</a> <a class="code" href="linux-thread-db_8c.html#a510bee11c4763403127837b8e9b28cc9">have_threads</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>)
<a name="l00383"></a>00383 {
<a name="l00384"></a>00384   <span class="keywordtype">int</span> pid = <a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386   <span class="keywordflow">return</span> <a class="code" href="gdbthread_8h.html#a5dc20fee3cc8a79f615f2f5d695ae1bc">iterate_over_threads</a> (<a class="code" href="linux-thread-db_8c.html#aadc25ae53abeb5f1d1d915e8ff926516">have_threads_callback</a>, &amp;pid) != NULL;
<a name="l00387"></a>00387 }
<a name="l00388"></a>00388 
<a name="l00389"></a><a class="code" href="structthread__get__info__inout.html">00389</a> <span class="keyword">struct </span><a class="code" href="structthread__get__info__inout.html">thread_get_info_inout</a>
<a name="l00390"></a>00390 {
<a name="l00391"></a><a class="code" href="structthread__get__info__inout.html#a8ac89f2404ef67948bc40f099a925d6c">00391</a>   <span class="keyword">struct </span><a class="code" href="structthread__info.html">thread_info</a> *<a class="code" href="structthread__get__info__inout.html#a8ac89f2404ef67948bc40f099a925d6c">thread_info</a>;
<a name="l00392"></a><a class="code" href="structthread__get__info__inout.html#a64a989294284de8f2964816b39f43dc6">00392</a>   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *<a class="code" href="structthread__get__info__inout.html#a64a989294284de8f2964816b39f43dc6">thread_db_info</a>;
<a name="l00393"></a>00393 };
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 <span class="comment">/* A callback function for td_ta_thr_iter, which we use to map all</span>
<a name="l00396"></a>00396 <span class="comment">   threads to LWPs.</span>
<a name="l00397"></a>00397 <span class="comment"></span>
<a name="l00398"></a>00398 <span class="comment">   THP is a handle to the current thread; if INFOP is not NULL, the</span>
<a name="l00399"></a>00399 <span class="comment">   struct thread_info associated with this thread is returned in</span>
<a name="l00400"></a>00400 <span class="comment">   *INFOP.</span>
<a name="l00401"></a>00401 <span class="comment"></span>
<a name="l00402"></a>00402 <span class="comment">   If the thread is a zombie, TD_THR_ZOMBIE is returned.  Otherwise,</span>
<a name="l00403"></a>00403 <span class="comment">   zero is returned to indicate success.  */</span>
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00406"></a><a class="code" href="linux-thread-db_8c.html#a3d1932e4c1b29e13e6db48c0f6e56781">00406</a> <a class="code" href="linux-thread-db_8c.html#a3d1932e4c1b29e13e6db48c0f6e56781">thread_get_info_callback</a> (<span class="keyword">const</span> <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> *thp, <span class="keywordtype">void</span> *argp)
<a name="l00407"></a>00407 {
<a name="l00408"></a>00408   <a class="code" href="structtd__thrinfo.html">td_thrinfo_t</a> ti;
<a name="l00409"></a>00409   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err;
<a name="l00410"></a>00410   <a class="code" href="structptid.html">ptid_t</a> thread_ptid;
<a name="l00411"></a>00411   <span class="keyword">struct </span><a class="code" href="structthread__get__info__inout.html">thread_get_info_inout</a> *inout;
<a name="l00412"></a>00412   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414   inout = argp;
<a name="l00415"></a>00415   info = inout-&gt;<a class="code" href="structthread__get__info__inout.html#a64a989294284de8f2964816b39f43dc6">thread_db_info</a>;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417   err = info-&gt;<a class="code" href="structthread__db__info.html#a067c8611bf9c894d3691f7cb7bbefdcc">td_thr_get_info_p</a> (thp, &amp;ti);
<a name="l00418"></a>00418   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l00419"></a>00419     <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;thread_get_info_callback: cannot get thread info: %s&quot;</span>),
<a name="l00420"></a>00420            <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l00421"></a>00421 
<a name="l00422"></a>00422   <span class="comment">/* Fill the cache.  */</span>
<a name="l00423"></a>00423   thread_ptid = <a class="code" href="ptid_8c.html#aa96ee3f6a88626ec36045b4d84e27f79">ptid_build</a> (info-&gt;<a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a>, ti.<a class="code" href="structtd__thrinfo.html#a260ea1a3410bad7ac271209bd014b467">ti_lid</a>, 0);
<a name="l00424"></a>00424   inout-&gt;<a class="code" href="structthread__get__info__inout.html#a8ac89f2404ef67948bc40f099a925d6c">thread_info</a> = <a class="code" href="gdbthread_8h.html#ac9a7f4c3c173f717f0da44f83745384c">find_thread_ptid</a> (thread_ptid);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426   <span class="keywordflow">if</span> (inout-&gt;<a class="code" href="structthread__get__info__inout.html#a8ac89f2404ef67948bc40f099a925d6c">thread_info</a> == NULL)
<a name="l00427"></a>00427     {
<a name="l00428"></a>00428       <span class="comment">/* New thread.  Attach to it now (why wait?).  */</span>
<a name="l00429"></a>00429       <span class="keywordflow">if</span> (!<a class="code" href="linux-thread-db_8c.html#a510bee11c4763403127837b8e9b28cc9">have_threads</a> (thread_ptid))
<a name="l00430"></a>00430         <a class="code" href="linux-thread-db_8c.html#a8748de14af79f07c6a5737302e476e1f">thread_db_find_new_threads_1</a> (thread_ptid);
<a name="l00431"></a>00431       <span class="keywordflow">else</span>
<a name="l00432"></a>00432         <a class="code" href="linux-thread-db_8c.html#af3122c68a24f28d6605a3356660c7b64">attach_thread</a> (thread_ptid, thp, &amp;ti);
<a name="l00433"></a>00433       inout-&gt;<a class="code" href="structthread__get__info__inout.html#a8ac89f2404ef67948bc40f099a925d6c">thread_info</a> = <a class="code" href="gdbthread_8h.html#ac9a7f4c3c173f717f0da44f83745384c">find_thread_ptid</a> (thread_ptid);
<a name="l00434"></a>00434       <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (inout-&gt;<a class="code" href="structthread__get__info__inout.html#a8ac89f2404ef67948bc40f099a925d6c">thread_info</a> != NULL);
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437   <span class="keywordflow">return</span> 0;
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 <span class="comment">/* Fetch the user-level thread id of PTID.  */</span>
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00443"></a><a class="code" href="linux-thread-db_8c.html#a38aead26eb6f716a7007180580b0b154">00443</a> <a class="code" href="linux-thread-db_8c.html#a38aead26eb6f716a7007180580b0b154">thread_from_lwp</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>)
<a name="l00444"></a>00444 {
<a name="l00445"></a>00445   <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> th;
<a name="l00446"></a>00446   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err;
<a name="l00447"></a>00447   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l00448"></a>00448   <span class="keyword">struct </span><a class="code" href="structthread__get__info__inout.html">thread_get_info_inout</a> io = {0};
<a name="l00449"></a>00449 
<a name="l00450"></a>00450   <span class="comment">/* Just in case td_ta_map_lwp2thr doesn&#39;t initialize it completely.  */</span>
<a name="l00451"></a>00451   th.<a class="code" href="structtd__thrhandle.html#aa9e2bc0917cb6e384360b67e30d6f9a5">th_unique</a> = 0;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453   <span class="comment">/* This ptid comes from linux-nat.c, which should always fill in the</span>
<a name="l00454"></a>00454 <span class="comment">     LWP.  */</span>
<a name="l00455"></a>00455   <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (<a class="code" href="ptid_8c.html#af5b67a5f356c507b7809af2fa4e63b44">ptid_get_lwp</a> (ptid) != 0);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457   info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid));
<a name="l00458"></a>00458 
<a name="l00459"></a>00459   <span class="comment">/* Access an lwp we know is stopped.  */</span>
<a name="l00460"></a>00460   info-&gt;<a class="code" href="structthread__db__info.html#a35554ecef70a2233685706acde969f25">proc_handle</a>.<a class="code" href="structps__prochandle.html#ac137f90af8832f0784aed26658870623">ptid</a> = ptid;
<a name="l00461"></a>00461   err = info-&gt;<a class="code" href="structthread__db__info.html#a152d1cf5158bfed758f0b4c95f1be4cf">td_ta_map_lwp2thr_p</a> (info-&gt;<a class="code" href="structthread__db__info.html#a9be1d106fa5bde24113c74810bf47324">thread_agent</a>, <a class="code" href="ptid_8c.html#af5b67a5f356c507b7809af2fa4e63b44">ptid_get_lwp</a> (ptid),
<a name="l00462"></a>00462                                    &amp;th);
<a name="l00463"></a>00463   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l00464"></a>00464     <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Cannot find user-level thread for LWP %ld: %s&quot;</span>),
<a name="l00465"></a>00465            <a class="code" href="ptid_8c.html#af5b67a5f356c507b7809af2fa4e63b44">ptid_get_lwp</a> (ptid), <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l00466"></a>00466 
<a name="l00467"></a>00467   <span class="comment">/* Long-winded way of fetching the thread info.  */</span>
<a name="l00468"></a>00468   io.<a class="code" href="structthread__get__info__inout.html#a64a989294284de8f2964816b39f43dc6">thread_db_info</a> = info;
<a name="l00469"></a>00469   io.<a class="code" href="structthread__get__info__inout.html#a8ac89f2404ef67948bc40f099a925d6c">thread_info</a> = NULL;
<a name="l00470"></a>00470   <a class="code" href="linux-thread-db_8c.html#a3d1932e4c1b29e13e6db48c0f6e56781">thread_get_info_callback</a> (&amp;th, &amp;io);
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 <span class="comment">/* Attach to lwp PTID, doing whatever else is required to have this</span>
<a name="l00475"></a>00475 <span class="comment">   LWP under the debugger&#39;s control --- e.g., enabling event</span>
<a name="l00476"></a>00476 <span class="comment">   reporting.  Returns true on success.  */</span>
<a name="l00477"></a>00477 <span class="keywordtype">int</span>
<a name="l00478"></a><a class="code" href="linux-thread-db_8c.html#a0ae4d16067493602d581730cd361fc96">00478</a> <a class="code" href="linux-nat_8h.html#a0ae4d16067493602d581730cd361fc96">thread_db_attach_lwp</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>)
<a name="l00479"></a>00479 {
<a name="l00480"></a>00480   <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> th;
<a name="l00481"></a>00481   <a class="code" href="structtd__thrinfo.html">td_thrinfo_t</a> ti;
<a name="l00482"></a>00482   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err;
<a name="l00483"></a>00483   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485   info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid));
<a name="l00486"></a>00486 
<a name="l00487"></a>00487   <span class="keywordflow">if</span> (info == NULL)
<a name="l00488"></a>00488     <span class="keywordflow">return</span> 0;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490   <span class="comment">/* This ptid comes from linux-nat.c, which should always fill in the</span>
<a name="l00491"></a>00491 <span class="comment">     LWP.  */</span>
<a name="l00492"></a>00492   <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (<a class="code" href="ptid_8c.html#af5b67a5f356c507b7809af2fa4e63b44">ptid_get_lwp</a> (ptid) != 0);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494   <span class="comment">/* Access an lwp we know is stopped.  */</span>
<a name="l00495"></a>00495   info-&gt;<a class="code" href="structthread__db__info.html#a35554ecef70a2233685706acde969f25">proc_handle</a>.<a class="code" href="structps__prochandle.html#ac137f90af8832f0784aed26658870623">ptid</a> = ptid;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497   <span class="comment">/* If we have only looked at the first thread before libpthread was</span>
<a name="l00498"></a>00498 <span class="comment">     initialized, we may not know its thread ID yet.  Make sure we do</span>
<a name="l00499"></a>00499 <span class="comment">     before we add another thread to the list.  */</span>
<a name="l00500"></a>00500   <span class="keywordflow">if</span> (!<a class="code" href="linux-thread-db_8c.html#a510bee11c4763403127837b8e9b28cc9">have_threads</a> (ptid))
<a name="l00501"></a>00501     <a class="code" href="linux-thread-db_8c.html#a8748de14af79f07c6a5737302e476e1f">thread_db_find_new_threads_1</a> (ptid);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503   err = info-&gt;<a class="code" href="structthread__db__info.html#a152d1cf5158bfed758f0b4c95f1be4cf">td_ta_map_lwp2thr_p</a> (info-&gt;<a class="code" href="structthread__db__info.html#a9be1d106fa5bde24113c74810bf47324">thread_agent</a>, <a class="code" href="ptid_8c.html#af5b67a5f356c507b7809af2fa4e63b44">ptid_get_lwp</a> (ptid),
<a name="l00504"></a>00504                                    &amp;th);
<a name="l00505"></a>00505   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l00506"></a>00506     <span class="comment">/* Cannot find user-level thread.  */</span>
<a name="l00507"></a>00507     <span class="keywordflow">return</span> 0;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509   err = info-&gt;<a class="code" href="structthread__db__info.html#a067c8611bf9c894d3691f7cb7bbefdcc">td_thr_get_info_p</a> (&amp;th, &amp;ti);
<a name="l00510"></a>00510   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l00511"></a>00511     {
<a name="l00512"></a>00512       <a class="code" href="utils_8c.html#a5fc201a4181499a6b4057a6caa15b5e2">warning</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Cannot get thread info: %s&quot;</span>), <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l00513"></a>00513       <span class="keywordflow">return</span> 0;
<a name="l00514"></a>00514     }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516   <a class="code" href="linux-thread-db_8c.html#af3122c68a24f28d6605a3356660c7b64">attach_thread</a> (ptid, &amp;th, &amp;ti);
<a name="l00517"></a>00517   <span class="keywordflow">return</span> 1;
<a name="l00518"></a>00518 }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00521"></a><a class="code" href="linux-thread-db_8c.html#aa4e1f9486849e12810fa2b814c0caee0">00521</a> <a class="code" href="linux-thread-db_8c.html#aa4e1f9486849e12810fa2b814c0caee0">verbose_dlsym</a> (<span class="keywordtype">void</span> *<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aarch64-tdep_8c.html#acc128f98d9ceca227038c771308eff39">name</a>)
<a name="l00522"></a>00522 {
<a name="l00523"></a>00523   <span class="keywordtype">void</span> *sym = dlsym (handle, name);
<a name="l00524"></a>00524   <span class="keywordflow">if</span> (sym == NULL)
<a name="l00525"></a>00525     <a class="code" href="utils_8c.html#a5fc201a4181499a6b4057a6caa15b5e2">warning</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Symbol \&quot;%s\&quot; not found in libthread_db: %s&quot;</span>),
<a name="l00526"></a>00526              name, dlerror ());
<a name="l00527"></a>00527   <span class="keywordflow">return</span> sym;
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 <span class="keyword">static</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a>
<a name="l00531"></a><a class="code" href="linux-thread-db_8c.html#a09c055ae82a6f7d9e800e561c968c390">00531</a> <a class="code" href="linux-thread-db_8c.html#a09c055ae82a6f7d9e800e561c968c390">enable_thread_event</a> (<span class="keywordtype">int</span> event, <a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a> *bp)
<a name="l00532"></a>00532 {
<a name="l00533"></a>00533   <a class="code" href="structtd__notify.html">td_notify_t</a> notify;
<a name="l00534"></a>00534   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err;
<a name="l00535"></a>00535   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537   info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>));
<a name="l00538"></a>00538 
<a name="l00539"></a>00539   <span class="comment">/* Access an lwp we know is stopped.  */</span>
<a name="l00540"></a>00540   info-&gt;<a class="code" href="structthread__db__info.html#a35554ecef70a2233685706acde969f25">proc_handle</a>.<a class="code" href="structps__prochandle.html#ac137f90af8832f0784aed26658870623">ptid</a> = <a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542   <span class="comment">/* Get the breakpoint address for thread EVENT.  */</span>
<a name="l00543"></a>00543   err = info-&gt;<a class="code" href="structthread__db__info.html#ad79f996f977dc0dd57a8dc5eb55eeccc">td_ta_event_addr_p</a> (info-&gt;<a class="code" href="structthread__db__info.html#a9be1d106fa5bde24113c74810bf47324">thread_agent</a>, event, &amp;notify);
<a name="l00544"></a>00544   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l00545"></a>00545     <span class="keywordflow">return</span> err;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547   <span class="comment">/* Set up the breakpoint.  */</span>
<a name="l00548"></a>00548   <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (<a class="code" href="exec_8h.html#ac2e2e739fca42163e235e8521b9fbbab">exec_bfd</a>);
<a name="l00549"></a>00549   (*bp) = (<a class="code" href="gdbarch_8c.html#adc1ce8006630950c775890c6fe36faa1">gdbarch_convert_from_func_ptr_addr</a>
<a name="l00550"></a>00550            (<a class="code" href="gdbarch_8c.html#ad648a33f69abe34e9679744a0c5a0580">target_gdbarch</a> (),
<a name="l00551"></a>00551             <span class="comment">/* Do proper sign extension for the target.  */</span>
<a name="l00552"></a>00552             (bfd_get_sign_extend_vma (<a class="code" href="exec_8h.html#ac2e2e739fca42163e235e8521b9fbbab">exec_bfd</a>) &gt; 0
<a name="l00553"></a>00553              ? (<a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a>) (intptr_t) notify.<a class="code" href="structtd__notify.html#a83486ea4248c6dc9a4f53c1907df258d">u</a>.<a class="code" href="structtd__notify.html#a55080380d06d9a0c78365bce41265664">bptaddr</a>
<a name="l00554"></a>00554              : (<a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a>) (uintptr_t) notify.<a class="code" href="structtd__notify.html#a83486ea4248c6dc9a4f53c1907df258d">u</a>.<a class="code" href="structtd__notify.html#a55080380d06d9a0c78365bce41265664">bptaddr</a>),
<a name="l00555"></a>00555             &amp;<a class="code" href="target_8h.html#a2d8640b030266b58d3821eb5cfd112b9">current_target</a>));
<a name="l00556"></a>00556   <a class="code" href="breakpoint_8c.html#a298430eac23f181437bab34903720b61">create_thread_event_breakpoint</a> (<a class="code" href="gdbarch_8c.html#ad648a33f69abe34e9679744a0c5a0580">target_gdbarch</a> (), *bp);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558   <span class="keywordflow">return</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>;
<a name="l00559"></a>00559 }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 <span class="comment">/* Verify inferior&#39;s &#39;\0&#39;-terminated symbol VER_SYMBOL starts with &quot;%d.%d&quot; and</span>
<a name="l00562"></a>00562 <span class="comment">   return 1 if this version is lower (and not equal) to</span>
<a name="l00563"></a>00563 <span class="comment">   VER_MAJOR_MIN.VER_MINOR_MIN.  Return 0 in all other cases.  */</span>
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00566"></a><a class="code" href="linux-thread-db_8c.html#afb3f3ee95003d2a34d0f915c1d5cd8be">00566</a> <a class="code" href="linux-thread-db_8c.html#afb3f3ee95003d2a34d0f915c1d5cd8be">inferior_has_bug</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *ver_symbol, <span class="keywordtype">int</span> ver_major_min, <span class="keywordtype">int</span> ver_minor_min)
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568   <span class="keyword">struct </span><a class="code" href="structminimal__symbol.html">minimal_symbol</a> *version_msym;
<a name="l00569"></a>00569   <a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a> version_addr;
<a name="l00570"></a>00570   <span class="keywordtype">char</span> *<a class="code" href="version_8h.html#ac91cf940e10a61b95cabc3258a06186b">version</a>;
<a name="l00571"></a>00571   <span class="keywordtype">int</span> err, got, retval = 0;
<a name="l00572"></a>00572 
<a name="l00573"></a>00573   version_msym = <a class="code" href="minsyms_8c.html#af87f7a894386515074ddd71365bc09b8">lookup_minimal_symbol</a> (ver_symbol, NULL, NULL);
<a name="l00574"></a>00574   <span class="keywordflow">if</span> (version_msym == NULL)
<a name="l00575"></a>00575     <span class="keywordflow">return</span> 0;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577   version_addr = <a class="code" href="symtab_8h.html#abee697b9e3bb4f4d164ad920a87ab854">SYMBOL_VALUE_ADDRESS</a> (version_msym);
<a name="l00578"></a>00578   got = <a class="code" href="target_8c.html#a394bfbed99bddd14b28ca9b6538292c2">target_read_string</a> (version_addr, &amp;version, 32, &amp;err);
<a name="l00579"></a>00579   <span class="keywordflow">if</span> (err == 0 &amp;&amp; memchr (version, 0, got) == &amp;version[got -1])
<a name="l00580"></a>00580     {
<a name="l00581"></a>00581       <span class="keywordtype">int</span> major, minor;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583       retval = (sscanf (version, <span class="stringliteral">&quot;%d.%d&quot;</span>, &amp;major, &amp;minor) == 2
<a name="l00584"></a>00584                 &amp;&amp; (major &lt; ver_major_min
<a name="l00585"></a>00585                     || (major == ver_major_min &amp;&amp; minor &lt; ver_minor_min)));
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587   <a class="code" href="common-utils_8c.html#a976e14808b9247ec952c262553f09f8f">xfree</a> (version);
<a name="l00588"></a>00588 
<a name="l00589"></a>00589   <span class="keywordflow">return</span> retval;
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00593"></a><a class="code" href="linux-thread-db_8c.html#af0d98749063285a4cd59f8a142ff5500">00593</a> <a class="code" href="linux-thread-db_8c.html#af0d98749063285a4cd59f8a142ff5500">enable_thread_event_reporting</a> (<span class="keywordtype">void</span>)
<a name="l00594"></a>00594 {
<a name="l00595"></a>00595   <a class="code" href="structtd__thr__events.html">td_thr_events_t</a> events;
<a name="l00596"></a>00596   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err;
<a name="l00597"></a>00597   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599   info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>));
<a name="l00600"></a>00600 
<a name="l00601"></a>00601   <span class="comment">/* We cannot use the thread event reporting facility if these</span>
<a name="l00602"></a>00602 <span class="comment">     functions aren&#39;t available.  */</span>
<a name="l00603"></a>00603   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#ad79f996f977dc0dd57a8dc5eb55eeccc">td_ta_event_addr_p</a> == NULL
<a name="l00604"></a>00604       || info-&gt;<a class="code" href="structthread__db__info.html#ac9cfa2d72dcdbfbf699a591631a01697">td_ta_set_event_p</a> == NULL
<a name="l00605"></a>00605       || info-&gt;<a class="code" href="structthread__db__info.html#aa8b076c6af5ed7412b77fdb540a2b954">td_ta_event_getmsg_p</a> == NULL
<a name="l00606"></a>00606       || info-&gt;<a class="code" href="structthread__db__info.html#a33e247512f4590ab36ac442ed3a4c9f3">td_thr_event_enable_p</a> == NULL)
<a name="l00607"></a>00607     <span class="keywordflow">return</span>;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609   <span class="comment">/* Set the process wide mask saying which events we&#39;re interested in.  */</span>
<a name="l00610"></a>00610   <a class="code" href="glibc__thread__db_8h.html#ae7be534e38e98b9d0797806cd0716ac2">td_event_emptyset</a> (&amp;events);
<a name="l00611"></a>00611   <a class="code" href="glibc__thread__db_8h.html#ae5962c9b1a62b04090df920a7d3cc6c5">td_event_addset</a> (&amp;events, <a class="code" href="glibc__thread__db_8h.html#ae1a250281b93679f2616df2bbcba40e0aecc98b124ac8e6a5ce8ad882158bf863">TD_CREATE</a>);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613   <span class="comment">/* There is a bug fixed between linuxthreads 2.1.3 and 2.2 by</span>
<a name="l00614"></a>00614 <span class="comment">       commit 2e4581e4fba917f1779cd0a010a45698586c190a</span>
<a name="l00615"></a>00615 <span class="comment">       * manager.c (pthread_exited): Correctly report event as TD_REAP</span>
<a name="l00616"></a>00616 <span class="comment">       instead of TD_DEATH.  Fix comments.</span>
<a name="l00617"></a>00617 <span class="comment">     where event reporting facility is broken for TD_DEATH events,</span>
<a name="l00618"></a>00618 <span class="comment">     so don&#39;t enable it if we have glibc but a lower version.  */</span>
<a name="l00619"></a>00619   <span class="keywordflow">if</span> (!<a class="code" href="linux-thread-db_8c.html#afb3f3ee95003d2a34d0f915c1d5cd8be">inferior_has_bug</a> (<span class="stringliteral">&quot;__linuxthreads_version&quot;</span>, 2, 2))
<a name="l00620"></a>00620     <a class="code" href="glibc__thread__db_8h.html#ae5962c9b1a62b04090df920a7d3cc6c5">td_event_addset</a> (&amp;events, <a class="code" href="glibc__thread__db_8h.html#ae1a250281b93679f2616df2bbcba40e0a40da0b34365d11c6c5c56c8fce78dd69">TD_DEATH</a>);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   err = info-&gt;<a class="code" href="structthread__db__info.html#ac9cfa2d72dcdbfbf699a591631a01697">td_ta_set_event_p</a> (info-&gt;<a class="code" href="structthread__db__info.html#a9be1d106fa5bde24113c74810bf47324">thread_agent</a>, &amp;events);
<a name="l00623"></a>00623   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l00624"></a>00624     {
<a name="l00625"></a>00625       <a class="code" href="utils_8c.html#a5fc201a4181499a6b4057a6caa15b5e2">warning</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Unable to set global thread event mask: %s&quot;</span>),
<a name="l00626"></a>00626                <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l00627"></a>00627       <span class="keywordflow">return</span>;
<a name="l00628"></a>00628     }
<a name="l00629"></a>00629 
<a name="l00630"></a>00630   <span class="comment">/* Delete previous thread event breakpoints, if any.  */</span>
<a name="l00631"></a>00631   <a class="code" href="breakpoint_8c.html#a5b5cd7b781ac9e4895f8bac9d7023ad0">remove_thread_event_breakpoints</a> ();
<a name="l00632"></a>00632   info-&gt;<a class="code" href="structthread__db__info.html#a20fc4977322c8f3c080e5d7b4c2d6a94">td_create_bp_addr</a> = 0;
<a name="l00633"></a>00633   info-&gt;<a class="code" href="structthread__db__info.html#a68dd60e8331b9ba6c935e294944024d9">td_death_bp_addr</a> = 0;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635   <span class="comment">/* Set up the thread creation event.  */</span>
<a name="l00636"></a>00636   err = <a class="code" href="linux-thread-db_8c.html#a09c055ae82a6f7d9e800e561c968c390">enable_thread_event</a> (<a class="code" href="glibc__thread__db_8h.html#ae1a250281b93679f2616df2bbcba40e0aecc98b124ac8e6a5ce8ad882158bf863">TD_CREATE</a>, &amp;info-&gt;<a class="code" href="structthread__db__info.html#a20fc4977322c8f3c080e5d7b4c2d6a94">td_create_bp_addr</a>);
<a name="l00637"></a>00637   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l00638"></a>00638     {
<a name="l00639"></a>00639       <a class="code" href="utils_8c.html#a5fc201a4181499a6b4057a6caa15b5e2">warning</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Unable to get location for thread creation breakpoint: %s&quot;</span>),
<a name="l00640"></a>00640                <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l00641"></a>00641       <span class="keywordflow">return</span>;
<a name="l00642"></a>00642     }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644   <span class="comment">/* Set up the thread death event.  */</span>
<a name="l00645"></a>00645   err = <a class="code" href="linux-thread-db_8c.html#a09c055ae82a6f7d9e800e561c968c390">enable_thread_event</a> (<a class="code" href="glibc__thread__db_8h.html#ae1a250281b93679f2616df2bbcba40e0a40da0b34365d11c6c5c56c8fce78dd69">TD_DEATH</a>, &amp;info-&gt;<a class="code" href="structthread__db__info.html#a68dd60e8331b9ba6c935e294944024d9">td_death_bp_addr</a>);
<a name="l00646"></a>00646   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l00647"></a>00647     {
<a name="l00648"></a>00648       <a class="code" href="utils_8c.html#a5fc201a4181499a6b4057a6caa15b5e2">warning</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Unable to get location for thread death breakpoint: %s&quot;</span>),
<a name="l00649"></a>00649                <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l00650"></a>00650       <span class="keywordflow">return</span>;
<a name="l00651"></a>00651     }
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 <span class="comment">/* Similar as thread_db_find_new_threads_1, but try to silently ignore errors</span>
<a name="l00655"></a>00655 <span class="comment">   if appropriate.</span>
<a name="l00656"></a>00656 <span class="comment"></span>
<a name="l00657"></a>00657 <span class="comment">   Return 1 if the caller should abort libthread_db initialization.  Return 0</span>
<a name="l00658"></a>00658 <span class="comment">   otherwise.  */</span>
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00661"></a><a class="code" href="linux-thread-db_8c.html#a12c1570c6d5d65f09ec2e422f049eb49">00661</a> <a class="code" href="linux-thread-db_8c.html#a12c1570c6d5d65f09ec2e422f049eb49">thread_db_find_new_threads_silently</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>)
<a name="l00662"></a>00662 {
<a name="l00663"></a>00663   <span class="keyword">volatile</span> <span class="keyword">struct </span><a class="code" href="structgdb__exception.html">gdb_exception</a> except;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665   <a class="code" href="exceptions_8h.html#aef4514ee39b9305fddee27f49c7c34eb">TRY_CATCH</a> (except, <a class="code" href="exceptions_8h.html#abfa3a3b99557b11f5766baf69465fdf6a44de51845416ac49ab08438792b908f0">RETURN_MASK_ERROR</a>)
<a name="l00666"></a>00666     {
<a name="l00667"></a>00667       <a class="code" href="linux-thread-db_8c.html#a0b2931755e813dbd72852f11a1fe7d78">thread_db_find_new_threads_2</a> (ptid, 1);
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670   <span class="keywordflow">if</span> (except.<a class="code" href="structgdb__exception.html#ae0e14189c63f830024865d557c1122cc">reason</a> &lt; 0)
<a name="l00671"></a>00671     {
<a name="l00672"></a>00672       <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">libthread_db_debug</a>)
<a name="l00673"></a>00673         <a class="code" href="exceptions_8c.html#ae1dffc77e3a96d17e813da7d2165b16d">exception_fprintf</a> (<a class="code" href="main_8c.html#a2a1dea1e551cadb9541353a004193a47">gdb_stderr</a>, except,
<a name="l00674"></a>00674                            <span class="stringliteral">&quot;Warning: thread_db_find_new_threads_silently: &quot;</span>);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676       <span class="comment">/* There is a bug fixed between nptl 2.6.1 and 2.7 by</span>
<a name="l00677"></a>00677 <span class="comment">           commit 7d9d8bd18906fdd17364f372b160d7ab896ce909</span>
<a name="l00678"></a>00678 <span class="comment">         where calls to td_thr_get_info fail with TD_ERR for statically linked</span>
<a name="l00679"></a>00679 <span class="comment">         executables if td_thr_get_info is called before glibc has initialized</span>
<a name="l00680"></a>00680 <span class="comment">         itself.</span>
<a name="l00681"></a>00681 <span class="comment">         </span>
<a name="l00682"></a>00682 <span class="comment">         If the nptl bug is NOT present in the inferior and still thread_db</span>
<a name="l00683"></a>00683 <span class="comment">         reports an error return 1.  It means the inferior has corrupted thread</span>
<a name="l00684"></a>00684 <span class="comment">         list and GDB should fall back only to LWPs.</span>
<a name="l00685"></a>00685 <span class="comment"></span>
<a name="l00686"></a>00686 <span class="comment">         If the nptl bug is present in the inferior return 0 to silently ignore</span>
<a name="l00687"></a>00687 <span class="comment">         such errors, and let gdb enumerate threads again later.  In such case</span>
<a name="l00688"></a>00688 <span class="comment">         GDB cannot properly display LWPs if the inferior thread list is</span>
<a name="l00689"></a>00689 <span class="comment">         corrupted.  For core files it does not apply, no &#39;later enumeration&#39;</span>
<a name="l00690"></a>00690 <span class="comment">         is possible.  */</span>
<a name="l00691"></a>00691 
<a name="l00692"></a>00692       <span class="keywordflow">if</span> (!<a class="code" href="target_8h.html#a85885df22f7c1304269eaba1e1d618b7">target_has_execution</a> || !<a class="code" href="linux-thread-db_8c.html#afb3f3ee95003d2a34d0f915c1d5cd8be">inferior_has_bug</a> (<span class="stringliteral">&quot;nptl_version&quot;</span>, 2, 7))
<a name="l00693"></a>00693         {
<a name="l00694"></a>00694           <a class="code" href="exceptions_8c.html#ae1dffc77e3a96d17e813da7d2165b16d">exception_fprintf</a> (<a class="code" href="main_8c.html#a2a1dea1e551cadb9541353a004193a47">gdb_stderr</a>, except,
<a name="l00695"></a>00695                              <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Warning: couldn&#39;t activate thread debugging &quot;</span>
<a name="l00696"></a>00696                                <span class="stringliteral">&quot;using libthread_db: &quot;</span>));
<a name="l00697"></a>00697           <span class="keywordflow">return</span> 1;
<a name="l00698"></a>00698         }
<a name="l00699"></a>00699     }
<a name="l00700"></a>00700   <span class="keywordflow">return</span> 0;
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00703"></a>00703 <span class="comment">/* Lookup a library in which given symbol resides.</span>
<a name="l00704"></a>00704 <span class="comment">   Note: this is looking in GDB process, not in the inferior.</span>
<a name="l00705"></a>00705 <span class="comment">   Returns library name, or NULL.  */</span>
<a name="l00706"></a>00706 
<a name="l00707"></a>00707 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00708"></a><a class="code" href="linux-thread-db_8c.html#acf15a012b43fdb906be91cbaec39957f">00708</a> <a class="code" href="linux-thread-db_8c.html#acf15a012b43fdb906be91cbaec39957f">dladdr_to_soname</a> (<span class="keyword">const</span> <span class="keywordtype">void</span> *addr)
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710   Dl_info info;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712   <span class="keywordflow">if</span> (dladdr (addr, &amp;info) != 0)
<a name="l00713"></a>00713     <span class="keywordflow">return</span> info.dli_fname;
<a name="l00714"></a>00714   <span class="keywordflow">return</span> NULL;
<a name="l00715"></a>00715 }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717 <span class="comment">/* Attempt to initialize dlopen()ed libthread_db, described by INFO.</span>
<a name="l00718"></a>00718 <span class="comment">   Return 1 on success.</span>
<a name="l00719"></a>00719 <span class="comment">   Failure could happen if libthread_db does not have symbols we expect,</span>
<a name="l00720"></a>00720 <span class="comment">   or when it refuses to work with the current inferior (e.g. due to</span>
<a name="l00721"></a>00721 <span class="comment">   version mismatch between libthread_db and libpthread).  */</span>
<a name="l00722"></a>00722 
<a name="l00723"></a>00723 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00724"></a><a class="code" href="linux-thread-db_8c.html#a888a5b79921bdac5c64db3cac30e6839">00724</a> <a class="code" href="linux-thread-db_8c.html#a888a5b79921bdac5c64db3cac30e6839">try_thread_db_load_1</a> (<span class="keyword">struct</span> <a class="code" href="structthread__db__info.html">thread_db_info</a> *info)
<a name="l00725"></a>00725 {
<a name="l00726"></a>00726   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   <span class="comment">/* Initialize pointers to the dynamic library functions we will use.</span>
<a name="l00729"></a>00729 <span class="comment">     Essential functions first.  */</span>
<a name="l00730"></a>00730 
<a name="l00731"></a>00731   info-&gt;<a class="code" href="structthread__db__info.html#a9b642e7507877ebf6ceed47cef1f8ab5">td_init_p</a> = <a class="code" href="linux-thread-db_8c.html#aa4e1f9486849e12810fa2b814c0caee0">verbose_dlsym</a> (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_init&quot;</span>);
<a name="l00732"></a>00732   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#a9b642e7507877ebf6ceed47cef1f8ab5">td_init_p</a> == NULL)
<a name="l00733"></a>00733     <span class="keywordflow">return</span> 0;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735   err = info-&gt;<a class="code" href="structthread__db__info.html#a9b642e7507877ebf6ceed47cef1f8ab5">td_init_p</a> ();
<a name="l00736"></a>00736   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l00737"></a>00737     {
<a name="l00738"></a>00738       <a class="code" href="utils_8c.html#a5fc201a4181499a6b4057a6caa15b5e2">warning</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Cannot initialize libthread_db: %s&quot;</span>),
<a name="l00739"></a>00739                <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l00740"></a>00740       <span class="keywordflow">return</span> 0;
<a name="l00741"></a>00741     }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743   info-&gt;<a class="code" href="structthread__db__info.html#a631b014b2215b6784a65df041f588255">td_ta_new_p</a> = <a class="code" href="linux-thread-db_8c.html#aa4e1f9486849e12810fa2b814c0caee0">verbose_dlsym</a> (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_ta_new&quot;</span>);
<a name="l00744"></a>00744   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#a631b014b2215b6784a65df041f588255">td_ta_new_p</a> == NULL)
<a name="l00745"></a>00745     <span class="keywordflow">return</span> 0;
<a name="l00746"></a>00746 
<a name="l00747"></a>00747   <span class="comment">/* Initialize the structure that identifies the child process.  */</span>
<a name="l00748"></a>00748   info-&gt;<a class="code" href="structthread__db__info.html#a35554ecef70a2233685706acde969f25">proc_handle</a>.<a class="code" href="structps__prochandle.html#ac137f90af8832f0784aed26658870623">ptid</a> = <a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>;
<a name="l00749"></a>00749 
<a name="l00750"></a>00750   <span class="comment">/* Now attempt to open a connection to the thread library.  */</span>
<a name="l00751"></a>00751   err = info-&gt;<a class="code" href="structthread__db__info.html#a631b014b2215b6784a65df041f588255">td_ta_new_p</a> (&amp;info-&gt;<a class="code" href="structthread__db__info.html#a35554ecef70a2233685706acde969f25">proc_handle</a>, &amp;info-&gt;<a class="code" href="structthread__db__info.html#a9be1d106fa5bde24113c74810bf47324">thread_agent</a>);
<a name="l00752"></a>00752   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l00753"></a>00753     {
<a name="l00754"></a>00754       <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">libthread_db_debug</a>)
<a name="l00755"></a>00755         <a class="code" href="utils_8c.html#ad57145632bbcb0361dc1dfa134b1efd0">printf_unfiltered</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;td_ta_new failed: %s\n&quot;</span>),
<a name="l00756"></a>00756                            <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l00757"></a>00757       <span class="keywordflow">else</span>
<a name="l00758"></a>00758         <span class="keywordflow">switch</span> (err)
<a name="l00759"></a>00759           {
<a name="l00760"></a>00760             <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434adc7eb8cb36425a689e6770156390a74a">TD_NOLIBTHREAD</a>:
<a name="l00761"></a>00761 <span class="preprocessor">#ifdef THREAD_DB_HAS_TD_VERSION</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a1a1e2a6c024b0286c54cc5fc2bffbca7">TD_VERSION</a>:
<a name="l00763"></a>00763 <span class="preprocessor">#endif</span>
<a name="l00764"></a>00764 <span class="preprocessor"></span>              <span class="comment">/* The errors above are not unexpected and silently ignored:</span>
<a name="l00765"></a>00765 <span class="comment">                 they just mean we haven&#39;t found correct version of</span>
<a name="l00766"></a>00766 <span class="comment">                 libthread_db yet.  */</span>
<a name="l00767"></a>00767               <span class="keywordflow">break</span>;
<a name="l00768"></a>00768             <span class="keywordflow">default</span>:
<a name="l00769"></a>00769               <a class="code" href="utils_8c.html#a5fc201a4181499a6b4057a6caa15b5e2">warning</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;td_ta_new failed: %s&quot;</span>), <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l00770"></a>00770           }
<a name="l00771"></a>00771       <span class="keywordflow">return</span> 0;
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773 
<a name="l00774"></a>00774   info-&gt;<a class="code" href="structthread__db__info.html#ab4a7d294a2360b847757d738debd97f3">td_ta_map_id2thr_p</a> = <a class="code" href="linux-thread-db_8c.html#aa4e1f9486849e12810fa2b814c0caee0">verbose_dlsym</a> (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_ta_map_id2thr&quot;</span>);
<a name="l00775"></a>00775   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#ab4a7d294a2360b847757d738debd97f3">td_ta_map_id2thr_p</a> == NULL)
<a name="l00776"></a>00776     <span class="keywordflow">return</span> 0;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778   info-&gt;<a class="code" href="structthread__db__info.html#a152d1cf5158bfed758f0b4c95f1be4cf">td_ta_map_lwp2thr_p</a> = <a class="code" href="linux-thread-db_8c.html#aa4e1f9486849e12810fa2b814c0caee0">verbose_dlsym</a> (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>,
<a name="l00779"></a>00779                                              <span class="stringliteral">&quot;td_ta_map_lwp2thr&quot;</span>);
<a name="l00780"></a>00780   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#a152d1cf5158bfed758f0b4c95f1be4cf">td_ta_map_lwp2thr_p</a> == NULL)
<a name="l00781"></a>00781     <span class="keywordflow">return</span> 0;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783   info-&gt;<a class="code" href="structthread__db__info.html#a9edb87203f74a223a1080e449bf43f62">td_ta_thr_iter_p</a> = <a class="code" href="linux-thread-db_8c.html#aa4e1f9486849e12810fa2b814c0caee0">verbose_dlsym</a> (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_ta_thr_iter&quot;</span>);
<a name="l00784"></a>00784   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#a9edb87203f74a223a1080e449bf43f62">td_ta_thr_iter_p</a> == NULL)
<a name="l00785"></a>00785     <span class="keywordflow">return</span> 0;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787   info-&gt;<a class="code" href="structthread__db__info.html#aceb189dfa6dde0481dcf2369a933c123">td_thr_validate_p</a> = <a class="code" href="linux-thread-db_8c.html#aa4e1f9486849e12810fa2b814c0caee0">verbose_dlsym</a> (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_thr_validate&quot;</span>);
<a name="l00788"></a>00788   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#aceb189dfa6dde0481dcf2369a933c123">td_thr_validate_p</a> == NULL)
<a name="l00789"></a>00789     <span class="keywordflow">return</span> 0;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791   info-&gt;<a class="code" href="structthread__db__info.html#a067c8611bf9c894d3691f7cb7bbefdcc">td_thr_get_info_p</a> = <a class="code" href="linux-thread-db_8c.html#aa4e1f9486849e12810fa2b814c0caee0">verbose_dlsym</a> (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_thr_get_info&quot;</span>);
<a name="l00792"></a>00792   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#a067c8611bf9c894d3691f7cb7bbefdcc">td_thr_get_info_p</a> == NULL)
<a name="l00793"></a>00793     <span class="keywordflow">return</span> 0;
<a name="l00794"></a>00794 
<a name="l00795"></a>00795   <span class="comment">/* These are not essential.  */</span>
<a name="l00796"></a>00796   info-&gt;<a class="code" href="structthread__db__info.html#ad79f996f977dc0dd57a8dc5eb55eeccc">td_ta_event_addr_p</a> = dlsym (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_ta_event_addr&quot;</span>);
<a name="l00797"></a>00797   info-&gt;<a class="code" href="structthread__db__info.html#ac9cfa2d72dcdbfbf699a591631a01697">td_ta_set_event_p</a> = dlsym (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_ta_set_event&quot;</span>);
<a name="l00798"></a>00798   info-&gt;<a class="code" href="structthread__db__info.html#a812acaf3efe66f429383f91a243b2d01">td_ta_clear_event_p</a> = dlsym (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_ta_clear_event&quot;</span>);
<a name="l00799"></a>00799   info-&gt;<a class="code" href="structthread__db__info.html#aa8b076c6af5ed7412b77fdb540a2b954">td_ta_event_getmsg_p</a> = dlsym (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_ta_event_getmsg&quot;</span>);
<a name="l00800"></a>00800   info-&gt;<a class="code" href="structthread__db__info.html#a33e247512f4590ab36ac442ed3a4c9f3">td_thr_event_enable_p</a> = dlsym (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_thr_event_enable&quot;</span>);
<a name="l00801"></a>00801   info-&gt;<a class="code" href="structthread__db__info.html#ac620454d19987cf45f202b3663bb2e3a">td_thr_tls_get_addr_p</a> = dlsym (info-&gt;<a class="code" href="structthread__db__info.html#a92d090ca4ed28dc4c6fa79f230076392">handle</a>, <span class="stringliteral">&quot;td_thr_tls_get_addr&quot;</span>);
<a name="l00802"></a>00802 
<a name="l00803"></a>00803   <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a12c1570c6d5d65f09ec2e422f049eb49">thread_db_find_new_threads_silently</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>) != 0)
<a name="l00804"></a>00804     {
<a name="l00805"></a>00805       <span class="comment">/* Even if libthread_db initializes, if the thread list is</span>
<a name="l00806"></a>00806 <span class="comment">         corrupted, we&#39;d not manage to list any threads.  Better reject this</span>
<a name="l00807"></a>00807 <span class="comment">         thread_db, and fall back to at least listing LWPs.  */</span>
<a name="l00808"></a>00808       <span class="keywordflow">return</span> 0;
<a name="l00809"></a>00809     }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811   <a class="code" href="utils_8c.html#ad57145632bbcb0361dc1dfa134b1efd0">printf_unfiltered</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;[Thread debugging using libthread_db enabled]\n&quot;</span>));
<a name="l00812"></a>00812 
<a name="l00813"></a>00813   <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">libthread_db_debug</a> || *<a class="code" href="linux-thread-db_8c.html#a2054e81dcf1628d1199ed276e291b4cb">libthread_db_search_path</a>)
<a name="l00814"></a>00814     {
<a name="l00815"></a>00815       <span class="keyword">const</span> <span class="keywordtype">char</span> *library;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817       library = <a class="code" href="linux-thread-db_8c.html#acf15a012b43fdb906be91cbaec39957f">dladdr_to_soname</a> (*info-&gt;<a class="code" href="structthread__db__info.html#a631b014b2215b6784a65df041f588255">td_ta_new_p</a>);
<a name="l00818"></a>00818       <span class="keywordflow">if</span> (library == NULL)
<a name="l00819"></a>00819         library = <a class="code" href="gdb__thread__db_8h.html#a63f76614bb710e85c08c1f9bd2c305d5">LIBTHREAD_DB_SO</a>;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821       <a class="code" href="utils_8c.html#ad57145632bbcb0361dc1dfa134b1efd0">printf_unfiltered</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Using host libthread_db library \&quot;%s\&quot;.\n&quot;</span>),
<a name="l00822"></a>00822                          library);
<a name="l00823"></a>00823     }
<a name="l00824"></a>00824 
<a name="l00825"></a>00825   <span class="comment">/* The thread library was detected.  Activate the thread_db target</span>
<a name="l00826"></a>00826 <span class="comment">     if this is the first process using it.  */</span>
<a name="l00827"></a>00827   <span class="keywordflow">if</span> (thread_db_list-&gt;<a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">next</a> == NULL)
<a name="l00828"></a>00828     <a class="code" href="target_8c.html#ada1b9dc1eeb0546d39b86ba7ac645e67">push_target</a> (&amp;<a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>);
<a name="l00829"></a>00829 
<a name="l00830"></a>00830   <span class="comment">/* Enable event reporting, but not when debugging a core file.  */</span>
<a name="l00831"></a>00831   <span class="keywordflow">if</span> (<a class="code" href="target_8h.html#a85885df22f7c1304269eaba1e1d618b7">target_has_execution</a>)
<a name="l00832"></a>00832     <a class="code" href="linux-thread-db_8c.html#af0d98749063285a4cd59f8a142ff5500">enable_thread_event_reporting</a> ();
<a name="l00833"></a>00833 
<a name="l00834"></a>00834   <span class="keywordflow">return</span> 1;
<a name="l00835"></a>00835 }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837 <span class="comment">/* Attempt to use LIBRARY as libthread_db.  LIBRARY could be absolute,</span>
<a name="l00838"></a>00838 <span class="comment">   relative, or just LIBTHREAD_DB.  */</span>
<a name="l00839"></a>00839 
<a name="l00840"></a>00840 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00841"></a><a class="code" href="linux-thread-db_8c.html#a4e63db3fe15e0ad5b8d82ae0ee972371">00841</a> <a class="code" href="linux-thread-db_8c.html#a4e63db3fe15e0ad5b8d82ae0ee972371">try_thread_db_load</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *library)
<a name="l00842"></a>00842 {
<a name="l00843"></a>00843   <span class="keywordtype">void</span> *handle;
<a name="l00844"></a>00844   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846   <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">libthread_db_debug</a>)
<a name="l00847"></a>00847     <a class="code" href="utils_8c.html#ad57145632bbcb0361dc1dfa134b1efd0">printf_unfiltered</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Trying host libthread_db library: %s.\n&quot;</span>),
<a name="l00848"></a>00848                        library);
<a name="l00849"></a>00849   handle = dlopen (library, RTLD_NOW);
<a name="l00850"></a>00850   <span class="keywordflow">if</span> (handle == NULL)
<a name="l00851"></a>00851     {
<a name="l00852"></a>00852       <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">libthread_db_debug</a>)
<a name="l00853"></a>00853         <a class="code" href="utils_8c.html#ad57145632bbcb0361dc1dfa134b1efd0">printf_unfiltered</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;dlopen failed: %s.\n&quot;</span>), dlerror ());
<a name="l00854"></a>00854       <span class="keywordflow">return</span> 0;
<a name="l00855"></a>00855     }
<a name="l00856"></a>00856 
<a name="l00857"></a>00857   <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">libthread_db_debug</a> &amp;&amp; <a class="code" href="gdb__string_8h.html#adf46aa8f2e08cfb505868bbfc88b5fd4">strchr</a> (library, <span class="charliteral">&#39;/&#39;</span>) == NULL)
<a name="l00858"></a>00858     {
<a name="l00859"></a>00859       <span class="keywordtype">void</span> *<a class="code" href="glibc__thread__db_8h.html#abc8d849640a0e0d2b78f2d4d2c82adca">td_init</a>;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861       td_init = dlsym (handle, <span class="stringliteral">&quot;td_init&quot;</span>);
<a name="l00862"></a>00862       <span class="keywordflow">if</span> (td_init != NULL)
<a name="l00863"></a>00863         {
<a name="l00864"></a>00864           <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> libpath = <a class="code" href="linux-thread-db_8c.html#acf15a012b43fdb906be91cbaec39957f">dladdr_to_soname</a> (td_init);
<a name="l00865"></a>00865 
<a name="l00866"></a>00866           <span class="keywordflow">if</span> (libpath != NULL)
<a name="l00867"></a>00867             <a class="code" href="utils_8c.html#ad57145632bbcb0361dc1dfa134b1efd0">printf_unfiltered</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Host %s resolved to: %s.\n&quot;</span>),
<a name="l00868"></a>00868                                library, libpath);
<a name="l00869"></a>00869         }
<a name="l00870"></a>00870     }
<a name="l00871"></a>00871 
<a name="l00872"></a>00872   info = <a class="code" href="linux-thread-db_8c.html#a70dbfa396e4111ef8d19eb9351ab5273">add_thread_db_info</a> (handle);
<a name="l00873"></a>00873 
<a name="l00874"></a>00874   <span class="comment">/* Do not save system library name, that one is always trusted.  */</span>
<a name="l00875"></a>00875   <span class="keywordflow">if</span> (<a class="code" href="gdb__string_8h.html#adf46aa8f2e08cfb505868bbfc88b5fd4">strchr</a> (library, <span class="charliteral">&#39;/&#39;</span>) != NULL)
<a name="l00876"></a>00876     info-&gt;<a class="code" href="structthread__db__info.html#a4b3b75faab6aa86dc5a525ae3c913d53">filename</a> = <a class="code" href="utils_8c.html#a38e450f9b68243416d35f57e37e23e3e">gdb_realpath</a> (library);
<a name="l00877"></a>00877 
<a name="l00878"></a>00878   <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a888a5b79921bdac5c64db3cac30e6839">try_thread_db_load_1</a> (info))
<a name="l00879"></a>00879     <span class="keywordflow">return</span> 1;
<a name="l00880"></a>00880 
<a name="l00881"></a>00881   <span class="comment">/* This library &quot;refused&quot; to work on current inferior.  */</span>
<a name="l00882"></a>00882   <a class="code" href="linux-thread-db_8c.html#ac1a17b84ff38e1aa271da8a7bb67ae26">delete_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>));
<a name="l00883"></a>00883   <span class="keywordflow">return</span> 0;
<a name="l00884"></a>00884 }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886 <span class="comment">/* Subroutine of try_thread_db_load_from_pdir to simplify it.</span>
<a name="l00887"></a>00887 <span class="comment">   Try loading libthread_db in directory(OBJ)/SUBDIR.</span>
<a name="l00888"></a>00888 <span class="comment">   SUBDIR may be NULL.  It may also be something like &quot;../lib64&quot;.</span>
<a name="l00889"></a>00889 <span class="comment">   The result is true for success.  */</span>
<a name="l00890"></a>00890 
<a name="l00891"></a>00891 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00892"></a><a class="code" href="linux-thread-db_8c.html#a6d3ebca9167204389a9dce9d87e5b6df">00892</a> <a class="code" href="linux-thread-db_8c.html#a6d3ebca9167204389a9dce9d87e5b6df">try_thread_db_load_from_pdir_1</a> (<span class="keyword">struct</span> <a class="code" href="structobjfile.html">objfile</a> *obj, <span class="keyword">const</span> <span class="keywordtype">char</span> *subdir)
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894   <span class="keyword">struct </span><a class="code" href="structcleanup.html">cleanup</a> *<a class="code" href="structcleanup.html">cleanup</a>;
<a name="l00895"></a>00895   <span class="keywordtype">char</span> *path, *cp;
<a name="l00896"></a>00896   <span class="keywordtype">int</span> result;
<a name="l00897"></a>00897   <span class="keyword">const</span> <span class="keywordtype">char</span> *obj_name = <a class="code" href="objfiles_8c.html#a33e548a19b86b293435d3c2d6daaaec6">objfile_name</a> (obj);
<a name="l00898"></a>00898 
<a name="l00899"></a>00899   <span class="keywordflow">if</span> (obj_name[0] != <span class="charliteral">&#39;/&#39;</span>)
<a name="l00900"></a>00900     {
<a name="l00901"></a>00901       <a class="code" href="utils_8c.html#a5fc201a4181499a6b4057a6caa15b5e2">warning</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Expected absolute pathname for libpthread in the&quot;</span>
<a name="l00902"></a>00902                  <span class="stringliteral">&quot; inferior, but got %s.&quot;</span>), obj_name);
<a name="l00903"></a>00903       <span class="keywordflow">return</span> 0;
<a name="l00904"></a>00904     }
<a name="l00905"></a>00905 
<a name="l00906"></a>00906   path = <a class="code" href="common-utils_8c.html#a634d6cd850bb831afebc499579303b3b">xmalloc</a> (strlen (obj_name) + (subdir ? strlen (subdir) + 1 : 0)
<a name="l00907"></a>00907                   + 1 + strlen (<a class="code" href="gdb__thread__db_8h.html#a63f76614bb710e85c08c1f9bd2c305d5">LIBTHREAD_DB_SO</a>) + 1);
<a name="l00908"></a>00908   cleanup = <a class="code" href="cleanups_8c.html#a3d418f8af424aec399898c2d48b26224">make_cleanup</a> (<a class="code" href="common-utils_8c.html#a976e14808b9247ec952c262553f09f8f">xfree</a>, path);
<a name="l00909"></a>00909 
<a name="l00910"></a>00910   strcpy (path, obj_name);
<a name="l00911"></a>00911   cp = <a class="code" href="gdb__string_8h.html#a5cbb8bbfc7174d9468b1853f1031efb3">strrchr</a> (path, <span class="charliteral">&#39;/&#39;</span>);
<a name="l00912"></a>00912   <span class="comment">/* This should at minimum hit the first character.  */</span>
<a name="l00913"></a>00913   <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (cp != NULL);
<a name="l00914"></a>00914   cp[1] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00915"></a>00915   <span class="keywordflow">if</span> (subdir != NULL)
<a name="l00916"></a>00916     {
<a name="l00917"></a>00917       strcat (cp, subdir);
<a name="l00918"></a>00918       strcat (cp, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l00919"></a>00919     }
<a name="l00920"></a>00920   strcat (cp, <a class="code" href="gdb__thread__db_8h.html#a63f76614bb710e85c08c1f9bd2c305d5">LIBTHREAD_DB_SO</a>);
<a name="l00921"></a>00921 
<a name="l00922"></a>00922   <span class="keywordflow">if</span> (!<a class="code" href="auto-load_8c.html#a6650d33055b85086bb79962805e9473a">file_is_auto_load_safe</a> (path, <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;auto-load: Loading libthread-db &quot;</span>
<a name="l00923"></a>00923                                        <span class="stringliteral">&quot;library \&quot;%s\&quot; from $pdir.\n&quot;</span>),
<a name="l00924"></a>00924                                path))
<a name="l00925"></a>00925     result = 0;
<a name="l00926"></a>00926   <span class="keywordflow">else</span>
<a name="l00927"></a>00927     result = <a class="code" href="linux-thread-db_8c.html#a4e63db3fe15e0ad5b8d82ae0ee972371">try_thread_db_load</a> (path);
<a name="l00928"></a>00928 
<a name="l00929"></a>00929   <a class="code" href="cleanups_8c.html#a8b313a4f1c613973ea444e5fa54976f8">do_cleanups</a> (cleanup);
<a name="l00930"></a>00930   <span class="keywordflow">return</span> result;
<a name="l00931"></a>00931 }
<a name="l00932"></a>00932 
<a name="l00933"></a>00933 <span class="comment">/* Handle $pdir in libthread-db-search-path.</span>
<a name="l00934"></a>00934 <span class="comment">   Look for libthread_db in directory(libpthread)/SUBDIR.</span>
<a name="l00935"></a>00935 <span class="comment">   SUBDIR may be NULL.  It may also be something like &quot;../lib64&quot;.</span>
<a name="l00936"></a>00936 <span class="comment">   The result is true for success.  */</span>
<a name="l00937"></a>00937 
<a name="l00938"></a>00938 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00939"></a><a class="code" href="linux-thread-db_8c.html#a7dd5754deeb6f8e31e96809325d1b119">00939</a> <a class="code" href="linux-thread-db_8c.html#a7dd5754deeb6f8e31e96809325d1b119">try_thread_db_load_from_pdir</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *subdir)
<a name="l00940"></a>00940 {
<a name="l00941"></a>00941   <span class="keyword">struct </span><a class="code" href="structobjfile.html">objfile</a> *obj;
<a name="l00942"></a>00942 
<a name="l00943"></a>00943   <span class="keywordflow">if</span> (!<a class="code" href="linux-thread-db_8c.html#a01cc116c4ab0d79fcc2f0900819c4319">auto_load_thread_db</a>)
<a name="l00944"></a>00944     <span class="keywordflow">return</span> 0;
<a name="l00945"></a>00945 
<a name="l00946"></a>00946   <a class="code" href="objfiles_8h.html#a8efee3b85a322006131a6056d45058b3">ALL_OBJFILES</a> (obj)
<a name="l00947"></a>00947     <span class="keywordflow">if</span> (<a class="code" href="solib_8c.html#a730831d780c97d26ddb786cd05f6052a">libpthread_name_p</a> (<a class="code" href="objfiles_8c.html#a33e548a19b86b293435d3c2d6daaaec6">objfile_name</a> (obj)))
<a name="l00948"></a>00948       {
<a name="l00949"></a>00949         <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a6d3ebca9167204389a9dce9d87e5b6df">try_thread_db_load_from_pdir_1</a> (obj, subdir))
<a name="l00950"></a>00950           <span class="keywordflow">return</span> 1;
<a name="l00951"></a>00951 
<a name="l00952"></a>00952         <span class="comment">/* We may have found the separate-debug-info version of</span>
<a name="l00953"></a>00953 <span class="comment">           libpthread, and it may live in a directory without a matching</span>
<a name="l00954"></a>00954 <span class="comment">           libthread_db.  */</span>
<a name="l00955"></a>00955         <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="structobjfile.html#a1ef5fed06f7a9c5864c9a0ce46a87710">separate_debug_objfile_backlink</a> != NULL)
<a name="l00956"></a>00956           <span class="keywordflow">return</span> <a class="code" href="linux-thread-db_8c.html#a6d3ebca9167204389a9dce9d87e5b6df">try_thread_db_load_from_pdir_1</a> (obj-&gt;<a class="code" href="structobjfile.html#a1ef5fed06f7a9c5864c9a0ce46a87710">separate_debug_objfile_backlink</a>,
<a name="l00957"></a>00957                                                  subdir);
<a name="l00958"></a>00958 
<a name="l00959"></a>00959         <span class="keywordflow">return</span> 0;
<a name="l00960"></a>00960       }
<a name="l00961"></a>00961 
<a name="l00962"></a>00962   <span class="keywordflow">return</span> 0;
<a name="l00963"></a>00963 }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965 <span class="comment">/* Handle $sdir in libthread-db-search-path.</span>
<a name="l00966"></a>00966 <span class="comment">   Look for libthread_db in the system dirs, or wherever a plain</span>
<a name="l00967"></a>00967 <span class="comment">   dlopen(file_without_path) will look.</span>
<a name="l00968"></a>00968 <span class="comment">   The result is true for success.  */</span>
<a name="l00969"></a>00969 
<a name="l00970"></a>00970 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00971"></a><a class="code" href="linux-thread-db_8c.html#ac63a223b4c92d8be7e9c9b4d01b715ea">00971</a> <a class="code" href="linux-thread-db_8c.html#ac63a223b4c92d8be7e9c9b4d01b715ea">try_thread_db_load_from_sdir</a> (<span class="keywordtype">void</span>)
<a name="l00972"></a>00972 {
<a name="l00973"></a>00973   <span class="keywordflow">return</span> <a class="code" href="linux-thread-db_8c.html#a4e63db3fe15e0ad5b8d82ae0ee972371">try_thread_db_load</a> (<a class="code" href="gdb__thread__db_8h.html#a63f76614bb710e85c08c1f9bd2c305d5">LIBTHREAD_DB_SO</a>);
<a name="l00974"></a>00974 }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976 <span class="comment">/* Try to load libthread_db from directory DIR of length DIR_LEN.</span>
<a name="l00977"></a>00977 <span class="comment">   The result is true for success.  */</span>
<a name="l00978"></a>00978 
<a name="l00979"></a>00979 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00980"></a><a class="code" href="linux-thread-db_8c.html#ae3b49b2a7edea3a824bdd8976adb781f">00980</a> <a class="code" href="linux-thread-db_8c.html#ae3b49b2a7edea3a824bdd8976adb781f">try_thread_db_load_from_dir</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keywordtype">size_t</span> dir_len)
<a name="l00981"></a>00981 {
<a name="l00982"></a>00982   <span class="keyword">struct </span><a class="code" href="structcleanup.html">cleanup</a> *<a class="code" href="structcleanup.html">cleanup</a>;
<a name="l00983"></a>00983   <span class="keywordtype">char</span> *path;
<a name="l00984"></a>00984   <span class="keywordtype">int</span> result;
<a name="l00985"></a>00985 
<a name="l00986"></a>00986   <span class="keywordflow">if</span> (!<a class="code" href="linux-thread-db_8c.html#a01cc116c4ab0d79fcc2f0900819c4319">auto_load_thread_db</a>)
<a name="l00987"></a>00987     <span class="keywordflow">return</span> 0;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989   path = <a class="code" href="common-utils_8c.html#a634d6cd850bb831afebc499579303b3b">xmalloc</a> (dir_len + 1 + strlen (<a class="code" href="gdb__thread__db_8h.html#a63f76614bb710e85c08c1f9bd2c305d5">LIBTHREAD_DB_SO</a>) + 1);
<a name="l00990"></a>00990   cleanup = <a class="code" href="cleanups_8c.html#a3d418f8af424aec399898c2d48b26224">make_cleanup</a> (<a class="code" href="common-utils_8c.html#a976e14808b9247ec952c262553f09f8f">xfree</a>, path);
<a name="l00991"></a>00991 
<a name="l00992"></a>00992   <a class="code" href="gdb__string_8h.html#a39ebe6a4e122707997e78b549a1e8c5e">memcpy</a> (path, dir, dir_len);
<a name="l00993"></a>00993   path[dir_len] = <span class="charliteral">&#39;/&#39;</span>;
<a name="l00994"></a>00994   strcpy (path + dir_len + 1, <a class="code" href="gdb__thread__db_8h.html#a63f76614bb710e85c08c1f9bd2c305d5">LIBTHREAD_DB_SO</a>);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996   <span class="keywordflow">if</span> (!<a class="code" href="auto-load_8c.html#a6650d33055b85086bb79962805e9473a">file_is_auto_load_safe</a> (path, <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;auto-load: Loading libthread-db &quot;</span>
<a name="l00997"></a>00997                                        <span class="stringliteral">&quot;library \&quot;%s\&quot; from explicit &quot;</span>
<a name="l00998"></a>00998                                        <span class="stringliteral">&quot;directory.\n&quot;</span>),
<a name="l00999"></a>00999                                path))
<a name="l01000"></a>01000     result = 0;
<a name="l01001"></a>01001   <span class="keywordflow">else</span>
<a name="l01002"></a>01002     result = <a class="code" href="linux-thread-db_8c.html#a4e63db3fe15e0ad5b8d82ae0ee972371">try_thread_db_load</a> (path);
<a name="l01003"></a>01003 
<a name="l01004"></a>01004   <a class="code" href="cleanups_8c.html#a8b313a4f1c613973ea444e5fa54976f8">do_cleanups</a> (cleanup);
<a name="l01005"></a>01005   <span class="keywordflow">return</span> result;
<a name="l01006"></a>01006 }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008 <span class="comment">/* Search libthread_db_search_path for libthread_db which &quot;agrees&quot;</span>
<a name="l01009"></a>01009 <span class="comment">   to work on current inferior.</span>
<a name="l01010"></a>01010 <span class="comment">   The result is true for success.  */</span>
<a name="l01011"></a>01011 
<a name="l01012"></a>01012 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01013"></a><a class="code" href="linux-thread-db_8c.html#add48a80851377c961e82419cf8f353cb">01013</a> <a class="code" href="linux-thread-db_8c.html#add48a80851377c961e82419cf8f353cb">thread_db_load_search</a> (<span class="keywordtype">void</span>)
<a name="l01014"></a>01014 {
<a name="l01015"></a>01015   <a class="code" href="vec_8h.html#ab084f6f29fcf16a6b15d15feb653d414">VEC</a> (<a class="code" href="gdb__vecs_8h.html#a5ea7d3fefa2144d9bddaf2053c9691a1">char_ptr</a>) *dir_vec;
<a name="l01016"></a>01016   <span class="keyword">struct </span><a class="code" href="structcleanup.html">cleanup</a> *cleanups;
<a name="l01017"></a>01017   <span class="keywordtype">char</span> *this_dir;
<a name="l01018"></a>01018   <span class="keywordtype">int</span> i, rc = 0;
<a name="l01019"></a>01019 
<a name="l01020"></a>01020   dir_vec = dirnames_to_char_ptr_vec (<a class="code" href="linux-thread-db_8c.html#a2054e81dcf1628d1199ed276e291b4cb">libthread_db_search_path</a>);
<a name="l01021"></a>01021   cleanups = <a class="code" href="gdb__vecs_8h.html#af53fe09ad19fcfb980ef5c908b3daa20">make_cleanup_free_char_ptr_vec</a> (dir_vec);
<a name="l01022"></a>01022 
<a name="l01023"></a>01023   <span class="keywordflow">for</span> (i = 0; <a class="code" href="vec_8h.html#ae7795b0c8e65f45eb49aac5ec2c0fa52">VEC_iterate</a> (<a class="code" href="gdb__vecs_8h.html#a5ea7d3fefa2144d9bddaf2053c9691a1">char_ptr</a>, dir_vec, i, this_dir); ++i)
<a name="l01024"></a>01024     {
<a name="l01025"></a>01025       <span class="keyword">const</span> <span class="keywordtype">int</span> pdir_len = <span class="keyword">sizeof</span> (<span class="stringliteral">&quot;$pdir&quot;</span>) - 1;
<a name="l01026"></a>01026       <span class="keywordtype">size_t</span> this_dir_len;
<a name="l01027"></a>01027 
<a name="l01028"></a>01028       this_dir_len = strlen (this_dir);
<a name="l01029"></a>01029 
<a name="l01030"></a>01030       <span class="keywordflow">if</span> (strncmp (this_dir, <span class="stringliteral">&quot;$pdir&quot;</span>, pdir_len) == 0
<a name="l01031"></a>01031           &amp;&amp; (this_dir[pdir_len] == <span class="charliteral">&#39;\0&#39;</span>
<a name="l01032"></a>01032               || this_dir[pdir_len] == <span class="charliteral">&#39;/&#39;</span>))
<a name="l01033"></a>01033         {
<a name="l01034"></a>01034           <span class="keywordtype">char</span> *subdir = NULL;
<a name="l01035"></a>01035           <span class="keyword">struct </span><a class="code" href="structcleanup.html">cleanup</a> *free_subdir_cleanup
<a name="l01036"></a>01036             = <a class="code" href="cleanups_8c.html#a3d418f8af424aec399898c2d48b26224">make_cleanup</a> (<a class="code" href="cleanups_8c.html#a1ec2a3980c2be1f31f2142103d1f7abf">null_cleanup</a>, NULL);
<a name="l01037"></a>01037 
<a name="l01038"></a>01038           <span class="keywordflow">if</span> (this_dir[pdir_len] == <span class="charliteral">&#39;/&#39;</span>)
<a name="l01039"></a>01039             {
<a name="l01040"></a>01040               subdir = <a class="code" href="common-utils_8c.html#a634d6cd850bb831afebc499579303b3b">xmalloc</a> (strlen (this_dir));
<a name="l01041"></a>01041               <a class="code" href="cleanups_8c.html#a3d418f8af424aec399898c2d48b26224">make_cleanup</a> (<a class="code" href="common-utils_8c.html#a976e14808b9247ec952c262553f09f8f">xfree</a>, subdir);
<a name="l01042"></a>01042               strcpy (subdir, this_dir + pdir_len + 1);
<a name="l01043"></a>01043             }
<a name="l01044"></a>01044           rc = <a class="code" href="linux-thread-db_8c.html#a7dd5754deeb6f8e31e96809325d1b119">try_thread_db_load_from_pdir</a> (subdir);
<a name="l01045"></a>01045           <a class="code" href="cleanups_8c.html#a8b313a4f1c613973ea444e5fa54976f8">do_cleanups</a> (free_subdir_cleanup);
<a name="l01046"></a>01046           <span class="keywordflow">if</span> (rc)
<a name="l01047"></a>01047             <span class="keywordflow">break</span>;
<a name="l01048"></a>01048         }
<a name="l01049"></a>01049       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (this_dir, <span class="stringliteral">&quot;$sdir&quot;</span>) == 0)
<a name="l01050"></a>01050         {
<a name="l01051"></a>01051           <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#ac63a223b4c92d8be7e9c9b4d01b715ea">try_thread_db_load_from_sdir</a> ())
<a name="l01052"></a>01052             {
<a name="l01053"></a>01053               rc = 1;
<a name="l01054"></a>01054               <span class="keywordflow">break</span>;
<a name="l01055"></a>01055             }
<a name="l01056"></a>01056         }
<a name="l01057"></a>01057       <span class="keywordflow">else</span>
<a name="l01058"></a>01058         {
<a name="l01059"></a>01059           <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#ae3b49b2a7edea3a824bdd8976adb781f">try_thread_db_load_from_dir</a> (this_dir, this_dir_len))
<a name="l01060"></a>01060             {
<a name="l01061"></a>01061               rc = 1;
<a name="l01062"></a>01062               <span class="keywordflow">break</span>;
<a name="l01063"></a>01063             }
<a name="l01064"></a>01064         }
<a name="l01065"></a>01065     }
<a name="l01066"></a>01066 
<a name="l01067"></a>01067   <a class="code" href="cleanups_8c.html#a8b313a4f1c613973ea444e5fa54976f8">do_cleanups</a> (cleanups);
<a name="l01068"></a>01068   <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">libthread_db_debug</a>)
<a name="l01069"></a>01069     <a class="code" href="utils_8c.html#ad57145632bbcb0361dc1dfa134b1efd0">printf_unfiltered</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;thread_db_load_search returning %d\n&quot;</span>), rc);
<a name="l01070"></a>01070   <span class="keywordflow">return</span> rc;
<a name="l01071"></a>01071 }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073 <span class="comment">/* Return non-zero if the inferior has a libpthread.  */</span>
<a name="l01074"></a>01074 
<a name="l01075"></a>01075 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01076"></a><a class="code" href="linux-thread-db_8c.html#aa96a85eb3ad081c9ebb23802e6804a2e">01076</a> <a class="code" href="linux-thread-db_8c.html#aa96a85eb3ad081c9ebb23802e6804a2e">has_libpthread</a> (<span class="keywordtype">void</span>)
<a name="l01077"></a>01077 {
<a name="l01078"></a>01078   <span class="keyword">struct </span><a class="code" href="structobjfile.html">objfile</a> *obj;
<a name="l01079"></a>01079 
<a name="l01080"></a>01080   <a class="code" href="objfiles_8h.html#a8efee3b85a322006131a6056d45058b3">ALL_OBJFILES</a> (obj)
<a name="l01081"></a>01081     <span class="keywordflow">if</span> (<a class="code" href="solib_8c.html#a730831d780c97d26ddb786cd05f6052a">libpthread_name_p</a> (<a class="code" href="objfiles_8c.html#a33e548a19b86b293435d3c2d6daaaec6">objfile_name</a> (obj)))
<a name="l01082"></a>01082       <span class="keywordflow">return</span> 1;
<a name="l01083"></a>01083 
<a name="l01084"></a>01084   <span class="keywordflow">return</span> 0;
<a name="l01085"></a>01085 }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087 <span class="comment">/* Attempt to load and initialize libthread_db.</span>
<a name="l01088"></a>01088 <span class="comment">   Return 1 on success.  */</span>
<a name="l01089"></a>01089 
<a name="l01090"></a>01090 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01091"></a><a class="code" href="linux-thread-db_8c.html#a06a9d4489628f44a83467c3208fa2794">01091</a> <a class="code" href="linux-thread-db_8c.html#a06a9d4489628f44a83467c3208fa2794">thread_db_load</a> (<span class="keywordtype">void</span>)
<a name="l01092"></a>01092 {
<a name="l01093"></a>01093   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l01094"></a>01094 
<a name="l01095"></a>01095   info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>));
<a name="l01096"></a>01096 
<a name="l01097"></a>01097   <span class="keywordflow">if</span> (info != NULL)
<a name="l01098"></a>01098     <span class="keywordflow">return</span> 1;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100   <span class="comment">/* Don&#39;t attempt to use thread_db on executables not running</span>
<a name="l01101"></a>01101 <span class="comment">     yet.  */</span>
<a name="l01102"></a>01102   <span class="keywordflow">if</span> (!<a class="code" href="target_8h.html#aa9a1009541e63ce36c030b1bd55d292d">target_has_registers</a>)
<a name="l01103"></a>01103     <span class="keywordflow">return</span> 0;
<a name="l01104"></a>01104 
<a name="l01105"></a>01105   <span class="comment">/* Don&#39;t attempt to use thread_db for remote targets.  */</span>
<a name="l01106"></a>01106   <span class="keywordflow">if</span> (!(<a class="code" href="target_8h.html#a3c4e5f34cf395eb36ae58b0c47fd1c53">target_can_run</a> (&amp;<a class="code" href="target_8h.html#a2d8640b030266b58d3821eb5cfd112b9">current_target</a>) || <a class="code" href="corefile_8c.html#a72e25d93e38aa67b48f9b0bdd2551fae">core_bfd</a>))
<a name="l01107"></a>01107     <span class="keywordflow">return</span> 0;
<a name="l01108"></a>01108 
<a name="l01109"></a>01109   <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#add48a80851377c961e82419cf8f353cb">thread_db_load_search</a> ())
<a name="l01110"></a>01110     <span class="keywordflow">return</span> 1;
<a name="l01111"></a>01111 
<a name="l01112"></a>01112   <span class="comment">/* We couldn&#39;t find a libthread_db.</span>
<a name="l01113"></a>01113 <span class="comment">     If the inferior has a libpthread warn the user.  */</span>
<a name="l01114"></a>01114   <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#aa96a85eb3ad081c9ebb23802e6804a2e">has_libpthread</a> ())
<a name="l01115"></a>01115     {
<a name="l01116"></a>01116       <a class="code" href="utils_8c.html#a5fc201a4181499a6b4057a6caa15b5e2">warning</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Unable to find libthread_db matching inferior&#39;s thread&quot;</span>
<a name="l01117"></a>01117                  <span class="stringliteral">&quot; library, thread debugging will not be available.&quot;</span>));
<a name="l01118"></a>01118       <span class="keywordflow">return</span> 0;
<a name="l01119"></a>01119     }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121   <span class="comment">/* Either this executable isn&#39;t using libpthread at all, or it is</span>
<a name="l01122"></a>01122 <span class="comment">     statically linked.  Since we can&#39;t easily distinguish these two cases,</span>
<a name="l01123"></a>01123 <span class="comment">     no warning is issued.  */</span>
<a name="l01124"></a>01124   <span class="keywordflow">return</span> 0;
<a name="l01125"></a>01125 }
<a name="l01126"></a>01126 
<a name="l01127"></a>01127 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01128"></a><a class="code" href="linux-thread-db_8c.html#a23aa8c442908cde315fa6ba6f714057b">01128</a> <a class="code" href="linux-thread-db_8c.html#a23aa8c442908cde315fa6ba6f714057b">disable_thread_event_reporting</a> (<span class="keyword">struct</span> <a class="code" href="structthread__db__info.html">thread_db_info</a> *info)
<a name="l01129"></a>01129 {
<a name="l01130"></a>01130   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#a812acaf3efe66f429383f91a243b2d01">td_ta_clear_event_p</a> != NULL)
<a name="l01131"></a>01131     {
<a name="l01132"></a>01132       <a class="code" href="structtd__thr__events.html">td_thr_events_t</a> events;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134       <span class="comment">/* Set the process wide mask saying we aren&#39;t interested in any</span>
<a name="l01135"></a>01135 <span class="comment">         events anymore.  */</span>
<a name="l01136"></a>01136       <a class="code" href="glibc__thread__db_8h.html#a3f76aaf28db608aabea9049363c5beca">td_event_fillset</a> (&amp;events);
<a name="l01137"></a>01137       info-&gt;<a class="code" href="structthread__db__info.html#a812acaf3efe66f429383f91a243b2d01">td_ta_clear_event_p</a> (info-&gt;<a class="code" href="structthread__db__info.html#a9be1d106fa5bde24113c74810bf47324">thread_agent</a>, &amp;events);
<a name="l01138"></a>01138     }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140   info-&gt;<a class="code" href="structthread__db__info.html#a20fc4977322c8f3c080e5d7b4c2d6a94">td_create_bp_addr</a> = 0;
<a name="l01141"></a>01141   info-&gt;<a class="code" href="structthread__db__info.html#a68dd60e8331b9ba6c935e294944024d9">td_death_bp_addr</a> = 0;
<a name="l01142"></a>01142 }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01145"></a><a class="code" href="linux-thread-db_8c.html#a4909201be099fccf29a3eb3f171ec899">01145</a> <a class="code" href="linux-thread-db_8c.html#a4909201be099fccf29a3eb3f171ec899">check_thread_signals</a> (<span class="keywordtype">void</span>)
<a name="l01146"></a>01146 {
<a name="l01147"></a>01147   <span class="keywordflow">if</span> (!<a class="code" href="linux-thread-db_8c.html#a54b9746bb61464735407c2afd2d3fffe">thread_signals</a>)
<a name="l01148"></a>01148     {
<a name="l01149"></a>01149       sigset_t mask;
<a name="l01150"></a>01150       <span class="keywordtype">int</span> i;
<a name="l01151"></a>01151 
<a name="l01152"></a>01152       <a class="code" href="linux-nat_8c.html#a50db10d09b8a2ddadb2d2b7d710d021a">lin_thread_get_thread_signals</a> (&amp;mask);
<a name="l01153"></a>01153       sigemptyset (&amp;<a class="code" href="linux-thread-db_8c.html#a314cf2c3e450a2a0775f9845ed0fabb3">thread_stop_set</a>);
<a name="l01154"></a>01154       sigemptyset (&amp;<a class="code" href="linux-thread-db_8c.html#a1810f40c2a07c86bf5dde284aa4ed048">thread_print_set</a>);
<a name="l01155"></a>01155 
<a name="l01156"></a>01156       <span class="keywordflow">for</span> (i = 1; i &lt; NSIG; i++)
<a name="l01157"></a>01157         {
<a name="l01158"></a>01158           <span class="keywordflow">if</span> (sigismember (&amp;mask, i))
<a name="l01159"></a>01159             {
<a name="l01160"></a>01160               <span class="keywordflow">if</span> (<a class="code" href="inferior_8h.html#ab29c3343ca4d995c5792537f2dcd5573">signal_stop_update</a> (<a class="code" href="gdb__signals_8h.html#a11fcc2899ec63af2c688695243202f1a">gdb_signal_from_host</a> (i), 0))
<a name="l01161"></a>01161                 sigaddset (&amp;<a class="code" href="linux-thread-db_8c.html#a314cf2c3e450a2a0775f9845ed0fabb3">thread_stop_set</a>, i);
<a name="l01162"></a>01162               <span class="keywordflow">if</span> (<a class="code" href="inferior_8h.html#a899b91e8e61f80f63274c33c1842c60a">signal_print_update</a> (<a class="code" href="gdb__signals_8h.html#a11fcc2899ec63af2c688695243202f1a">gdb_signal_from_host</a> (i), 0))
<a name="l01163"></a>01163                 sigaddset (&amp;<a class="code" href="linux-thread-db_8c.html#a1810f40c2a07c86bf5dde284aa4ed048">thread_print_set</a>, i);
<a name="l01164"></a>01164               <a class="code" href="linux-thread-db_8c.html#a54b9746bb61464735407c2afd2d3fffe">thread_signals</a> = 1;
<a name="l01165"></a>01165             }
<a name="l01166"></a>01166         }
<a name="l01167"></a>01167     }
<a name="l01168"></a>01168 }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170 <span class="comment">/* Check whether thread_db is usable.  This function is called when</span>
<a name="l01171"></a>01171 <span class="comment">   an inferior is created (or otherwise acquired, e.g. attached to)</span>
<a name="l01172"></a>01172 <span class="comment">   and when new shared libraries are loaded into a running process.  */</span>
<a name="l01173"></a>01173 
<a name="l01174"></a>01174 <span class="keywordtype">void</span>
<a name="l01175"></a><a class="code" href="linux-thread-db_8c.html#a653cfac1b0c11316e37be8a732176e49">01175</a> <a class="code" href="linux-nat_8h.html#a653cfac1b0c11316e37be8a732176e49">check_for_thread_db</a> (<span class="keywordtype">void</span>)
<a name="l01176"></a>01176 {
<a name="l01177"></a>01177   <span class="comment">/* Do nothing if we couldn&#39;t load libthread_db.so.1.  */</span>
<a name="l01178"></a>01178   <span class="keywordflow">if</span> (!<a class="code" href="linux-thread-db_8c.html#a06a9d4489628f44a83467c3208fa2794">thread_db_load</a> ())
<a name="l01179"></a>01179     <span class="keywordflow">return</span>;
<a name="l01180"></a>01180 }
<a name="l01181"></a>01181 
<a name="l01182"></a>01182 <span class="comment">/* This function is called via the new_objfile observer.  */</span>
<a name="l01183"></a>01183 
<a name="l01184"></a>01184 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01185"></a><a class="code" href="linux-thread-db_8c.html#a0eb3ce0efe42eeb8c3036557078b4067">01185</a> <a class="code" href="linux-thread-db_8c.html#a0eb3ce0efe42eeb8c3036557078b4067">thread_db_new_objfile</a> (<span class="keyword">struct</span> <a class="code" href="structobjfile.html">objfile</a> *<a class="code" href="structobjfile.html">objfile</a>)
<a name="l01186"></a>01186 {
<a name="l01187"></a>01187   <span class="comment">/* This observer must always be called with inferior_ptid set</span>
<a name="l01188"></a>01188 <span class="comment">     correctly.  */</span>
<a name="l01189"></a>01189 
<a name="l01190"></a>01190   <span class="keywordflow">if</span> (objfile != NULL
<a name="l01191"></a>01191       <span class="comment">/* libpthread with separate debug info has its debug info file already</span>
<a name="l01192"></a>01192 <span class="comment">         loaded (and notified without successful thread_db initialization)</span>
<a name="l01193"></a>01193 <span class="comment">         the time observer_notify_new_objfile is called for the library itself.</span>
<a name="l01194"></a>01194 <span class="comment">         Static executables have their separate debug info loaded already</span>
<a name="l01195"></a>01195 <span class="comment">         before the inferior has started.  */</span>
<a name="l01196"></a>01196       &amp;&amp; objfile-&gt;<a class="code" href="structobjfile.html#a1ef5fed06f7a9c5864c9a0ce46a87710">separate_debug_objfile_backlink</a> == NULL
<a name="l01197"></a>01197       <span class="comment">/* Only check for thread_db if we loaded libpthread,</span>
<a name="l01198"></a>01198 <span class="comment">         or if this is the main symbol file.</span>
<a name="l01199"></a>01199 <span class="comment">         We need to check OBJF_MAINLINE to handle the case of debugging</span>
<a name="l01200"></a>01200 <span class="comment">         a statically linked executable AND the symbol file is specified AFTER</span>
<a name="l01201"></a>01201 <span class="comment">         the exec file is loaded (e.g., gdb -c core ; file foo).</span>
<a name="l01202"></a>01202 <span class="comment">         For dynamically linked executables, libpthread can be near the end</span>
<a name="l01203"></a>01203 <span class="comment">         of the list of shared libraries to load, and in an app of several</span>
<a name="l01204"></a>01204 <span class="comment">         thousand shared libraries, this can otherwise be painful.  */</span>
<a name="l01205"></a>01205       &amp;&amp; ((objfile-&gt;<a class="code" href="structobjfile.html#a07578e542db3b2a277e146b24adf007e">flags</a> &amp; <a class="code" href="objfiles_8h.html#a49e1b6e4f55e359a5db774c025464509">OBJF_MAINLINE</a>) != 0
<a name="l01206"></a>01206           || <a class="code" href="solib_8c.html#a730831d780c97d26ddb786cd05f6052a">libpthread_name_p</a> (<a class="code" href="objfiles_8c.html#a33e548a19b86b293435d3c2d6daaaec6">objfile_name</a> (objfile))))
<a name="l01207"></a>01207     <a class="code" href="linux-nat_8h.html#a653cfac1b0c11316e37be8a732176e49">check_for_thread_db</a> ();
<a name="l01208"></a>01208 }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210 <span class="comment">/* This function is called via the inferior_created observer.</span>
<a name="l01211"></a>01211 <span class="comment">   This handles the case of debugging statically linked executables.  */</span>
<a name="l01212"></a>01212 
<a name="l01213"></a>01213 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01214"></a><a class="code" href="linux-thread-db_8c.html#ae4936e2ac95d8fcaaef8ad1766fea589">01214</a> <a class="code" href="linux-thread-db_8c.html#ae4936e2ac95d8fcaaef8ad1766fea589">thread_db_inferior_created</a> (<span class="keyword">struct</span> <a class="code" href="structtarget__ops.html">target_ops</a> *target, <span class="keywordtype">int</span> from_tty)
<a name="l01215"></a>01215 {
<a name="l01216"></a>01216   <a class="code" href="linux-nat_8h.html#a653cfac1b0c11316e37be8a732176e49">check_for_thread_db</a> ();
<a name="l01217"></a>01217 }
<a name="l01218"></a>01218 
<a name="l01219"></a>01219 <span class="comment">/* Attach to a new thread.  This function is called when we receive a</span>
<a name="l01220"></a>01220 <span class="comment">   TD_CREATE event or when we iterate over all threads and find one</span>
<a name="l01221"></a>01221 <span class="comment">   that wasn&#39;t already in our list.  Returns true on success.  */</span>
<a name="l01222"></a>01222 
<a name="l01223"></a>01223 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01224"></a><a class="code" href="linux-thread-db_8c.html#af3122c68a24f28d6605a3356660c7b64">01224</a> <a class="code" href="linux-thread-db_8c.html#af3122c68a24f28d6605a3356660c7b64">attach_thread</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>, <span class="keyword">const</span> <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> *th_p,
<a name="l01225"></a>01225                <span class="keyword">const</span> <a class="code" href="structtd__thrinfo.html">td_thrinfo_t</a> *ti_p)
<a name="l01226"></a>01226 {
<a name="l01227"></a>01227   <span class="keyword">struct </span><a class="code" href="structprivate__thread__info.html">private_thread_info</a> *<span class="keyword">private</span>;
<a name="l01228"></a>01228   <span class="keyword">struct </span><a class="code" href="structthread__info.html">thread_info</a> *tp;
<a name="l01229"></a>01229   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err;
<a name="l01230"></a>01230   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l01231"></a>01231 
<a name="l01232"></a>01232   <span class="comment">/* If we&#39;re being called after a TD_CREATE event, we may already</span>
<a name="l01233"></a>01233 <span class="comment">     know about this thread.  There are two ways this can happen.  We</span>
<a name="l01234"></a>01234 <span class="comment">     may have iterated over all threads between the thread creation</span>
<a name="l01235"></a>01235 <span class="comment">     and the TD_CREATE event, for instance when the user has issued</span>
<a name="l01236"></a>01236 <span class="comment">     the `info threads&#39; command before the SIGTRAP for hitting the</span>
<a name="l01237"></a>01237 <span class="comment">     thread creation breakpoint was reported.  Alternatively, the</span>
<a name="l01238"></a>01238 <span class="comment">     thread may have exited and a new one been created with the same</span>
<a name="l01239"></a>01239 <span class="comment">     thread ID.  In the first case we don&#39;t need to do anything; in</span>
<a name="l01240"></a>01240 <span class="comment">     the second case we should discard information about the dead</span>
<a name="l01241"></a>01241 <span class="comment">     thread and attach to the new one.  */</span>
<a name="l01242"></a>01242   tp = <a class="code" href="gdbthread_8h.html#ac9a7f4c3c173f717f0da44f83745384c">find_thread_ptid</a> (ptid);
<a name="l01243"></a>01243   <span class="keywordflow">if</span> (tp != NULL)
<a name="l01244"></a>01244     {
<a name="l01245"></a>01245       <span class="comment">/* If tp-&gt;private is NULL, then GDB is already attached to this</span>
<a name="l01246"></a>01246 <span class="comment">         thread, but we do not know anything about it.  We can learn</span>
<a name="l01247"></a>01247 <span class="comment">         about it here.  This can only happen if we have some other</span>
<a name="l01248"></a>01248 <span class="comment">         way besides libthread_db to notice new threads (i.e.</span>
<a name="l01249"></a>01249 <span class="comment">         PTRACE_EVENT_CLONE); assume the same mechanism notices thread</span>
<a name="l01250"></a>01250 <span class="comment">         exit, so this can not be a stale thread recreated with the</span>
<a name="l01251"></a>01251 <span class="comment">         same ID.  */</span>
<a name="l01252"></a>01252       <span class="keywordflow">if</span> (tp-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a> != NULL)
<a name="l01253"></a>01253         {
<a name="l01254"></a>01254           <span class="keywordflow">if</span> (!tp-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a>-&gt;<a class="code" href="structprivate__thread__info.html#acc64731c2220a4cde05819aadfbe6a44">dying</a>)
<a name="l01255"></a>01255             <span class="keywordflow">return</span> 0;
<a name="l01256"></a>01256 
<a name="l01257"></a>01257           <a class="code" href="gdbthread_8h.html#a8081b2ccccf2e2cdce0c21c93aac0ae0">delete_thread</a> (ptid);
<a name="l01258"></a>01258           tp = NULL;
<a name="l01259"></a>01259         }
<a name="l01260"></a>01260     }
<a name="l01261"></a>01261 
<a name="l01262"></a>01262   <span class="keywordflow">if</span> (<a class="code" href="target_8h.html#a85885df22f7c1304269eaba1e1d618b7">target_has_execution</a>)
<a name="l01263"></a>01263     <a class="code" href="linux-thread-db_8c.html#a4909201be099fccf29a3eb3f171ec899">check_thread_signals</a> ();
<a name="l01264"></a>01264 
<a name="l01265"></a>01265   <span class="comment">/* Under GNU/Linux, we have to attach to each and every thread.  */</span>
<a name="l01266"></a>01266   <span class="keywordflow">if</span> (<a class="code" href="target_8h.html#a85885df22f7c1304269eaba1e1d618b7">target_has_execution</a>
<a name="l01267"></a>01267       &amp;&amp; tp == NULL)
<a name="l01268"></a>01268     {
<a name="l01269"></a>01269       <span class="keywordtype">int</span> res;
<a name="l01270"></a>01270 
<a name="l01271"></a>01271       res = <a class="code" href="linux-nat_8c.html#a2263e0e1a7e1c505f26e7d38f16b505d">lin_lwp_attach_lwp</a> (<a class="code" href="ptid_8c.html#aa96ee3f6a88626ec36045b4d84e27f79">ptid_build</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid),
<a name="l01272"></a>01272                                             ti_p-&gt;<a class="code" href="structtd__thrinfo.html#a260ea1a3410bad7ac271209bd014b467">ti_lid</a>, 0));
<a name="l01273"></a>01273       <span class="keywordflow">if</span> (res &lt; 0)
<a name="l01274"></a>01274         {
<a name="l01275"></a>01275           <span class="comment">/* Error, stop iterating.  */</span>
<a name="l01276"></a>01276           <span class="keywordflow">return</span> 0;
<a name="l01277"></a>01277         }
<a name="l01278"></a>01278       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt; 0)
<a name="l01279"></a>01279         {
<a name="l01280"></a>01280           <span class="comment">/* Pretend this thread doesn&#39;t exist yet, and keep</span>
<a name="l01281"></a>01281 <span class="comment">             iterating.  */</span>
<a name="l01282"></a>01282           <span class="keywordflow">return</span> 1;
<a name="l01283"></a>01283         }
<a name="l01284"></a>01284 
<a name="l01285"></a>01285       <span class="comment">/* Otherwise, we sucessfully attached to the thread.  */</span>
<a name="l01286"></a>01286     }
<a name="l01287"></a>01287 
<a name="l01288"></a>01288   <span class="comment">/* Construct the thread&#39;s private data.  */</span>
<a name="l01289"></a>01289   <span class="keyword">private</span> = <a class="code" href="common-utils_8c.html#a634d6cd850bb831afebc499579303b3b">xmalloc</a> (<span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structprivate__thread__info.html">private_thread_info</a>));
<a name="l01290"></a>01290   <a class="code" href="gdb__string_8h.html#adb03df3679ce1445e801310614624ccb">memset</a> (<span class="keyword">private</span>, 0, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structprivate__thread__info.html">private_thread_info</a>));
<a name="l01291"></a>01291 
<a name="l01292"></a>01292   <span class="comment">/* A thread ID of zero may mean the thread library has not initialized</span>
<a name="l01293"></a>01293 <span class="comment">     yet.  But we shouldn&#39;t even get here if that&#39;s the case.  FIXME:</span>
<a name="l01294"></a>01294 <span class="comment">     if we change GDB to always have at least one thread in the thread</span>
<a name="l01295"></a>01295 <span class="comment">     list this will have to go somewhere else; maybe private == NULL</span>
<a name="l01296"></a>01296 <span class="comment">     until the thread_db target claims it.  */</span>
<a name="l01297"></a>01297   <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (ti_p-&gt;<a class="code" href="structtd__thrinfo.html#ab80474078af11dda15a23e9a5c4e7a5f">ti_tid</a> != 0);
<a name="l01298"></a>01298   <span class="keyword">private</span>-&gt;th = *th_p;
<a name="l01299"></a>01299   <span class="keyword">private</span>-&gt;tid = ti_p-&gt;<a class="code" href="structtd__thrinfo.html#ab80474078af11dda15a23e9a5c4e7a5f">ti_tid</a>;
<a name="l01300"></a>01300   <span class="keywordflow">if</span> (ti_p-&gt;<a class="code" href="structtd__thrinfo.html#a137890e3133b03a96dd780e93d9109d9">ti_state</a> == <a class="code" href="glibc__thread__db_8h.html#a7e015b84265c7d3667103553d8230d8eae5a95caf13bb3f3138f8c2f7c42a8473">TD_THR_UNKNOWN</a> || ti_p-&gt;<a class="code" href="structtd__thrinfo.html#a137890e3133b03a96dd780e93d9109d9">ti_state</a> == <a class="code" href="glibc__thread__db_8h.html#a7e015b84265c7d3667103553d8230d8eade49dca447c1cd9167eb487102f580b3">TD_THR_ZOMBIE</a>)
<a name="l01301"></a>01301     <span class="keyword">private</span>-&gt;dying = 1;
<a name="l01302"></a>01302 
<a name="l01303"></a>01303   <span class="comment">/* Add the thread to GDB&#39;s thread list.  */</span>
<a name="l01304"></a>01304   <span class="keywordflow">if</span> (tp == NULL)
<a name="l01305"></a>01305     <a class="code" href="gdbthread_8h.html#a0f820634a5e60ef1a241b6b7c08b2830">add_thread_with_info</a> (ptid, <span class="keyword">private</span>);
<a name="l01306"></a>01306   <span class="keywordflow">else</span>
<a name="l01307"></a>01307     tp-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a> = <span class="keyword">private</span>;
<a name="l01308"></a>01308 
<a name="l01309"></a>01309   info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid));
<a name="l01310"></a>01310 
<a name="l01311"></a>01311   <span class="comment">/* Enable thread event reporting for this thread, except when</span>
<a name="l01312"></a>01312 <span class="comment">     debugging a core file.  */</span>
<a name="l01313"></a>01313   <span class="keywordflow">if</span> (<a class="code" href="target_8h.html#a85885df22f7c1304269eaba1e1d618b7">target_has_execution</a>)
<a name="l01314"></a>01314     {
<a name="l01315"></a>01315       err = info-&gt;<a class="code" href="structthread__db__info.html#a33e247512f4590ab36ac442ed3a4c9f3">td_thr_event_enable_p</a> (th_p, 1);
<a name="l01316"></a>01316       <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l01317"></a>01317         <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Cannot enable thread event reporting for %s: %s&quot;</span>),
<a name="l01318"></a>01318                <a class="code" href="target_8c.html#a25ebd5fbc0b84bf9b914f7a21bfa6f7b">target_pid_to_str</a> (ptid), <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l01319"></a>01319     }
<a name="l01320"></a>01320 
<a name="l01321"></a>01321   <span class="keywordflow">return</span> 1;
<a name="l01322"></a>01322 }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01325"></a><a class="code" href="linux-thread-db_8c.html#ae86771241d19217bac7242dfb8e37c6c">01325</a> <a class="code" href="linux-thread-db_8c.html#ae86771241d19217bac7242dfb8e37c6c">detach_thread</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>)
<a name="l01326"></a>01326 {
<a name="l01327"></a>01327   <span class="keyword">struct </span><a class="code" href="structthread__info.html">thread_info</a> *<a class="code" href="windows-nat_8c.html#afcec92a2687d34570e53b62dfd9a7dbe">thread_info</a>;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329   <span class="comment">/* Don&#39;t delete the thread now, because it still reports as active</span>
<a name="l01330"></a>01330 <span class="comment">     until it has executed a few instructions after the event</span>
<a name="l01331"></a>01331 <span class="comment">     breakpoint - if we deleted it now, &quot;info threads&quot; would cause us</span>
<a name="l01332"></a>01332 <span class="comment">     to re-attach to it.  Just mark it as having had a TD_DEATH</span>
<a name="l01333"></a>01333 <span class="comment">     event.  This means that we won&#39;t delete it from our thread list</span>
<a name="l01334"></a>01334 <span class="comment">     until we notice that it&#39;s dead (via prune_threads), or until</span>
<a name="l01335"></a>01335 <span class="comment">     something re-uses its thread ID.  We&#39;ll report the thread exit</span>
<a name="l01336"></a>01336 <span class="comment">     when the underlying LWP dies.  */</span>
<a name="l01337"></a>01337   thread_info = <a class="code" href="gdbthread_8h.html#ac9a7f4c3c173f717f0da44f83745384c">find_thread_ptid</a> (ptid);
<a name="l01338"></a>01338   <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (thread_info != NULL &amp;&amp; thread_info-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a> != NULL);
<a name="l01339"></a>01339   thread_info-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a>-&gt;<a class="code" href="structprivate__thread__info.html#acc64731c2220a4cde05819aadfbe6a44">dying</a> = 1;
<a name="l01340"></a>01340 }
<a name="l01341"></a>01341 
<a name="l01342"></a>01342 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01343"></a><a class="code" href="linux-thread-db_8c.html#aca0eb72640b7e79f50e147956291c1a9">01343</a> <a class="code" href="linux-thread-db_8c.html#aca0eb72640b7e79f50e147956291c1a9">thread_db_detach</a> (<span class="keyword">struct</span> <a class="code" href="structtarget__ops.html">target_ops</a> *ops, <span class="keywordtype">char</span> *args, <span class="keywordtype">int</span> from_tty)
<a name="l01344"></a>01344 {
<a name="l01345"></a>01345   <span class="keyword">struct </span><a class="code" href="structtarget__ops.html">target_ops</a> *target_beneath = <a class="code" href="target_8c.html#afa1a2fb00f3ea15f9394f5b8afe14818">find_target_beneath</a> (ops);
<a name="l01346"></a>01346   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l01347"></a>01347 
<a name="l01348"></a>01348   info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>));
<a name="l01349"></a>01349 
<a name="l01350"></a>01350   <span class="keywordflow">if</span> (info)
<a name="l01351"></a>01351     {
<a name="l01352"></a>01352       <span class="keywordflow">if</span> (<a class="code" href="target_8h.html#a85885df22f7c1304269eaba1e1d618b7">target_has_execution</a>)
<a name="l01353"></a>01353         {
<a name="l01354"></a>01354           <a class="code" href="linux-thread-db_8c.html#a23aa8c442908cde315fa6ba6f714057b">disable_thread_event_reporting</a> (info);
<a name="l01355"></a>01355 
<a name="l01356"></a>01356           <span class="comment">/* Delete the old thread event breakpoints.  Note that</span>
<a name="l01357"></a>01357 <span class="comment">             unlike when mourning, we can remove them here because</span>
<a name="l01358"></a>01358 <span class="comment">             there&#39;s still a live inferior to poke at.  In any case,</span>
<a name="l01359"></a>01359 <span class="comment">             GDB will not try to insert anything in the inferior when</span>
<a name="l01360"></a>01360 <span class="comment">             removing a breakpoint.  */</span>
<a name="l01361"></a>01361           <a class="code" href="breakpoint_8c.html#a5b5cd7b781ac9e4895f8bac9d7023ad0">remove_thread_event_breakpoints</a> ();
<a name="l01362"></a>01362         }
<a name="l01363"></a>01363 
<a name="l01364"></a>01364       <a class="code" href="linux-thread-db_8c.html#ac1a17b84ff38e1aa271da8a7bb67ae26">delete_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>));
<a name="l01365"></a>01365     }
<a name="l01366"></a>01366 
<a name="l01367"></a>01367   target_beneath-&gt;<a class="code" href="structtarget__ops.html#a2749c09156c21e635d6860af415b7a52">to_detach</a> (target_beneath, args, from_tty);
<a name="l01368"></a>01368 
<a name="l01369"></a>01369   <span class="comment">/* NOTE: From this point on, inferior_ptid is null_ptid.  */</span>
<a name="l01370"></a>01370 
<a name="l01371"></a>01371   <span class="comment">/* If there are no more processes using libpthread, detach the</span>
<a name="l01372"></a>01372 <span class="comment">     thread_db target ops.  */</span>
<a name="l01373"></a>01373   <span class="keywordflow">if</span> (!thread_db_list)
<a name="l01374"></a>01374     <a class="code" href="target_8c.html#a9599d37847d1388531abb3f2aeba6616">unpush_target</a> (&amp;<a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>);
<a name="l01375"></a>01375 }
<a name="l01376"></a>01376 
<a name="l01377"></a>01377 <span class="comment">/* Check if PID is currently stopped at the location of a thread event</span>
<a name="l01378"></a>01378 <span class="comment">   breakpoint location.  If it is, read the event message and act upon</span>
<a name="l01379"></a>01379 <span class="comment">   the event.  */</span>
<a name="l01380"></a>01380 
<a name="l01381"></a>01381 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01382"></a><a class="code" href="linux-thread-db_8c.html#aac0afa5532d62bc98437f608ca1f8363">01382</a> <a class="code" href="linux-thread-db_8c.html#aac0afa5532d62bc98437f608ca1f8363">check_event</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>)
<a name="l01383"></a>01383 {
<a name="l01384"></a>01384   <span class="keyword">struct </span><a class="code" href="structregcache.html">regcache</a> *<a class="code" href="structregcache.html">regcache</a> = <a class="code" href="regcache_8c.html#aec7af24a2f0b7c27c042f6a22c51291b">get_thread_regcache</a> (ptid);
<a name="l01385"></a>01385   <span class="keyword">struct </span><a class="code" href="structgdbarch.html">gdbarch</a> *<a class="code" href="structgdbarch.html">gdbarch</a> = <a class="code" href="regcache_8c.html#ad4f6d0cdf256b1fa45d59a6d71b50659">get_regcache_arch</a> (regcache);
<a name="l01386"></a>01386   <a class="code" href="structtd__event__msg.html">td_event_msg_t</a> msg;
<a name="l01387"></a>01387   <a class="code" href="structtd__thrinfo.html">td_thrinfo_t</a> ti;
<a name="l01388"></a>01388   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err;
<a name="l01389"></a>01389   <a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a> <a class="code" href="infcmd_8c.html#a2ccc36c43036951d612e70e909955a4c">stop_pc</a>;
<a name="l01390"></a>01390   <span class="keywordtype">int</span> loop = 0;
<a name="l01391"></a>01391   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l01392"></a>01392 
<a name="l01393"></a>01393   info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid));
<a name="l01394"></a>01394 
<a name="l01395"></a>01395   <span class="comment">/* Bail out early if we&#39;re not at a thread event breakpoint.  */</span>
<a name="l01396"></a>01396   stop_pc = <a class="code" href="regcache_8c.html#a01b72bb2ee2d14e0097af17241cee731">regcache_read_pc</a> (regcache)
<a name="l01397"></a>01397             - <a class="code" href="gdbarch_8c.html#ac589b701c8fdf414e0b4d8e4c68213b5">gdbarch_decr_pc_after_break</a> (gdbarch);
<a name="l01398"></a>01398   <span class="keywordflow">if</span> (stop_pc != info-&gt;<a class="code" href="structthread__db__info.html#a20fc4977322c8f3c080e5d7b4c2d6a94">td_create_bp_addr</a>
<a name="l01399"></a>01399       &amp;&amp; stop_pc != info-&gt;<a class="code" href="structthread__db__info.html#a68dd60e8331b9ba6c935e294944024d9">td_death_bp_addr</a>)
<a name="l01400"></a>01400     <span class="keywordflow">return</span>;
<a name="l01401"></a>01401 
<a name="l01402"></a>01402   <span class="comment">/* Access an lwp we know is stopped.  */</span>
<a name="l01403"></a>01403   info-&gt;<a class="code" href="structthread__db__info.html#a35554ecef70a2233685706acde969f25">proc_handle</a>.<a class="code" href="structps__prochandle.html#ac137f90af8832f0784aed26658870623">ptid</a> = ptid;
<a name="l01404"></a>01404 
<a name="l01405"></a>01405   <span class="comment">/* If we have only looked at the first thread before libpthread was</span>
<a name="l01406"></a>01406 <span class="comment">     initialized, we may not know its thread ID yet.  Make sure we do</span>
<a name="l01407"></a>01407 <span class="comment">     before we add another thread to the list.  */</span>
<a name="l01408"></a>01408   <span class="keywordflow">if</span> (!<a class="code" href="linux-thread-db_8c.html#a510bee11c4763403127837b8e9b28cc9">have_threads</a> (ptid))
<a name="l01409"></a>01409     <a class="code" href="linux-thread-db_8c.html#a8748de14af79f07c6a5737302e476e1f">thread_db_find_new_threads_1</a> (ptid);
<a name="l01410"></a>01410 
<a name="l01411"></a>01411   <span class="comment">/* If we are at a create breakpoint, we do not know what new lwp</span>
<a name="l01412"></a>01412 <span class="comment">     was created and cannot specifically locate the event message for it.</span>
<a name="l01413"></a>01413 <span class="comment">     We have to call td_ta_event_getmsg() to get</span>
<a name="l01414"></a>01414 <span class="comment">     the latest message.  Since we have no way of correlating whether</span>
<a name="l01415"></a>01415 <span class="comment">     the event message we get back corresponds to our breakpoint, we must</span>
<a name="l01416"></a>01416 <span class="comment">     loop and read all event messages, processing them appropriately.</span>
<a name="l01417"></a>01417 <span class="comment">     This guarantees we will process the correct message before continuing</span>
<a name="l01418"></a>01418 <span class="comment">     from the breakpoint.</span>
<a name="l01419"></a>01419 <span class="comment"></span>
<a name="l01420"></a>01420 <span class="comment">     Currently, death events are not enabled.  If they are enabled,</span>
<a name="l01421"></a>01421 <span class="comment">     the death event can use the td_thr_event_getmsg() interface to</span>
<a name="l01422"></a>01422 <span class="comment">     get the message specifically for that lwp and avoid looping</span>
<a name="l01423"></a>01423 <span class="comment">     below.  */</span>
<a name="l01424"></a>01424 
<a name="l01425"></a>01425   loop = 1;
<a name="l01426"></a>01426 
<a name="l01427"></a>01427   <span class="keywordflow">do</span>
<a name="l01428"></a>01428     {
<a name="l01429"></a>01429       err = info-&gt;<a class="code" href="structthread__db__info.html#aa8b076c6af5ed7412b77fdb540a2b954">td_ta_event_getmsg_p</a> (info-&gt;<a class="code" href="structthread__db__info.html#a9be1d106fa5bde24113c74810bf47324">thread_agent</a>, &amp;msg);
<a name="l01430"></a>01430       <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l01431"></a>01431         {
<a name="l01432"></a>01432           <span class="keywordflow">if</span> (err == <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a7d15a6cd0a614e2ad07a716b384baaf3">TD_NOMSG</a>)
<a name="l01433"></a>01433             <span class="keywordflow">return</span>;
<a name="l01434"></a>01434 
<a name="l01435"></a>01435           <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Cannot get thread event message: %s&quot;</span>),
<a name="l01436"></a>01436                  <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l01437"></a>01437         }
<a name="l01438"></a>01438 
<a name="l01439"></a>01439       err = info-&gt;<a class="code" href="structthread__db__info.html#a067c8611bf9c894d3691f7cb7bbefdcc">td_thr_get_info_p</a> (msg.<a class="code" href="structtd__event__msg.html#a7049b2b17e58bd2ac7c5845b46c67a7b">th_p</a>, &amp;ti);
<a name="l01440"></a>01440       <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l01441"></a>01441         <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Cannot get thread info: %s&quot;</span>), <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l01442"></a>01442 
<a name="l01443"></a>01443       ptid = <a class="code" href="ptid_8c.html#aa96ee3f6a88626ec36045b4d84e27f79">ptid_build</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid), ti.<a class="code" href="structtd__thrinfo.html#a260ea1a3410bad7ac271209bd014b467">ti_lid</a>, 0);
<a name="l01444"></a>01444 
<a name="l01445"></a>01445       <span class="keywordflow">switch</span> (msg.<a class="code" href="structtd__event__msg.html#ae7ea91d34eea4418046186848c014a31">event</a>)
<a name="l01446"></a>01446         {
<a name="l01447"></a>01447         <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#ae1a250281b93679f2616df2bbcba40e0aecc98b124ac8e6a5ce8ad882158bf863">TD_CREATE</a>:
<a name="l01448"></a>01448           <span class="comment">/* Call attach_thread whether or not we already know about a</span>
<a name="l01449"></a>01449 <span class="comment">             thread with this thread ID.  */</span>
<a name="l01450"></a>01450           <a class="code" href="linux-thread-db_8c.html#af3122c68a24f28d6605a3356660c7b64">attach_thread</a> (ptid, msg.<a class="code" href="structtd__event__msg.html#a7049b2b17e58bd2ac7c5845b46c67a7b">th_p</a>, &amp;ti);
<a name="l01451"></a>01451 
<a name="l01452"></a>01452           <span class="keywordflow">break</span>;
<a name="l01453"></a>01453 
<a name="l01454"></a>01454         <span class="keywordflow">case</span> <a class="code" href="glibc__thread__db_8h.html#ae1a250281b93679f2616df2bbcba40e0a40da0b34365d11c6c5c56c8fce78dd69">TD_DEATH</a>:
<a name="l01455"></a>01455 
<a name="l01456"></a>01456           <span class="keywordflow">if</span> (!<a class="code" href="gdbthread_8h.html#a75cff5779f03e4119723fd41a5583fa7">in_thread_list</a> (ptid))
<a name="l01457"></a>01457             <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Spurious thread death event.&quot;</span>));
<a name="l01458"></a>01458 
<a name="l01459"></a>01459           <a class="code" href="linux-thread-db_8c.html#ae86771241d19217bac7242dfb8e37c6c">detach_thread</a> (ptid);
<a name="l01460"></a>01460 
<a name="l01461"></a>01461           <span class="keywordflow">break</span>;
<a name="l01462"></a>01462 
<a name="l01463"></a>01463         <span class="keywordflow">default</span>:
<a name="l01464"></a>01464           <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Spurious thread event.&quot;</span>));
<a name="l01465"></a>01465         }
<a name="l01466"></a>01466     }
<a name="l01467"></a>01467   <span class="keywordflow">while</span> (loop);
<a name="l01468"></a>01468 }
<a name="l01469"></a>01469 
<a name="l01470"></a>01470 <span class="keyword">static</span> <a class="code" href="structptid.html">ptid_t</a>
<a name="l01471"></a><a class="code" href="linux-thread-db_8c.html#a16c335dd7b4d3ce8f3b7e2c4bf7ee83d">01471</a> <a class="code" href="linux-thread-db_8c.html#a16c335dd7b4d3ce8f3b7e2c4bf7ee83d">thread_db_wait</a> (<span class="keyword">struct</span> <a class="code" href="structtarget__ops.html">target_ops</a> *ops,
<a name="l01472"></a>01472                 <a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>, <span class="keyword">struct</span> <a class="code" href="structtarget__waitstatus.html">target_waitstatus</a> *ourstatus,
<a name="l01473"></a>01473                 <span class="keywordtype">int</span> options)
<a name="l01474"></a>01474 {
<a name="l01475"></a>01475   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l01476"></a>01476   <span class="keyword">struct </span><a class="code" href="structtarget__ops.html">target_ops</a> *<a class="code" href="structtarget__ops.html#a1b180ccb4db2afccf46e691862bf2ddf">beneath</a> = <a class="code" href="target_8c.html#afa1a2fb00f3ea15f9394f5b8afe14818">find_target_beneath</a> (ops);
<a name="l01477"></a>01477 
<a name="l01478"></a>01478   ptid = beneath-&gt;<a class="code" href="structtarget__ops.html#ae8e22dbcc8522f0daac3fc8ed2661ca1">to_wait</a> (beneath, ptid, ourstatus, options);
<a name="l01479"></a>01479 
<a name="l01480"></a>01480   <span class="keywordflow">if</span> (ourstatus-&gt;<a class="code" href="structtarget__waitstatus.html#a17ed1783e9146f443fa51ace8da76198">kind</a> == <a class="code" href="waitstatus_8h.html#aa3229b489ec985f04f7e9f652138b7c3afef24be0a5593c22b6345d9e2c32e0e3">TARGET_WAITKIND_IGNORE</a>)
<a name="l01481"></a>01481     <span class="keywordflow">return</span> ptid;
<a name="l01482"></a>01482 
<a name="l01483"></a>01483   <span class="keywordflow">if</span> (ourstatus-&gt;<a class="code" href="structtarget__waitstatus.html#a17ed1783e9146f443fa51ace8da76198">kind</a> == <a class="code" href="waitstatus_8h.html#aa3229b489ec985f04f7e9f652138b7c3ab3b4a30139ccced70de23752ba9de4d4">TARGET_WAITKIND_EXITED</a>
<a name="l01484"></a>01484       || ourstatus-&gt;<a class="code" href="structtarget__waitstatus.html#a17ed1783e9146f443fa51ace8da76198">kind</a> == <a class="code" href="waitstatus_8h.html#aa3229b489ec985f04f7e9f652138b7c3a7d23c98b3669e42702eb039a2f5d4c68">TARGET_WAITKIND_SIGNALLED</a>)
<a name="l01485"></a>01485     <span class="keywordflow">return</span> ptid;
<a name="l01486"></a>01486 
<a name="l01487"></a>01487   info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid));
<a name="l01488"></a>01488 
<a name="l01489"></a>01489   <span class="comment">/* If this process isn&#39;t using thread_db, we&#39;re done.  */</span>
<a name="l01490"></a>01490   <span class="keywordflow">if</span> (info == NULL)
<a name="l01491"></a>01491     <span class="keywordflow">return</span> ptid;
<a name="l01492"></a>01492 
<a name="l01493"></a>01493   <span class="keywordflow">if</span> (ourstatus-&gt;<a class="code" href="structtarget__waitstatus.html#a17ed1783e9146f443fa51ace8da76198">kind</a> == <a class="code" href="waitstatus_8h.html#aa3229b489ec985f04f7e9f652138b7c3af733ff83444ff8f174ea7cd1240fe85c">TARGET_WAITKIND_EXECD</a>)
<a name="l01494"></a>01494     {
<a name="l01495"></a>01495       <span class="comment">/* New image, it may or may not end up using thread_db.  Assume</span>
<a name="l01496"></a>01496 <span class="comment">         not unless we find otherwise.  */</span>
<a name="l01497"></a>01497       <a class="code" href="linux-thread-db_8c.html#ac1a17b84ff38e1aa271da8a7bb67ae26">delete_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid));
<a name="l01498"></a>01498       <span class="keywordflow">if</span> (!thread_db_list)
<a name="l01499"></a>01499         <a class="code" href="target_8c.html#a9599d37847d1388531abb3f2aeba6616">unpush_target</a> (&amp;<a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>);
<a name="l01500"></a>01500 
<a name="l01501"></a>01501       <span class="comment">/* Thread event breakpoints are deleted by</span>
<a name="l01502"></a>01502 <span class="comment">         update_breakpoints_after_exec.  */</span>
<a name="l01503"></a>01503 
<a name="l01504"></a>01504       <span class="keywordflow">return</span> ptid;
<a name="l01505"></a>01505     }
<a name="l01506"></a>01506 
<a name="l01507"></a>01507   <span class="comment">/* If we do not know about the main thread yet, this would be a good time to</span>
<a name="l01508"></a>01508 <span class="comment">     find it.  */</span>
<a name="l01509"></a>01509   <span class="keywordflow">if</span> (ourstatus-&gt;<a class="code" href="structtarget__waitstatus.html#a17ed1783e9146f443fa51ace8da76198">kind</a> == <a class="code" href="waitstatus_8h.html#aa3229b489ec985f04f7e9f652138b7c3a8e1dc525cf3131501a541b4412bcd493">TARGET_WAITKIND_STOPPED</a> &amp;&amp; !<a class="code" href="linux-thread-db_8c.html#a510bee11c4763403127837b8e9b28cc9">have_threads</a> (ptid))
<a name="l01510"></a>01510     <a class="code" href="linux-thread-db_8c.html#a8748de14af79f07c6a5737302e476e1f">thread_db_find_new_threads_1</a> (ptid);
<a name="l01511"></a>01511 
<a name="l01512"></a>01512   <span class="keywordflow">if</span> (ourstatus-&gt;<a class="code" href="structtarget__waitstatus.html#a17ed1783e9146f443fa51ace8da76198">kind</a> == <a class="code" href="waitstatus_8h.html#aa3229b489ec985f04f7e9f652138b7c3a8e1dc525cf3131501a541b4412bcd493">TARGET_WAITKIND_STOPPED</a>
<a name="l01513"></a>01513       &amp;&amp; ourstatus-&gt;<a class="code" href="structtarget__waitstatus.html#af33b8f5721dc36f6b5b829286d38f825">value</a>.<a class="code" href="structtarget__waitstatus.html#a7cc711572c26d1f095a87105f4afd1e1">sig</a> == GDB_SIGNAL_TRAP)
<a name="l01514"></a>01514     <span class="comment">/* Check for a thread event.  */</span>
<a name="l01515"></a>01515     <a class="code" href="linux-thread-db_8c.html#aac0afa5532d62bc98437f608ca1f8363">check_event</a> (ptid);
<a name="l01516"></a>01516 
<a name="l01517"></a>01517   <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a510bee11c4763403127837b8e9b28cc9">have_threads</a> (ptid))
<a name="l01518"></a>01518     {
<a name="l01519"></a>01519       <span class="comment">/* Fill in the thread&#39;s user-level thread id.  */</span>
<a name="l01520"></a>01520       <a class="code" href="linux-thread-db_8c.html#a38aead26eb6f716a7007180580b0b154">thread_from_lwp</a> (ptid);
<a name="l01521"></a>01521     }
<a name="l01522"></a>01522 
<a name="l01523"></a>01523   <span class="keywordflow">return</span> ptid;
<a name="l01524"></a>01524 }
<a name="l01525"></a>01525 
<a name="l01526"></a>01526 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01527"></a><a class="code" href="linux-thread-db_8c.html#a6200617444dd024e6dc1de96477dee70">01527</a> <a class="code" href="linux-thread-db_8c.html#a6200617444dd024e6dc1de96477dee70">thread_db_mourn_inferior</a> (<span class="keyword">struct</span> <a class="code" href="structtarget__ops.html">target_ops</a> *ops)
<a name="l01528"></a>01528 {
<a name="l01529"></a>01529   <span class="keyword">struct </span><a class="code" href="structtarget__ops.html">target_ops</a> *target_beneath = <a class="code" href="target_8c.html#afa1a2fb00f3ea15f9394f5b8afe14818">find_target_beneath</a> (ops);
<a name="l01530"></a>01530 
<a name="l01531"></a>01531   <a class="code" href="linux-thread-db_8c.html#ac1a17b84ff38e1aa271da8a7bb67ae26">delete_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>));
<a name="l01532"></a>01532 
<a name="l01533"></a>01533   target_beneath-&gt;<a class="code" href="structtarget__ops.html#aa636723dd143fcd0c3c78af97f7358a5">to_mourn_inferior</a> (target_beneath);
<a name="l01534"></a>01534 
<a name="l01535"></a>01535   <span class="comment">/* Delete the old thread event breakpoints.  Do this after mourning</span>
<a name="l01536"></a>01536 <span class="comment">     the inferior, so that we don&#39;t try to uninsert them.  */</span>
<a name="l01537"></a>01537   <a class="code" href="breakpoint_8c.html#a5b5cd7b781ac9e4895f8bac9d7023ad0">remove_thread_event_breakpoints</a> ();
<a name="l01538"></a>01538 
<a name="l01539"></a>01539   <span class="comment">/* Detach thread_db target ops.  */</span>
<a name="l01540"></a>01540   <span class="keywordflow">if</span> (!thread_db_list)
<a name="l01541"></a>01541     <a class="code" href="target_8c.html#a9599d37847d1388531abb3f2aeba6616">unpush_target</a> (ops);
<a name="l01542"></a>01542 }
<a name="l01543"></a>01543 
<a name="l01544"></a>01544 <span class="keyword">struct </span><a class="code" href="structcallback__data.html">callback_data</a>
<a name="l01545"></a>01545 {
<a name="l01546"></a><a class="code" href="structcallback__data.html#af782eccf232922eb3a505acc58d52a1f">01546</a>   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *<a class="code" href="structcallback__data.html#af782eccf232922eb3a505acc58d52a1f">info</a>;
<a name="l01547"></a><a class="code" href="structcallback__data.html#a54306b4553b9de9d714e18b5b73f359a">01547</a>   <span class="keywordtype">int</span> <a class="code" href="structcallback__data.html#a54306b4553b9de9d714e18b5b73f359a">new_threads</a>;
<a name="l01548"></a>01548 };
<a name="l01549"></a>01549 
<a name="l01550"></a>01550 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01551"></a><a class="code" href="linux-thread-db_8c.html#afc34ddb002064a430875e4812f358fea">01551</a> <a class="code" href="linux-thread-db_8c.html#afc34ddb002064a430875e4812f358fea">find_new_threads_callback</a> (<span class="keyword">const</span> <a class="code" href="structtd__thrhandle.html">td_thrhandle_t</a> *th_p, <span class="keywordtype">void</span> *data)
<a name="l01552"></a>01552 {
<a name="l01553"></a>01553   <a class="code" href="structtd__thrinfo.html">td_thrinfo_t</a> ti;
<a name="l01554"></a>01554   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err;
<a name="l01555"></a>01555   <a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>;
<a name="l01556"></a>01556   <span class="keyword">struct </span><a class="code" href="structthread__info.html">thread_info</a> *tp;
<a name="l01557"></a>01557   <span class="keyword">struct </span><a class="code" href="structcallback__data.html">callback_data</a> *cb_data = data;
<a name="l01558"></a>01558   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info = cb_data-&gt;<a class="code" href="structcallback__data.html#af782eccf232922eb3a505acc58d52a1f">info</a>;
<a name="l01559"></a>01559 
<a name="l01560"></a>01560   err = info-&gt;<a class="code" href="structthread__db__info.html#a067c8611bf9c894d3691f7cb7bbefdcc">td_thr_get_info_p</a> (th_p, &amp;ti);
<a name="l01561"></a>01561   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l01562"></a>01562     <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;find_new_threads_callback: cannot get thread info: %s&quot;</span>),
<a name="l01563"></a>01563            <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l01564"></a>01564 
<a name="l01565"></a>01565   <span class="keywordflow">if</span> (ti.<a class="code" href="structtd__thrinfo.html#ab80474078af11dda15a23e9a5c4e7a5f">ti_tid</a> == 0)
<a name="l01566"></a>01566     {
<a name="l01567"></a>01567       <span class="comment">/* A thread ID of zero means that this is the main thread, but</span>
<a name="l01568"></a>01568 <span class="comment">         glibc has not yet initialized thread-local storage and the</span>
<a name="l01569"></a>01569 <span class="comment">         pthread library.  We do not know what the thread&#39;s TID will</span>
<a name="l01570"></a>01570 <span class="comment">         be yet.  Just enable event reporting and otherwise ignore</span>
<a name="l01571"></a>01571 <span class="comment">         it.  */</span>
<a name="l01572"></a>01572 
<a name="l01573"></a>01573       <span class="comment">/* In that case, we&#39;re not stopped in a fork syscall and don&#39;t</span>
<a name="l01574"></a>01574 <span class="comment">         need this glibc bug workaround.  */</span>
<a name="l01575"></a>01575       info-&gt;<a class="code" href="structthread__db__info.html#ababfe4c4610a15619f1837848d22df07">need_stale_parent_threads_check</a> = 0;
<a name="l01576"></a>01576 
<a name="l01577"></a>01577       <span class="keywordflow">if</span> (<a class="code" href="target_8h.html#a85885df22f7c1304269eaba1e1d618b7">target_has_execution</a>)
<a name="l01578"></a>01578         {
<a name="l01579"></a>01579           err = info-&gt;<a class="code" href="structthread__db__info.html#a33e247512f4590ab36ac442ed3a4c9f3">td_thr_event_enable_p</a> (th_p, 1);
<a name="l01580"></a>01580           <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l01581"></a>01581             <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Cannot enable thread event reporting for LWP %d: %s&quot;</span>),
<a name="l01582"></a>01582                    (<span class="keywordtype">int</span>) ti.<a class="code" href="structtd__thrinfo.html#a260ea1a3410bad7ac271209bd014b467">ti_lid</a>, <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l01583"></a>01583         }
<a name="l01584"></a>01584 
<a name="l01585"></a>01585       <span class="keywordflow">return</span> 0;
<a name="l01586"></a>01586     }
<a name="l01587"></a>01587 
<a name="l01588"></a>01588   <span class="comment">/* Ignore stale parent threads, caused by glibc/BZ5983.  This is a</span>
<a name="l01589"></a>01589 <span class="comment">     bit expensive, as it needs to open /proc/pid/status, so try to</span>
<a name="l01590"></a>01590 <span class="comment">     avoid doing the work if we know we don&#39;t have to.  */</span>
<a name="l01591"></a>01591   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#ababfe4c4610a15619f1837848d22df07">need_stale_parent_threads_check</a>)
<a name="l01592"></a>01592     {
<a name="l01593"></a>01593       <span class="keywordtype">int</span> tgid = <a class="code" href="linux-procfs_8c.html#ac8fb5e21acf0e22c85412188755778fb">linux_proc_get_tgid</a> (ti.<a class="code" href="structtd__thrinfo.html#a260ea1a3410bad7ac271209bd014b467">ti_lid</a>);
<a name="l01594"></a>01594 
<a name="l01595"></a>01595       <span class="keywordflow">if</span> (tgid != -1 &amp;&amp; tgid != info-&gt;<a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a>)
<a name="l01596"></a>01596         <span class="keywordflow">return</span> 0;
<a name="l01597"></a>01597     }
<a name="l01598"></a>01598 
<a name="l01599"></a>01599   ptid = <a class="code" href="ptid_8c.html#aa96ee3f6a88626ec36045b4d84e27f79">ptid_build</a> (info-&gt;<a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a>, ti.<a class="code" href="structtd__thrinfo.html#a260ea1a3410bad7ac271209bd014b467">ti_lid</a>, 0);
<a name="l01600"></a>01600   tp = <a class="code" href="gdbthread_8h.html#ac9a7f4c3c173f717f0da44f83745384c">find_thread_ptid</a> (ptid);
<a name="l01601"></a>01601   <span class="keywordflow">if</span> (tp == NULL || tp-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a> == NULL)
<a name="l01602"></a>01602     {
<a name="l01603"></a>01603       <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#af3122c68a24f28d6605a3356660c7b64">attach_thread</a> (ptid, th_p, &amp;ti))
<a name="l01604"></a>01604         cb_data-&gt;<a class="code" href="structcallback__data.html#a54306b4553b9de9d714e18b5b73f359a">new_threads</a> += 1;
<a name="l01605"></a>01605       <span class="keywordflow">else</span>
<a name="l01606"></a>01606         <span class="comment">/* Problem attaching this thread; perhaps it exited before we</span>
<a name="l01607"></a>01607 <span class="comment">           could attach it?</span>
<a name="l01608"></a>01608 <span class="comment">           This could mean that the thread list inside glibc itself is in</span>
<a name="l01609"></a>01609 <span class="comment">           inconsistent state, and libthread_db could go on looping forever</span>
<a name="l01610"></a>01610 <span class="comment">           (observed with glibc-2.3.6).  To prevent that, terminate</span>
<a name="l01611"></a>01611 <span class="comment">           iteration: thread_db_find_new_threads_2 will retry.  */</span>
<a name="l01612"></a>01612         <span class="keywordflow">return</span> 1;
<a name="l01613"></a>01613     }
<a name="l01614"></a>01614 
<a name="l01615"></a>01615   <span class="keywordflow">return</span> 0;
<a name="l01616"></a>01616 }
<a name="l01617"></a>01617 
<a name="l01618"></a>01618 <span class="comment">/* Helper for thread_db_find_new_threads_2.</span>
<a name="l01619"></a>01619 <span class="comment">   Returns number of new threads found.  */</span>
<a name="l01620"></a>01620 
<a name="l01621"></a>01621 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01622"></a><a class="code" href="linux-thread-db_8c.html#a5e590e9c3b139ed1f84ff81b109d477f">01622</a> <a class="code" href="linux-thread-db_8c.html#a5e590e9c3b139ed1f84ff81b109d477f">find_new_threads_once</a> (<span class="keyword">struct</span> <a class="code" href="structthread__db__info.html">thread_db_info</a> *info, <span class="keywordtype">int</span> iteration,
<a name="l01623"></a>01623                        <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> *errp)
<a name="l01624"></a>01624 {
<a name="l01625"></a>01625   <span class="keyword">volatile</span> <span class="keyword">struct </span><a class="code" href="structgdb__exception.html">gdb_exception</a> except;
<a name="l01626"></a>01626   <span class="keyword">struct </span><a class="code" href="structcallback__data.html">callback_data</a> data;
<a name="l01627"></a>01627   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err = <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a59f033ea09df04aef2c83400b5d245cd">TD_ERR</a>;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629   data.<a class="code" href="structcallback__data.html#af782eccf232922eb3a505acc58d52a1f">info</a> = <a class="code" href="structcallback__data.html#af782eccf232922eb3a505acc58d52a1f">info</a>;
<a name="l01630"></a>01630   data.<a class="code" href="structcallback__data.html#a54306b4553b9de9d714e18b5b73f359a">new_threads</a> = 0;
<a name="l01631"></a>01631 
<a name="l01632"></a>01632   <a class="code" href="exceptions_8h.html#aef4514ee39b9305fddee27f49c7c34eb">TRY_CATCH</a> (except, <a class="code" href="exceptions_8h.html#abfa3a3b99557b11f5766baf69465fdf6a44de51845416ac49ab08438792b908f0">RETURN_MASK_ERROR</a>)
<a name="l01633"></a>01633     {
<a name="l01634"></a>01634       <span class="comment">/* Iterate over all user-space threads to discover new threads.  */</span>
<a name="l01635"></a>01635       err = info-&gt;<a class="code" href="structthread__db__info.html#a9edb87203f74a223a1080e449bf43f62">td_ta_thr_iter_p</a> (info-&gt;<a class="code" href="structthread__db__info.html#a9be1d106fa5bde24113c74810bf47324">thread_agent</a>,
<a name="l01636"></a>01636                                     <a class="code" href="linux-thread-db_8c.html#afc34ddb002064a430875e4812f358fea">find_new_threads_callback</a>,
<a name="l01637"></a>01637                                     &amp;data,
<a name="l01638"></a>01638                                     <a class="code" href="glibc__thread__db_8h.html#a7e015b84265c7d3667103553d8230d8eaa7598975576c3ad9f6900645f216ff74">TD_THR_ANY_STATE</a>,
<a name="l01639"></a>01639                                     <a class="code" href="glibc__thread__db_8h.html#a39686658953e72ecc96340a450187dd3">TD_THR_LOWEST_PRIORITY</a>,
<a name="l01640"></a>01640                                     <a class="code" href="glibc__thread__db_8h.html#a0a42742d59778244b7f5e7ab2c97527d">TD_SIGNO_MASK</a>,
<a name="l01641"></a>01641                                     <a class="code" href="glibc__thread__db_8h.html#ac004d54a1e1a2221185a34a5076673d4">TD_THR_ANY_USER_FLAGS</a>);
<a name="l01642"></a>01642     }
<a name="l01643"></a>01643 
<a name="l01644"></a>01644   <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">libthread_db_debug</a>)
<a name="l01645"></a>01645     {
<a name="l01646"></a>01646       <span class="keywordflow">if</span> (except.<a class="code" href="structgdb__exception.html#ae0e14189c63f830024865d557c1122cc">reason</a> &lt; 0)
<a name="l01647"></a>01647         <a class="code" href="exceptions_8c.html#ae1dffc77e3a96d17e813da7d2165b16d">exception_fprintf</a> (<a class="code" href="main_8c.html#a2a1dea1e551cadb9541353a004193a47">gdb_stderr</a>, except,
<a name="l01648"></a>01648                            <span class="stringliteral">&quot;Warning: find_new_threads_once: &quot;</span>);
<a name="l01649"></a>01649 
<a name="l01650"></a>01650       <a class="code" href="utils_8c.html#a8a83ee04701e157bf53e23d8682874e8">printf_filtered</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Found %d new threads in iteration %d.\n&quot;</span>),
<a name="l01651"></a>01651                        data.<a class="code" href="structcallback__data.html#a54306b4553b9de9d714e18b5b73f359a">new_threads</a>, iteration);
<a name="l01652"></a>01652     }
<a name="l01653"></a>01653 
<a name="l01654"></a>01654   <span class="keywordflow">if</span> (errp != NULL)
<a name="l01655"></a>01655     *errp = err;
<a name="l01656"></a>01656 
<a name="l01657"></a>01657   <span class="keywordflow">return</span> data.<a class="code" href="structcallback__data.html#a54306b4553b9de9d714e18b5b73f359a">new_threads</a>;
<a name="l01658"></a>01658 }
<a name="l01659"></a>01659 
<a name="l01660"></a>01660 <span class="comment">/* Search for new threads, accessing memory through stopped thread</span>
<a name="l01661"></a>01661 <span class="comment">   PTID.  If UNTIL_NO_NEW is true, repeat searching until several</span>
<a name="l01662"></a>01662 <span class="comment">   searches in a row do not discover any new threads.  */</span>
<a name="l01663"></a>01663 
<a name="l01664"></a>01664 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01665"></a><a class="code" href="linux-thread-db_8c.html#a0b2931755e813dbd72852f11a1fe7d78">01665</a> <a class="code" href="linux-thread-db_8c.html#a0b2931755e813dbd72852f11a1fe7d78">thread_db_find_new_threads_2</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>, <span class="keywordtype">int</span> until_no_new)
<a name="l01666"></a>01666 {
<a name="l01667"></a>01667   <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err = <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>;
<a name="l01668"></a>01668   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l01669"></a>01669   <span class="keywordtype">int</span> i, loop;
<a name="l01670"></a>01670 
<a name="l01671"></a>01671   info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid));
<a name="l01672"></a>01672 
<a name="l01673"></a>01673   <span class="comment">/* Access an lwp we know is stopped.  */</span>
<a name="l01674"></a>01674   info-&gt;<a class="code" href="structthread__db__info.html#a35554ecef70a2233685706acde969f25">proc_handle</a>.<a class="code" href="structps__prochandle.html#ac137f90af8832f0784aed26658870623">ptid</a> = ptid;
<a name="l01675"></a>01675 
<a name="l01676"></a>01676   <span class="keywordflow">if</span> (until_no_new)
<a name="l01677"></a>01677     {
<a name="l01678"></a>01678       <span class="comment">/* Require 4 successive iterations which do not find any new threads.</span>
<a name="l01679"></a>01679 <span class="comment">         The 4 is a heuristic: there is an inherent race here, and I have</span>
<a name="l01680"></a>01680 <span class="comment">         seen that 2 iterations in a row are not always sufficient to</span>
<a name="l01681"></a>01681 <span class="comment">         &quot;capture&quot; all threads.  */</span>
<a name="l01682"></a>01682       <span class="keywordflow">for</span> (i = 0, loop = 0; loop &lt; 4 &amp;&amp; err == <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>; ++i, ++loop)
<a name="l01683"></a>01683         <span class="keywordflow">if</span> (<a class="code" href="linux-thread-db_8c.html#a5e590e9c3b139ed1f84ff81b109d477f">find_new_threads_once</a> (info, i, &amp;err) != 0)
<a name="l01684"></a>01684           {
<a name="l01685"></a>01685             <span class="comment">/* Found some new threads.  Restart the loop from beginning.  */</span>
<a name="l01686"></a>01686             loop = -1;
<a name="l01687"></a>01687           }
<a name="l01688"></a>01688     }
<a name="l01689"></a>01689   <span class="keywordflow">else</span>
<a name="l01690"></a>01690     <a class="code" href="linux-thread-db_8c.html#a5e590e9c3b139ed1f84ff81b109d477f">find_new_threads_once</a> (info, 0, &amp;err);
<a name="l01691"></a>01691 
<a name="l01692"></a>01692   <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l01693"></a>01693     <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Cannot find new threads: %s&quot;</span>), <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l01694"></a>01694 }
<a name="l01695"></a>01695 
<a name="l01696"></a>01696 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01697"></a><a class="code" href="linux-thread-db_8c.html#a8748de14af79f07c6a5737302e476e1f">01697</a> <a class="code" href="linux-thread-db_8c.html#a8748de14af79f07c6a5737302e476e1f">thread_db_find_new_threads_1</a> (<a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>)
<a name="l01698"></a>01698 {
<a name="l01699"></a>01699   <a class="code" href="linux-thread-db_8c.html#a0b2931755e813dbd72852f11a1fe7d78">thread_db_find_new_threads_2</a> (ptid, 0);
<a name="l01700"></a>01700 }
<a name="l01701"></a>01701 
<a name="l01702"></a>01702 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01703"></a><a class="code" href="linux-thread-db_8c.html#a9f15bd719b9568967f9ce694905e0759">01703</a> <a class="code" href="linux-thread-db_8c.html#a9f15bd719b9568967f9ce694905e0759">update_thread_core</a> (<span class="keyword">struct</span> <a class="code" href="structlwp__info.html">lwp_info</a> *info, <span class="keywordtype">void</span> *closure)
<a name="l01704"></a>01704 {
<a name="l01705"></a>01705   info-&gt;<a class="code" href="structlwp__info.html#ad22fbd6e798429079f1aacaca6fc42db">core</a> = <a class="code" href="linux-osdata_8c.html#ac97e44a42c638af37e91443e9a52e84a">linux_common_core_of_thread</a> (info-&gt;<a class="code" href="structlwp__info.html#a03fe78c6e5209aa0ebfdbe4431c529b2">ptid</a>);
<a name="l01706"></a>01706   <span class="keywordflow">return</span> 0;
<a name="l01707"></a>01707 }
<a name="l01708"></a>01708 
<a name="l01709"></a>01709 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01710"></a><a class="code" href="linux-thread-db_8c.html#a28939201a59fc3d18ca47a4ef5b16013">01710</a> <a class="code" href="linux-thread-db_8c.html#a28939201a59fc3d18ca47a4ef5b16013">thread_db_find_new_threads</a> (<span class="keyword">struct</span> <a class="code" href="structtarget__ops.html">target_ops</a> *ops)
<a name="l01711"></a>01711 {
<a name="l01712"></a>01712   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l01713"></a>01713   <span class="keyword">struct </span><a class="code" href="structinferior.html">inferior</a> *<a class="code" href="namespacearm-linux.html#aaf6bae53545ee96f24d7ba560ed0a205">inf</a>;
<a name="l01714"></a>01714 
<a name="l01715"></a>01715   <a class="code" href="inferior_8h.html#a6dc84b797b8175f2eb2a338b3101fe57">ALL_INFERIORS</a> (inf)
<a name="l01716"></a>01716     {
<a name="l01717"></a>01717       <span class="keyword">struct </span><a class="code" href="structthread__info.html">thread_info</a> *thread;
<a name="l01718"></a>01718 
<a name="l01719"></a>01719       <span class="keywordflow">if</span> (inf-&gt;<a class="code" href="structinferior.html#a1be87f581dbb6c893dbe1f2ff701636a">pid</a> == 0)
<a name="l01720"></a>01720         <span class="keywordflow">continue</span>;
<a name="l01721"></a>01721 
<a name="l01722"></a>01722       info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (inf-&gt;<a class="code" href="structinferior.html#a1be87f581dbb6c893dbe1f2ff701636a">pid</a>);
<a name="l01723"></a>01723       <span class="keywordflow">if</span> (info == NULL)
<a name="l01724"></a>01724         <span class="keywordflow">continue</span>;
<a name="l01725"></a>01725 
<a name="l01726"></a>01726       thread = <a class="code" href="gdbthread_8h.html#a57e86f519208adb580413258d6992f85">any_live_thread_of_process</a> (inf-&gt;<a class="code" href="structinferior.html#a1be87f581dbb6c893dbe1f2ff701636a">pid</a>);
<a name="l01727"></a>01727       <span class="keywordflow">if</span> (thread == NULL || thread-&gt;<a class="code" href="structthread__info.html#a878b26a798766c43ed0c7f028adaf1bc">executing</a>)
<a name="l01728"></a>01728         <span class="keywordflow">continue</span>;
<a name="l01729"></a>01729 
<a name="l01730"></a>01730       <a class="code" href="linux-thread-db_8c.html#a8748de14af79f07c6a5737302e476e1f">thread_db_find_new_threads_1</a> (thread-&gt;<a class="code" href="structthread__info.html#a533aa3979b60affd446e9fbff93fdd2c">ptid</a>);
<a name="l01731"></a>01731     }
<a name="l01732"></a>01732 
<a name="l01733"></a>01733   <span class="keywordflow">if</span> (<a class="code" href="target_8h.html#a85885df22f7c1304269eaba1e1d618b7">target_has_execution</a>)
<a name="l01734"></a>01734     <a class="code" href="linux-nat_8c.html#af50f1b9aeccfc5c133f8e4a427be2f7f">iterate_over_lwps</a> (<a class="code" href="ptid_8c.html#ae865e32ccc6c9636dcec8ff779f99514">minus_one_ptid</a> <span class="comment">/* iterate over all */</span>,
<a name="l01735"></a>01735                        <a class="code" href="linux-thread-db_8c.html#a9f15bd719b9568967f9ce694905e0759">update_thread_core</a>, NULL);
<a name="l01736"></a>01736 }
<a name="l01737"></a>01737 
<a name="l01738"></a>01738 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l01739"></a><a class="code" href="linux-thread-db_8c.html#ad571bebebe7d6a200d5cf8b7a3b3a900">01739</a> <a class="code" href="linux-thread-db_8c.html#ad571bebebe7d6a200d5cf8b7a3b3a900">thread_db_pid_to_str</a> (<span class="keyword">struct</span> <a class="code" href="structtarget__ops.html">target_ops</a> *ops, <a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>)
<a name="l01740"></a>01740 {
<a name="l01741"></a>01741   <span class="keyword">struct </span><a class="code" href="structthread__info.html">thread_info</a> *<a class="code" href="structthread__info.html">thread_info</a> = <a class="code" href="gdbthread_8h.html#ac9a7f4c3c173f717f0da44f83745384c">find_thread_ptid</a> (ptid);
<a name="l01742"></a>01742   <span class="keyword">struct </span><a class="code" href="structtarget__ops.html">target_ops</a> *<a class="code" href="structtarget__ops.html#a1b180ccb4db2afccf46e691862bf2ddf">beneath</a>;
<a name="l01743"></a>01743 
<a name="l01744"></a>01744   <span class="keywordflow">if</span> (thread_info != NULL &amp;&amp; thread_info-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a> != NULL)
<a name="l01745"></a>01745     {
<a name="l01746"></a>01746       <span class="keyword">static</span> <span class="keywordtype">char</span> buf[64];
<a name="l01747"></a>01747       <a class="code" href="glibc__thread__db_8h.html#aa406fd87cfd69d7c0a93b6a241978712">thread_t</a> tid;
<a name="l01748"></a>01748 
<a name="l01749"></a>01749       tid = thread_info-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a>-&gt;<a class="code" href="structprivate__thread__info.html#a787a560a65133d93f60bba161faff68e">tid</a>;
<a name="l01750"></a>01750       snprintf (buf, <span class="keyword">sizeof</span> (buf), <span class="stringliteral">&quot;Thread 0x%lx (LWP %ld)&quot;</span>,
<a name="l01751"></a>01751                 tid, <a class="code" href="ptid_8c.html#af5b67a5f356c507b7809af2fa4e63b44">ptid_get_lwp</a> (ptid));
<a name="l01752"></a>01752 
<a name="l01753"></a>01753       <span class="keywordflow">return</span> buf;
<a name="l01754"></a>01754     }
<a name="l01755"></a>01755 
<a name="l01756"></a>01756   beneath = <a class="code" href="target_8c.html#afa1a2fb00f3ea15f9394f5b8afe14818">find_target_beneath</a> (ops);
<a name="l01757"></a>01757   <span class="keywordflow">if</span> (beneath-&gt;<a class="code" href="structtarget__ops.html#a5259fe0b12fd9dd4e269ed44fee00603">to_pid_to_str</a> (beneath, ptid))
<a name="l01758"></a>01758     <span class="keywordflow">return</span> beneath-&gt;<a class="code" href="structtarget__ops.html#a5259fe0b12fd9dd4e269ed44fee00603">to_pid_to_str</a> (beneath, ptid);
<a name="l01759"></a>01759 
<a name="l01760"></a>01760   <span class="keywordflow">return</span> <a class="code" href="target_8c.html#aa0e232d9b9de56e922b988294faa05d6">normal_pid_to_str</a> (ptid);
<a name="l01761"></a>01761 }
<a name="l01762"></a>01762 
<a name="l01763"></a>01763 <span class="comment">/* Return a string describing the state of the thread specified by</span>
<a name="l01764"></a>01764 <span class="comment">   INFO.  */</span>
<a name="l01765"></a>01765 
<a name="l01766"></a>01766 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l01767"></a><a class="code" href="linux-thread-db_8c.html#a1d8cfd1c88bc0ab4e55dafb802021f92">01767</a> <a class="code" href="linux-thread-db_8c.html#a1d8cfd1c88bc0ab4e55dafb802021f92">thread_db_extra_thread_info</a> (<span class="keyword">struct</span> <a class="code" href="structthread__info.html">thread_info</a> *info)
<a name="l01768"></a>01768 {
<a name="l01769"></a>01769   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a> == NULL)
<a name="l01770"></a>01770     <span class="keywordflow">return</span> NULL;
<a name="l01771"></a>01771 
<a name="l01772"></a>01772   <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a>-&gt;<a class="code" href="structprivate__thread__info.html#acc64731c2220a4cde05819aadfbe6a44">dying</a>)
<a name="l01773"></a>01773     <span class="keywordflow">return</span> <span class="stringliteral">&quot;Exiting&quot;</span>;
<a name="l01774"></a>01774 
<a name="l01775"></a>01775   <span class="keywordflow">return</span> NULL;
<a name="l01776"></a>01776 }
<a name="l01777"></a>01777 
<a name="l01778"></a>01778 <span class="comment">/* Get the address of the thread local variable in load module LM which</span>
<a name="l01779"></a>01779 <span class="comment">   is stored at OFFSET within the thread local storage for thread PTID.  */</span>
<a name="l01780"></a>01780 
<a name="l01781"></a>01781 <span class="keyword">static</span> <a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a>
<a name="l01782"></a><a class="code" href="linux-thread-db_8c.html#a6267e3c7d2a7203adbd0e0a728397dfa">01782</a> <a class="code" href="linux-thread-db_8c.html#a6267e3c7d2a7203adbd0e0a728397dfa">thread_db_get_thread_local_address</a> (<span class="keyword">struct</span> <a class="code" href="structtarget__ops.html">target_ops</a> *ops,
<a name="l01783"></a>01783                                     <a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>,
<a name="l01784"></a>01784                                     <a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a> lm,
<a name="l01785"></a>01785                                     <a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a> <a class="code" href="common_2agent_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a>)
<a name="l01786"></a>01786 {
<a name="l01787"></a>01787   <span class="keyword">struct </span><a class="code" href="structthread__info.html">thread_info</a> *<a class="code" href="windows-nat_8c.html#afcec92a2687d34570e53b62dfd9a7dbe">thread_info</a>;
<a name="l01788"></a>01788   <span class="keyword">struct </span><a class="code" href="structtarget__ops.html">target_ops</a> *<a class="code" href="structtarget__ops.html#a1b180ccb4db2afccf46e691862bf2ddf">beneath</a>;
<a name="l01789"></a>01789 
<a name="l01790"></a>01790   <span class="comment">/* If we have not discovered any threads yet, check now.  */</span>
<a name="l01791"></a>01791   <span class="keywordflow">if</span> (!<a class="code" href="linux-thread-db_8c.html#a510bee11c4763403127837b8e9b28cc9">have_threads</a> (ptid))
<a name="l01792"></a>01792     <a class="code" href="linux-thread-db_8c.html#a8748de14af79f07c6a5737302e476e1f">thread_db_find_new_threads_1</a> (ptid);
<a name="l01793"></a>01793 
<a name="l01794"></a>01794   <span class="comment">/* Find the matching thread.  */</span>
<a name="l01795"></a>01795   thread_info = <a class="code" href="gdbthread_8h.html#ac9a7f4c3c173f717f0da44f83745384c">find_thread_ptid</a> (ptid);
<a name="l01796"></a>01796 
<a name="l01797"></a>01797   <span class="keywordflow">if</span> (thread_info != NULL &amp;&amp; thread_info-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a> != NULL)
<a name="l01798"></a>01798     {
<a name="l01799"></a>01799       <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434">td_err_e</a> err;
<a name="l01800"></a>01800       <a class="code" href="gdb__proc__service_8h.html#ad65a744093c157125797432097349eed">psaddr_t</a> address;
<a name="l01801"></a>01801       <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l01802"></a>01802 
<a name="l01803"></a>01803       info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid));
<a name="l01804"></a>01804 
<a name="l01805"></a>01805       <span class="comment">/* glibc doesn&#39;t provide the needed interface.  */</span>
<a name="l01806"></a>01806       <span class="keywordflow">if</span> (!info-&gt;<a class="code" href="structthread__db__info.html#ac620454d19987cf45f202b3663bb2e3a">td_thr_tls_get_addr_p</a>)
<a name="l01807"></a>01807         <a class="code" href="exceptions_8c.html#a366e9b618421f1f94a3318e81cc0489c">throw_error</a> (<a class="code" href="exceptions_8h.html#acc42076253600be964e110149b458971a55369855d2c37986f98bd3f6e1ac3e99">TLS_NO_LIBRARY_SUPPORT_ERROR</a>,
<a name="l01808"></a>01808                      <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;No TLS library support&quot;</span>));
<a name="l01809"></a>01809 
<a name="l01810"></a>01810       <span class="comment">/* Caller should have verified that lm != 0.  */</span>
<a name="l01811"></a>01811       <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (lm != 0);
<a name="l01812"></a>01812 
<a name="l01813"></a>01813       <span class="comment">/* Finally, get the address of the variable.  */</span>
<a name="l01814"></a>01814       <span class="comment">/* Note the cast through uintptr_t: this interface only works if</span>
<a name="l01815"></a>01815 <span class="comment">         a target address fits in a psaddr_t, which is a host pointer.</span>
<a name="l01816"></a>01816 <span class="comment">         So a 32-bit debugger can not access 64-bit TLS through this.  */</span>
<a name="l01817"></a>01817       err = info-&gt;<a class="code" href="structthread__db__info.html#ac620454d19987cf45f202b3663bb2e3a">td_thr_tls_get_addr_p</a> (&amp;thread_info-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a>-&gt;<a class="code" href="structprivate__thread__info.html#a10760ecdf3e6800fdde5aa83b71fc455">th</a>,
<a name="l01818"></a>01818                                          (<a class="code" href="gdb__proc__service_8h.html#ad65a744093c157125797432097349eed">psaddr_t</a>)(uintptr_t) lm,
<a name="l01819"></a>01819                                          offset, &amp;address);
<a name="l01820"></a>01820 
<a name="l01821"></a>01821 <span class="preprocessor">#ifdef THREAD_DB_HAS_TD_NOTALLOC</span>
<a name="l01822"></a>01822 <span class="preprocessor"></span>      <span class="comment">/* The memory hasn&#39;t been allocated, yet.  */</span>
<a name="l01823"></a>01823       <span class="keywordflow">if</span> (err == <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a1da6860f55086bf113aa77237d5c34fa">TD_NOTALLOC</a>)
<a name="l01824"></a>01824           <span class="comment">/* Now, if libthread_db provided the initialization image&#39;s</span>
<a name="l01825"></a>01825 <span class="comment">             address, we *could* try to build a non-lvalue value from</span>
<a name="l01826"></a>01826 <span class="comment">             the initialization image.  */</span>
<a name="l01827"></a>01827         <a class="code" href="exceptions_8c.html#a366e9b618421f1f94a3318e81cc0489c">throw_error</a> (<a class="code" href="exceptions_8h.html#acc42076253600be964e110149b458971a42c9d4483221d49734ceaecb3cbcdcad">TLS_NOT_ALLOCATED_YET_ERROR</a>,
<a name="l01828"></a>01828                      <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;TLS not allocated yet&quot;</span>));
<a name="l01829"></a>01829 <span class="preprocessor">#endif</span>
<a name="l01830"></a>01830 <span class="preprocessor"></span>
<a name="l01831"></a>01831       <span class="comment">/* Something else went wrong.  */</span>
<a name="l01832"></a>01832       <span class="keywordflow">if</span> (err != <a class="code" href="glibc__thread__db_8h.html#a03bba0f82045c1a5bb35aa55e693f434a93e810059742feb944de782cee183f3f">TD_OK</a>)
<a name="l01833"></a>01833         <a class="code" href="exceptions_8c.html#a366e9b618421f1f94a3318e81cc0489c">throw_error</a> (<a class="code" href="exceptions_8h.html#acc42076253600be964e110149b458971ac3542c27e951e540045797b560266872">TLS_GENERIC_ERROR</a>,
<a name="l01834"></a>01834                      ((<span class="stringliteral">&quot;%s&quot;</span>)), <a class="code" href="linux-thread-db_8c.html#a6117cc295171bd2bdb9384fefcdf8875">thread_db_err_str</a> (err));
<a name="l01835"></a>01835 
<a name="l01836"></a>01836       <span class="comment">/* Cast assuming host == target.  Joy.  */</span>
<a name="l01837"></a>01837       <span class="comment">/* Do proper sign extension for the target.  */</span>
<a name="l01838"></a>01838       <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (<a class="code" href="exec_8h.html#ac2e2e739fca42163e235e8521b9fbbab">exec_bfd</a>);
<a name="l01839"></a>01839       <span class="keywordflow">return</span> (bfd_get_sign_extend_vma (<a class="code" href="exec_8h.html#ac2e2e739fca42163e235e8521b9fbbab">exec_bfd</a>) &gt; 0
<a name="l01840"></a>01840               ? (<a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a>) (intptr_t) address
<a name="l01841"></a>01841               : (<a class="code" href="defs_8h.html#aba5d0eb4e938c80ae1112a4439aaf71a">CORE_ADDR</a>) (uintptr_t) address);
<a name="l01842"></a>01842     }
<a name="l01843"></a>01843 
<a name="l01844"></a>01844   beneath = <a class="code" href="target_8c.html#afa1a2fb00f3ea15f9394f5b8afe14818">find_target_beneath</a> (ops);
<a name="l01845"></a>01845   <span class="keywordflow">if</span> (beneath-&gt;<a class="code" href="structtarget__ops.html#a076aa3a1e1e1d6bb90656222d790b243">to_get_thread_local_address</a>)
<a name="l01846"></a>01846     <span class="keywordflow">return</span> beneath-&gt;<a class="code" href="structtarget__ops.html#a076aa3a1e1e1d6bb90656222d790b243">to_get_thread_local_address</a> (beneath, ptid, lm, offset);
<a name="l01847"></a>01847   <span class="keywordflow">else</span>
<a name="l01848"></a>01848     <a class="code" href="exceptions_8c.html#a366e9b618421f1f94a3318e81cc0489c">throw_error</a> (<a class="code" href="exceptions_8h.html#acc42076253600be964e110149b458971ac3542c27e951e540045797b560266872">TLS_GENERIC_ERROR</a>,
<a name="l01849"></a>01849                  <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;TLS not supported on this target&quot;</span>));
<a name="l01850"></a>01850 }
<a name="l01851"></a>01851 
<a name="l01852"></a>01852 <span class="comment">/* Callback routine used to find a thread based on the TID part of</span>
<a name="l01853"></a>01853 <span class="comment">   its PTID.  */</span>
<a name="l01854"></a>01854 
<a name="l01855"></a>01855 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01856"></a><a class="code" href="linux-thread-db_8c.html#a907556bbfa0a5a068c88ae4efc405315">01856</a> <a class="code" href="linux-thread-db_8c.html#a907556bbfa0a5a068c88ae4efc405315">thread_db_find_thread_from_tid</a> (<span class="keyword">struct</span> <a class="code" href="structthread__info.html">thread_info</a> *thread, <span class="keywordtype">void</span> *data)
<a name="l01857"></a>01857 {
<a name="l01858"></a>01858   <span class="keywordtype">long</span> *tid = (<span class="keywordtype">long</span> *) data;
<a name="l01859"></a>01859 
<a name="l01860"></a>01860   <span class="keywordflow">if</span> (thread-&gt;<a class="code" href="structthread__info.html#ae0a5a49922e34ab1579136471cba8dcf">private</a>-&gt;<a class="code" href="structprivate__thread__info.html#a787a560a65133d93f60bba161faff68e">tid</a> == *tid)
<a name="l01861"></a>01861     <span class="keywordflow">return</span> 1;
<a name="l01862"></a>01862 
<a name="l01863"></a>01863   <span class="keywordflow">return</span> 0;
<a name="l01864"></a>01864 }
<a name="l01865"></a>01865 
<a name="l01866"></a>01866 <span class="comment">/* Implement the to_get_ada_task_ptid target method for this target.  */</span>
<a name="l01867"></a>01867 
<a name="l01868"></a>01868 <span class="keyword">static</span> <a class="code" href="structptid.html">ptid_t</a>
<a name="l01869"></a><a class="code" href="linux-thread-db_8c.html#ae0d810a39e14aac454258ba120e78917">01869</a> <a class="code" href="linux-thread-db_8c.html#ae0d810a39e14aac454258ba120e78917">thread_db_get_ada_task_ptid</a> (<span class="keywordtype">long</span> lwp, <span class="keywordtype">long</span> thread)
<a name="l01870"></a>01870 {
<a name="l01871"></a>01871   <span class="keyword">struct </span><a class="code" href="structthread__info.html">thread_info</a> *<a class="code" href="windows-nat_8c.html#afcec92a2687d34570e53b62dfd9a7dbe">thread_info</a>;
<a name="l01872"></a>01872 
<a name="l01873"></a>01873   <a class="code" href="linux-thread-db_8c.html#a8748de14af79f07c6a5737302e476e1f">thread_db_find_new_threads_1</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>);
<a name="l01874"></a>01874   thread_info = <a class="code" href="gdbthread_8h.html#a5dc20fee3cc8a79f615f2f5d695ae1bc">iterate_over_threads</a> (<a class="code" href="linux-thread-db_8c.html#a907556bbfa0a5a068c88ae4efc405315">thread_db_find_thread_from_tid</a>, &amp;thread);
<a name="l01875"></a>01875 
<a name="l01876"></a>01876   <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (thread_info != NULL);
<a name="l01877"></a>01877 
<a name="l01878"></a>01878   <span class="keywordflow">return</span> (thread_info-&gt;<a class="code" href="structthread__info.html#a533aa3979b60affd446e9fbff93fdd2c">ptid</a>);
<a name="l01879"></a>01879 }
<a name="l01880"></a>01880 
<a name="l01881"></a>01881 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01882"></a><a class="code" href="linux-thread-db_8c.html#ad2bef2cfcdeadbf61977c4c77ededa00">01882</a> <a class="code" href="linux-thread-db_8c.html#ad2bef2cfcdeadbf61977c4c77ededa00">thread_db_resume</a> (<span class="keyword">struct</span> <a class="code" href="structtarget__ops.html">target_ops</a> *ops,
<a name="l01883"></a>01883                   <a class="code" href="structptid.html">ptid_t</a> <a class="code" href="structptid.html">ptid</a>, <span class="keywordtype">int</span> step, <span class="keyword">enum</span> gdb_signal signo)
<a name="l01884"></a>01884 {
<a name="l01885"></a>01885   <span class="keyword">struct </span><a class="code" href="structtarget__ops.html">target_ops</a> *<a class="code" href="structtarget__ops.html#a1b180ccb4db2afccf46e691862bf2ddf">beneath</a> = <a class="code" href="target_8c.html#afa1a2fb00f3ea15f9394f5b8afe14818">find_target_beneath</a> (ops);
<a name="l01886"></a>01886   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info;
<a name="l01887"></a>01887 
<a name="l01888"></a>01888   <span class="keywordflow">if</span> (<a class="code" href="ptid_8c.html#a0df58c8db2620a2cec647934b4f77266">ptid_equal</a> (ptid, <a class="code" href="ptid_8c.html#ae865e32ccc6c9636dcec8ff779f99514">minus_one_ptid</a>))
<a name="l01889"></a>01889     info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (<a class="code" href="infcmd_8c.html#a428c5be9ce5e70bd03760e828e19c6b7">inferior_ptid</a>));
<a name="l01890"></a>01890   <span class="keywordflow">else</span>
<a name="l01891"></a>01891     info = <a class="code" href="linux-thread-db_8c.html#ac72558dda5f76860ee8852bedeec865d">get_thread_db_info</a> (<a class="code" href="ptid_8c.html#a264ba40fc2a0cf3d4fb24a55fe32aede">ptid_get_pid</a> (ptid));
<a name="l01892"></a>01892 
<a name="l01893"></a>01893   <span class="comment">/* This workaround is only needed for child fork lwps stopped in a</span>
<a name="l01894"></a>01894 <span class="comment">     PTRACE_O_TRACEFORK event.  When the inferior is resumed, the</span>
<a name="l01895"></a>01895 <span class="comment">     workaround can be disabled.  */</span>
<a name="l01896"></a>01896   <span class="keywordflow">if</span> (info)
<a name="l01897"></a>01897     info-&gt;<a class="code" href="structthread__db__info.html#ababfe4c4610a15619f1837848d22df07">need_stale_parent_threads_check</a> = 0;
<a name="l01898"></a>01898 
<a name="l01899"></a>01899   beneath-&gt;<a class="code" href="structtarget__ops.html#a969e77ba44f2d253e041d3b24dde8c87">to_resume</a> (beneath, ptid, step, signo);
<a name="l01900"></a>01900 }
<a name="l01901"></a>01901 
<a name="l01902"></a>01902 <span class="comment">/* qsort helper function for info_auto_load_libthread_db, sort the</span>
<a name="l01903"></a>01903 <span class="comment">   thread_db_info pointers primarily by their FILENAME and secondarily by their</span>
<a name="l01904"></a>01904 <span class="comment">   PID, both in ascending order.  */</span>
<a name="l01905"></a>01905 
<a name="l01906"></a>01906 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01907"></a><a class="code" href="linux-thread-db_8c.html#a7455aec53df6e83e021c552136c23391">01907</a> <a class="code" href="linux-thread-db_8c.html#a7455aec53df6e83e021c552136c23391">info_auto_load_libthread_db_compare</a> (<span class="keyword">const</span> <span class="keywordtype">void</span> *ap, <span class="keyword">const</span> <span class="keywordtype">void</span> *bp)
<a name="l01908"></a>01908 {
<a name="l01909"></a>01909   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *a = *(<span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> **) ap;
<a name="l01910"></a>01910   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *b = *(<span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> **) bp;
<a name="l01911"></a>01911   <span class="keywordtype">int</span> retval;
<a name="l01912"></a>01912 
<a name="l01913"></a>01913   retval = strcmp (a-&gt;<a class="code" href="structthread__db__info.html#a4b3b75faab6aa86dc5a525ae3c913d53">filename</a>, b-&gt;<a class="code" href="structthread__db__info.html#a4b3b75faab6aa86dc5a525ae3c913d53">filename</a>);
<a name="l01914"></a>01914   <span class="keywordflow">if</span> (retval)
<a name="l01915"></a>01915     <span class="keywordflow">return</span> retval;
<a name="l01916"></a>01916 
<a name="l01917"></a>01917   <span class="keywordflow">return</span> (a-&gt;<a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a> &gt; b-&gt;<a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a>) - (a-&gt;<a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a> - b-&gt;<a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a>);
<a name="l01918"></a>01918 }
<a name="l01919"></a>01919 
<a name="l01920"></a>01920 <span class="comment">/* Implement &#39;info auto-load libthread-db&#39;.  */</span>
<a name="l01921"></a>01921 
<a name="l01922"></a>01922 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01923"></a><a class="code" href="linux-thread-db_8c.html#af1740294881f567f86417444afeff3c6">01923</a> <a class="code" href="linux-thread-db_8c.html#af1740294881f567f86417444afeff3c6">info_auto_load_libthread_db</a> (<span class="keywordtype">char</span> *args, <span class="keywordtype">int</span> from_tty)
<a name="l01924"></a>01924 {
<a name="l01925"></a>01925   <span class="keyword">struct </span><a class="code" href="structui__out.html">ui_out</a> *uiout = <a class="code" href="ui-out_8c.html#a3d9e2a5710f076cc035ef73920eb8c87">current_uiout</a>;
<a name="l01926"></a>01926   <span class="keyword">const</span> <span class="keywordtype">char</span> *cs = args ? args : <span class="stringliteral">&quot;&quot;</span>;
<a name="l01927"></a>01927   <span class="keyword">struct </span><a class="code" href="structthread__db__info.html">thread_db_info</a> *info, **array;
<a name="l01928"></a>01928   <span class="keywordtype">unsigned</span> info_count, unique_filenames;
<a name="l01929"></a>01929   <span class="keywordtype">size_t</span> max_filename_len, max_pids_len, pids_len;
<a name="l01930"></a>01930   <span class="keyword">struct </span><a class="code" href="structcleanup.html">cleanup</a> *back_to;
<a name="l01931"></a>01931   <span class="keywordtype">char</span> *pids;
<a name="l01932"></a>01932   <span class="keywordtype">int</span> i;
<a name="l01933"></a>01933 
<a name="l01934"></a>01934   cs = <a class="code" href="cli-utils_8c.html#aad7df612354d99c740a7ea12eccd3848">skip_spaces_const</a> (cs);
<a name="l01935"></a>01935   <span class="keywordflow">if</span> (*cs)
<a name="l01936"></a>01936     <a class="code" href="utils_8c.html#a279e952362d12544d9bebc26660fec4b">error</a> (<a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;&#39;info auto-load libthread-db&#39; does not accept any parameters&quot;</span>));
<a name="l01937"></a>01937 
<a name="l01938"></a>01938   info_count = 0;
<a name="l01939"></a>01939   <span class="keywordflow">for</span> (info = thread_db_list; info; info = info-&gt;<a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">next</a>)
<a name="l01940"></a>01940     <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#a4b3b75faab6aa86dc5a525ae3c913d53">filename</a> != NULL)
<a name="l01941"></a>01941       info_count++;
<a name="l01942"></a>01942 
<a name="l01943"></a>01943   array = <a class="code" href="common-utils_8c.html#a634d6cd850bb831afebc499579303b3b">xmalloc</a> (<span class="keyword">sizeof</span> (*array) * info_count);
<a name="l01944"></a>01944   back_to = <a class="code" href="cleanups_8c.html#a3d418f8af424aec399898c2d48b26224">make_cleanup</a> (<a class="code" href="common-utils_8c.html#a976e14808b9247ec952c262553f09f8f">xfree</a>, array);
<a name="l01945"></a>01945 
<a name="l01946"></a>01946   info_count = 0;
<a name="l01947"></a>01947   <span class="keywordflow">for</span> (info = thread_db_list; info; info = info-&gt;<a class="code" href="structthread__db__info.html#ad09ac18d3f1c8aef3b07c67fec2f778f">next</a>)
<a name="l01948"></a>01948     <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structthread__db__info.html#a4b3b75faab6aa86dc5a525ae3c913d53">filename</a> != NULL)
<a name="l01949"></a>01949       array[info_count++] = info;
<a name="l01950"></a>01950 
<a name="l01951"></a>01951   <span class="comment">/* Sort ARRAY by filenames and PIDs.  */</span>
<a name="l01952"></a>01952 
<a name="l01953"></a>01953   <a class="code" href="ada-exp_8c.html#a849e2297facde4d3c80dc4f45f8abbdb">qsort</a> (array, info_count, <span class="keyword">sizeof</span> (*array),
<a name="l01954"></a>01954          <a class="code" href="linux-thread-db_8c.html#a7455aec53df6e83e021c552136c23391">info_auto_load_libthread_db_compare</a>);
<a name="l01955"></a>01955 
<a name="l01956"></a>01956   <span class="comment">/* Calculate the number of unique filenames (rows) and the maximum string</span>
<a name="l01957"></a>01957 <span class="comment">     length of PIDs list for the unique filenames (columns).  */</span>
<a name="l01958"></a>01958 
<a name="l01959"></a>01959   unique_filenames = 0;
<a name="l01960"></a>01960   max_filename_len = 0;
<a name="l01961"></a>01961   max_pids_len = 0;
<a name="l01962"></a>01962   pids_len = 0;
<a name="l01963"></a>01963   <span class="keywordflow">for</span> (i = 0; i &lt; info_count; i++)
<a name="l01964"></a>01964     {
<a name="l01965"></a>01965       <span class="keywordtype">int</span> pid = array[i]-&gt;<a class="code" href="structthread__db__info.html#a2ba31a005cf1dcb6283eee622806b15a">pid</a>;
<a name="l01966"></a>01966       <span class="keywordtype">size_t</span> this_pid_len;
<a name="l01967"></a>01967 
<a name="l01968"></a>01968       <span class="keywordflow">for</span> (this_pid_len = 0; pid != 0; pid /= 10)
<a name="l01969"></a>01969         this_pid_len++;
<a name="l01970"></a>01970 
<a name="l01971"></a>01971       <span class="keywordflow">if</span> (i == 0 || strcmp (array[i - 1]-&gt;filename, array[i]-&gt;filename) != 0)
<a name="l01972"></a>01972         {
<a name="l01973"></a>01973           unique_filenames++;
<a name="l01974"></a>01974           max_filename_len = <a class="code" href="environ_8c.html#affe776513b24d84b39af8ab0930fef7f">max</a> (max_filename_len,
<a name="l01975"></a>01975                                   strlen (array[i]-&gt;filename));
<a name="l01976"></a>01976 
<a name="l01977"></a>01977           <span class="keywordflow">if</span> (i &gt; 0)
<a name="l01978"></a>01978             {
<a name="l01979"></a>01979               pids_len -= strlen (<span class="stringliteral">&quot;, &quot;</span>);
<a name="l01980"></a>01980               max_pids_len = <a class="code" href="environ_8c.html#affe776513b24d84b39af8ab0930fef7f">max</a> (max_pids_len, pids_len);
<a name="l01981"></a>01981             }
<a name="l01982"></a>01982           pids_len = 0;
<a name="l01983"></a>01983         }
<a name="l01984"></a>01984       pids_len += this_pid_len + strlen (<span class="stringliteral">&quot;, &quot;</span>);
<a name="l01985"></a>01985     }
<a name="l01986"></a>01986   <span class="keywordflow">if</span> (i)
<a name="l01987"></a>01987     {
<a name="l01988"></a>01988       pids_len -= strlen (<span class="stringliteral">&quot;, &quot;</span>);
<a name="l01989"></a>01989       max_pids_len = <a class="code" href="environ_8c.html#affe776513b24d84b39af8ab0930fef7f">max</a> (max_pids_len, pids_len);
<a name="l01990"></a>01990     }
<a name="l01991"></a>01991 
<a name="l01992"></a>01992   <span class="comment">/* Table header shifted right by preceding &quot;libthread-db:  &quot; would not match</span>
<a name="l01993"></a>01993 <span class="comment">     its columns.  */</span>
<a name="l01994"></a>01994   <span class="keywordflow">if</span> (info_count &gt; 0 &amp;&amp; args == <a class="code" href="auto-load_8c.html#a78c0aec468b819ceb5d8e8a9d8de602f">auto_load_info_scripts_pattern_nl</a>)
<a name="l01995"></a>01995     <a class="code" href="ui-out_8c.html#a6a23596295dce32ba2a5bd2fd2d309f8">ui_out_text</a> (uiout, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01996"></a>01996 
<a name="l01997"></a>01997   <a class="code" href="ui-out_8c.html#a9675e3968a06325a214ffe2fbb10bdc8">make_cleanup_ui_out_table_begin_end</a> (uiout, 2, unique_filenames,
<a name="l01998"></a>01998                                        <span class="stringliteral">&quot;LinuxThreadDbTable&quot;</span>);
<a name="l01999"></a>01999 
<a name="l02000"></a>02000   <a class="code" href="ui-out_8c.html#a6a85ff75fa4ac345725a2fd58498173f">ui_out_table_header</a> (uiout, max_filename_len, <a class="code" href="ui-out_8h.html#ac5d0187f97768dc203458ddf644e0c7aac8a02f1b44706ba412f42aa3fc249695">ui_left</a>, <span class="stringliteral">&quot;filename&quot;</span>,
<a name="l02001"></a>02001                        <span class="stringliteral">&quot;Filename&quot;</span>);
<a name="l02002"></a>02002   <a class="code" href="ui-out_8c.html#a6a85ff75fa4ac345725a2fd58498173f">ui_out_table_header</a> (uiout, pids_len, <a class="code" href="ui-out_8h.html#ac5d0187f97768dc203458ddf644e0c7aac8a02f1b44706ba412f42aa3fc249695">ui_left</a>, <span class="stringliteral">&quot;PIDs&quot;</span>, <span class="stringliteral">&quot;Pids&quot;</span>);
<a name="l02003"></a>02003   <a class="code" href="ui-out_8c.html#a07042144a117bc974f5c41761b68975e">ui_out_table_body</a> (uiout);
<a name="l02004"></a>02004 
<a name="l02005"></a>02005   pids = <a class="code" href="common-utils_8c.html#a634d6cd850bb831afebc499579303b3b">xmalloc</a> (max_pids_len + 1);
<a name="l02006"></a>02006   <a class="code" href="cleanups_8c.html#a3d418f8af424aec399898c2d48b26224">make_cleanup</a> (<a class="code" href="common-utils_8c.html#a976e14808b9247ec952c262553f09f8f">xfree</a>, pids);
<a name="l02007"></a>02007 
<a name="l02008"></a>02008   <span class="comment">/* Note I is incremented inside the cycle, not at its end.  */</span>
<a name="l02009"></a>02009   <span class="keywordflow">for</span> (i = 0; i &lt; info_count;)
<a name="l02010"></a>02010     {
<a name="l02011"></a>02011       <span class="keyword">struct </span><a class="code" href="structcleanup.html">cleanup</a> *chain = <a class="code" href="ui-out_8c.html#aaf5a0c991d74ad2e486f420d5c2ff058">make_cleanup_ui_out_tuple_begin_end</a> (uiout, NULL);
<a name="l02012"></a>02012       <span class="keywordtype">char</span> *pids_end;
<a name="l02013"></a>02013 
<a name="l02014"></a>02014       info = array[i];
<a name="l02015"></a>02015       <a class="code" href="ui-out_8c.html#a58efe771979c53ca23a30573d06dc291">ui_out_field_string</a> (uiout, <span class="stringliteral">&quot;filename&quot;</span>, info-&gt;<a class="code" href="structthread__db__info.html#a4b3b75faab6aa86dc5a525ae3c913d53">filename</a>);
<a name="l02016"></a>02016       pids_end = pids;
<a name="l02017"></a>02017 
<a name="l02018"></a>02018       <span class="keywordflow">while</span> (i &lt; info_count &amp;&amp; strcmp (info-&gt;<a class="code" href="structthread__db__info.html#a4b3b75faab6aa86dc5a525ae3c913d53">filename</a>, array[i]-&gt;<a class="code" href="structthread__db__info.html#a4b3b75faab6aa86dc5a525ae3c913d53">filename</a>) == 0)
<a name="l02019"></a>02019         {
<a name="l02020"></a>02020           <span class="keywordflow">if</span> (pids_end != pids)
<a name="l02021"></a>02021             {
<a name="l02022"></a>02022               *pids_end++ = <span class="charliteral">&#39;,&#39;</span>;
<a name="l02023"></a>02023               *pids_end++ = <span class="charliteral">&#39; &#39;</span>;
<a name="l02024"></a>02024             }
<a name="l02025"></a>02025           pids_end += <a class="code" href="common-utils_8c.html#ad9940337ec98983dae9951c947879fc8">xsnprintf</a> (pids_end, &amp;pids[max_pids_len + 1] - pids_end,
<a name="l02026"></a>02026                                  <span class="stringliteral">&quot;%u&quot;</span>, array[i]-&gt;pid);
<a name="l02027"></a>02027           <a class="code" href="gdb__assert_8h.html#aeb007d3e990858c7ef8e40a7e512c1ff">gdb_assert</a> (pids_end &lt; &amp;pids[max_pids_len + 1]);
<a name="l02028"></a>02028 
<a name="l02029"></a>02029           i++;
<a name="l02030"></a>02030         }
<a name="l02031"></a>02031       *pids_end = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l02032"></a>02032 
<a name="l02033"></a>02033       <a class="code" href="ui-out_8c.html#a58efe771979c53ca23a30573d06dc291">ui_out_field_string</a> (uiout, <span class="stringliteral">&quot;pids&quot;</span>, pids);
<a name="l02034"></a>02034 
<a name="l02035"></a>02035       <a class="code" href="ui-out_8c.html#a6a23596295dce32ba2a5bd2fd2d309f8">ui_out_text</a> (uiout, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02036"></a>02036       <a class="code" href="cleanups_8c.html#a8b313a4f1c613973ea444e5fa54976f8">do_cleanups</a> (chain);
<a name="l02037"></a>02037     }
<a name="l02038"></a>02038 
<a name="l02039"></a>02039   <a class="code" href="cleanups_8c.html#a8b313a4f1c613973ea444e5fa54976f8">do_cleanups</a> (back_to);
<a name="l02040"></a>02040 
<a name="l02041"></a>02041   <span class="keywordflow">if</span> (info_count == 0)
<a name="l02042"></a>02042     <a class="code" href="ui-out_8c.html#a65967c27cd058d2739afdbc5a51f377e">ui_out_message</a> (uiout, 0, <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;No auto-loaded libthread-db.\n&quot;</span>));
<a name="l02043"></a>02043 }
<a name="l02044"></a>02044 
<a name="l02045"></a>02045 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02046"></a><a class="code" href="linux-thread-db_8c.html#ab52c056ef8dd5fa7294d60980c175d21">02046</a> <a class="code" href="linux-thread-db_8c.html#ab52c056ef8dd5fa7294d60980c175d21">init_thread_db_ops</a> (<span class="keywordtype">void</span>)
<a name="l02047"></a>02047 {
<a name="l02048"></a>02048   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a9326c3129ee116786b1ca1a95713f125">to_shortname</a> = <span class="stringliteral">&quot;multi-thread&quot;</span>;
<a name="l02049"></a>02049   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a184ee9aa071d32ec535cf7394aba0bd1">to_longname</a> = <span class="stringliteral">&quot;multi-threaded child process.&quot;</span>;
<a name="l02050"></a>02050   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a1b0c848329708688e3816263b16fe664">to_doc</a> = <span class="stringliteral">&quot;Threads and pthreads support.&quot;</span>;
<a name="l02051"></a>02051   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a2749c09156c21e635d6860af415b7a52">to_detach</a> = <a class="code" href="linux-thread-db_8c.html#aca0eb72640b7e79f50e147956291c1a9">thread_db_detach</a>;
<a name="l02052"></a>02052   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#ae8e22dbcc8522f0daac3fc8ed2661ca1">to_wait</a> = <a class="code" href="linux-thread-db_8c.html#a16c335dd7b4d3ce8f3b7e2c4bf7ee83d">thread_db_wait</a>;
<a name="l02053"></a>02053   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a969e77ba44f2d253e041d3b24dde8c87">to_resume</a> = <a class="code" href="linux-thread-db_8c.html#ad2bef2cfcdeadbf61977c4c77ededa00">thread_db_resume</a>;
<a name="l02054"></a>02054   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#aa636723dd143fcd0c3c78af97f7358a5">to_mourn_inferior</a> = <a class="code" href="linux-thread-db_8c.html#a6200617444dd024e6dc1de96477dee70">thread_db_mourn_inferior</a>;
<a name="l02055"></a>02055   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a6af5d37da6d3dd1ef3b2beb4cd9fdd81">to_find_new_threads</a> = <a class="code" href="linux-thread-db_8c.html#a28939201a59fc3d18ca47a4ef5b16013">thread_db_find_new_threads</a>;
<a name="l02056"></a>02056   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a5259fe0b12fd9dd4e269ed44fee00603">to_pid_to_str</a> = <a class="code" href="linux-thread-db_8c.html#ad571bebebe7d6a200d5cf8b7a3b3a900">thread_db_pid_to_str</a>;
<a name="l02057"></a>02057   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#aaf1f75f86ec2b948e5df3548198aae4b">to_stratum</a> = <a class="code" href="target_8h.html#abf9ea8b4aa7bddf6a8aa3882d0dadd00acb67d325de9eee5f1a42ffc81d9efedf">thread_stratum</a>;
<a name="l02058"></a>02058   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#ab9754d27b0891e21710e712ce572b2f5">to_has_thread_control</a> = <a class="code" href="target_8h.html#ac23f2139b89f6319b6afa125b437bf79a1b420215532dd7eb22a269c35e569d58">tc_schedlock</a>;
<a name="l02059"></a>02059   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a076aa3a1e1e1d6bb90656222d790b243">to_get_thread_local_address</a>
<a name="l02060"></a>02060     = <a class="code" href="linux-thread-db_8c.html#a6267e3c7d2a7203adbd0e0a728397dfa">thread_db_get_thread_local_address</a>;
<a name="l02061"></a>02061   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a601c298daee0b6af36e202490680ccf6">to_extra_thread_info</a> = <a class="code" href="linux-thread-db_8c.html#a1d8cfd1c88bc0ab4e55dafb802021f92">thread_db_extra_thread_info</a>;
<a name="l02062"></a>02062   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a1d246b305b808ee45e23eba2afcd796a">to_get_ada_task_ptid</a> = <a class="code" href="linux-thread-db_8c.html#ae0d810a39e14aac454258ba120e78917">thread_db_get_ada_task_ptid</a>;
<a name="l02063"></a>02063   <a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>.<a class="code" href="structtarget__ops.html#a97a3b404ed5a64b8f6229fdaf43d30fb">to_magic</a> = <a class="code" href="target_8h.html#a52de2938b46ac35e4a8c50fead44fd4d">OPS_MAGIC</a>;
<a name="l02064"></a>02064 
<a name="l02065"></a>02065   <a class="code" href="target_8c.html#a1cdc1b41e34c193ca58094f37746bb65">complete_target_initialization</a> (&amp;<a class="code" href="linux-thread-db_8c.html#a48f637de07d680380c684b7da784a404">thread_db_ops</a>);
<a name="l02066"></a>02066 }
<a name="l02067"></a>02067 
<a name="l02068"></a>02068 <span class="comment">/* Provide a prototype to silence -Wmissing-prototypes.  */</span>
<a name="l02069"></a>02069 <span class="keyword">extern</span> <a class="code" href="defs_8h.html#a686ed07d4fdcdc366f2bc677216ca08d">initialize_file_ftype</a> <a class="code" href="linux-thread-db_8c.html#aa1066e58325cc742a5c0f1d368da4434">_initialize_thread_db</a>;
<a name="l02070"></a>02070 
<a name="l02071"></a>02071 <span class="keywordtype">void</span>
<a name="l02072"></a><a class="code" href="linux-thread-db_8c.html#a98477c70b5f3e7cbe44bd813ca8fabc5">02072</a> <a class="code" href="linux-thread-db_8c.html#aa1066e58325cc742a5c0f1d368da4434">_initialize_thread_db</a> (<span class="keywordtype">void</span>)
<a name="l02073"></a>02073 {
<a name="l02074"></a>02074   <a class="code" href="linux-thread-db_8c.html#ab52c056ef8dd5fa7294d60980c175d21">init_thread_db_ops</a> ();
<a name="l02075"></a>02075 
<a name="l02076"></a>02076   <span class="comment">/* Defer loading of libthread_db.so until inferior is running.</span>
<a name="l02077"></a>02077 <span class="comment">     This allows gdb to load correct libthread_db for a given</span>
<a name="l02078"></a>02078 <span class="comment">     executable -- there could be mutiple versions of glibc,</span>
<a name="l02079"></a>02079 <span class="comment">     compiled with LinuxThreads or NPTL, and until there is</span>
<a name="l02080"></a>02080 <span class="comment">     a running inferior, we can&#39;t tell which libthread_db is</span>
<a name="l02081"></a>02081 <span class="comment">     the correct one to load.  */</span>
<a name="l02082"></a>02082 
<a name="l02083"></a>02083   <a class="code" href="linux-thread-db_8c.html#a2054e81dcf1628d1199ed276e291b4cb">libthread_db_search_path</a> = xstrdup (<a class="code" href="gdb__thread__db_8h.html#a2f881f10c445a50c74e970b45055f899">LIBTHREAD_DB_SEARCH_PATH</a>);
<a name="l02084"></a>02084 
<a name="l02085"></a>02085   <a class="code" href="cli-decode_8c.html#a47cdf41908a640a5cc5cbd4a00491595">add_setshow_optional_filename_cmd</a> (<span class="stringliteral">&quot;libthread-db-search-path&quot;</span>,
<a name="l02086"></a>02086                                      <a class="code" href="command_8h.html#ad71b5a938f3966cf81293bca79acef49a92be6efbab6bd9647a6f7a2862712d9b">class_support</a>,
<a name="l02087"></a>02087                                      &amp;<a class="code" href="linux-thread-db_8c.html#a2054e81dcf1628d1199ed276e291b4cb">libthread_db_search_path</a>, <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;\</span>
<a name="l02088"></a>02088 <span class="stringliteral">Set search path for libthread_db.&quot;</span>), <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;\</span>
<a name="l02089"></a>02089 <span class="stringliteral">Show the current search path or libthread_db.&quot;</span>), <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;\</span>
<a name="l02090"></a>02090 <span class="stringliteral">This path is used to search for libthread_db to be loaded into \</span>
<a name="l02091"></a>02091 <span class="stringliteral">gdb itself.\n\</span>
<a name="l02092"></a>02092 <span class="stringliteral">Its value is a colon (&#39;:&#39;) separate list of directories to search.\n\</span>
<a name="l02093"></a>02093 <span class="stringliteral">Setting the search path to an empty list resets it to its default value.&quot;</span>),
<a name="l02094"></a>02094                             <a class="code" href="linux-thread-db_8c.html#af6c494da587c736414abc7819366659e">set_libthread_db_search_path</a>,
<a name="l02095"></a>02095                             NULL,
<a name="l02096"></a>02096                             &amp;<a class="code" href="cli-cmds_8c.html#a723e0174d833cba0aa82fb936a56c8fa">setlist</a>, &amp;<a class="code" href="cli-cmds_8c.html#a003932aa76fd3f41763ecc6bee5e2ca8">showlist</a>);
<a name="l02097"></a>02097 
<a name="l02098"></a>02098   <a class="code" href="cli-decode_8c.html#ae32b914a6e0676efa41e6281007a75c1">add_setshow_zuinteger_cmd</a> (<span class="stringliteral">&quot;libthread-db&quot;</span>, <a class="code" href="command_8h.html#ad71b5a938f3966cf81293bca79acef49a502c7b57c7172ac88ef735f68070bb59">class_maintenance</a>,
<a name="l02099"></a>02099                              &amp;<a class="code" href="linux-thread-db_8c.html#a0557c7e8da0380c24eaedfd3449ee80f">libthread_db_debug</a>, <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;\</span>
<a name="l02100"></a>02100 <span class="stringliteral">Set libthread-db debugging.&quot;</span>), <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;\</span>
<a name="l02101"></a>02101 <span class="stringliteral">Show libthread-db debugging.&quot;</span>), <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;\</span>
<a name="l02102"></a>02102 <span class="stringliteral">When non-zero, libthread-db debugging is enabled.&quot;</span>),
<a name="l02103"></a>02103                              NULL,
<a name="l02104"></a>02104                              <a class="code" href="linux-thread-db_8c.html#a650f2a8a5e8053bd5c943954a1b4a67c">show_libthread_db_debug</a>,
<a name="l02105"></a>02105                              &amp;<a class="code" href="cli-cmds_8c.html#ae5f16c782e4a29124f3175f4a6285244">setdebuglist</a>, &amp;<a class="code" href="cli-cmds_8c.html#a7e2eed475764f70df1e9c0f5d2476a11">showdebuglist</a>);
<a name="l02106"></a>02106 
<a name="l02107"></a>02107   <a class="code" href="cli-decode_8c.html#ad86a0f135b6c546ae7ffbb41fd72e14f">add_setshow_boolean_cmd</a> (<span class="stringliteral">&quot;libthread-db&quot;</span>, <a class="code" href="command_8h.html#ad71b5a938f3966cf81293bca79acef49a92be6efbab6bd9647a6f7a2862712d9b">class_support</a>,
<a name="l02108"></a>02108                            &amp;<a class="code" href="linux-thread-db_8c.html#a01cc116c4ab0d79fcc2f0900819c4319">auto_load_thread_db</a>, <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;\</span>
<a name="l02109"></a>02109 <span class="stringliteral">Enable or disable auto-loading of inferior specific libthread_db.&quot;</span>), <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;\</span>
<a name="l02110"></a>02110 <span class="stringliteral">Show whether auto-loading inferior specific libthread_db is enabled.&quot;</span>), <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;\</span>
<a name="l02111"></a>02111 <span class="stringliteral">If enabled, libthread_db will be searched in &#39;set libthread-db-search-path&#39;\n\</span>
<a name="l02112"></a>02112 <span class="stringliteral">locations to load libthread_db compatible with the inferior.\n\</span>
<a name="l02113"></a>02113 <span class="stringliteral">Standard system libthread_db still gets loaded even with this option off.\n\</span>
<a name="l02114"></a>02114 <span class="stringliteral">This options has security implications for untrusted inferiors.&quot;</span>),
<a name="l02115"></a>02115                            NULL, <a class="code" href="linux-thread-db_8c.html#af982309d62395df16c7484b1ac399590">show_auto_load_thread_db</a>,
<a name="l02116"></a>02116                            <a class="code" href="auto-load_8c.html#a58b19fe00b06123a35c63b14a51adb7e">auto_load_set_cmdlist_get</a> (),
<a name="l02117"></a>02117                            <a class="code" href="auto-load_8c.html#a9ab09b305901ecfb326dab50d40e0f63">auto_load_show_cmdlist_get</a> ());
<a name="l02118"></a>02118 
<a name="l02119"></a>02119   <a class="code" href="cli-decode_8c.html#ab87b0ba51ed9aa4c8aac0c96373537f8">add_cmd</a> (<span class="stringliteral">&quot;libthread-db&quot;</span>, <a class="code" href="command_8h.html#ad71b5a938f3966cf81293bca79acef49afeb5c4e1710a4f7dfc804136248d274d">class_info</a>, <a class="code" href="linux-thread-db_8c.html#af1740294881f567f86417444afeff3c6">info_auto_load_libthread_db</a>,
<a name="l02120"></a>02120            <a class="code" href="gdb__locale_8h.html#a32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">&quot;Print the list of loaded inferior specific libthread_db.\n\</span>
<a name="l02121"></a>02121 <span class="stringliteral">Usage: info auto-load libthread-db&quot;</span>),
<a name="l02122"></a>02122            <a class="code" href="auto-load_8c.html#ab3554a9ce869b66e97fb4ee6e322146d">auto_load_info_cmdlist_get</a> ());
<a name="l02123"></a>02123 
<a name="l02124"></a>02124   <span class="comment">/* Add ourselves to objfile event chain.  */</span>
<a name="l02125"></a>02125   <a class="code" href="observer_8h.html#a688df6ed7b6f01418f3498e7c376e360">observer_attach_new_objfile</a> (<a class="code" href="linux-thread-db_8c.html#a0eb3ce0efe42eeb8c3036557078b4067">thread_db_new_objfile</a>);
<a name="l02126"></a>02126 
<a name="l02127"></a>02127   <span class="comment">/* Add ourselves to inferior_created event chain.</span>
<a name="l02128"></a>02128 <span class="comment">     This is needed to handle debugging statically linked programs where</span>
<a name="l02129"></a>02129 <span class="comment">     the new_objfile observer won&#39;t get called for libpthread.  */</span>
<a name="l02130"></a>02130   <a class="code" href="observer_8h.html#af49321328b079457d8950fb05de0b2b6">observer_attach_inferior_created</a> (<a class="code" href="linux-thread-db_8c.html#ae4936e2ac95d8fcaaef8ad1766fea589">thread_db_inferior_created</a>);
<a name="l02131"></a>02131 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Fri Oct 11 2013 14:13:29 for GDB (xrefs) by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
